<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide_IDE(v1.11.037)</title>

    <meta http-equiv="Content-Security-Policy" content="
		default-src 'self' https://script.google.com;
		script-src 'self' https://script.google.com 'unsafe-inline' 'wasm-unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
		font-src 'self' https://cdnjs.cloudflare.com;
		connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://pypi.org https://files.pythonhosted.org;
		frame-src 'self' blob: data:;
		img-src 'self' data: blob:;
		worker-src 'self' blob:;
    ">

    <style id="root_style">
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #1e1e1e;
            color: #ccc;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        iframe {
            width: 100%;
            flex: 1;
            border: none;
            display: block;
        }

        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: sans-serif;
            text-align: center;
        }
    </style>

    <style id="header_style">
        header {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: #333;
            /* èƒŒæ™¯è‰²: ã‚„ã‚„æš—ã„ã‚°ãƒ¬ãƒ¼ */
            padding: 4px 5px;
            /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šä¸‹4px, å·¦å³5px) */
            display: flex;
            /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
            justify-content: space-between;
            /* å­è¦ç´  (ãƒœã‚¿ãƒ³ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹) ã‚’ä¸¡ç«¯ã«é…ç½® */
            align-items: center;
            /* å­è¦ç´ ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ */
            flex-shrink: 0;
            /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆé«˜ã•å›ºå®šï¼‰ */
            position: relative;
            /* z-indexã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ã«å¿…è¦ */
            z-index: 10000;
            /* Zè»¸ã®æ·±ã•: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (9999) ã‚ˆã‚Šå‰é¢ã«è¡¨ç¤º */
        }

        .other_button_css,
        .run_button_css,
        .stop_button_css {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
            width: 35px;
            /* å¹…: 35px */
            height: 25px;
            /* é«˜ã•: 25px */
            border-radius: 5%;
            /* è§’ä¸¸: 5% */
            font-size: 10pt;
            /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 10pt */
            text-align: center;
            /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
            cursor: pointer;
            /* ã‚«ãƒ¼ã‚½ãƒ«: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
            margin-right: 3px;
            /* å³ãƒãƒ¼ã‚¸ãƒ³: 3px */
            line-height: 1em;
            /* è¡Œã®é«˜ã•: è¦ªè¦ç´ ã¨åŒã˜ */
            opacity: 0.9;
            /* ä¸é€æ˜åº¦: 90% */
            transition: .3s;
            /* ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³: 0.3ç§’ */
            box-shadow: 2px 2px 1px rgba(0, 0, 0, 0.3);
            /* ãƒœãƒƒã‚¯ã‚¹ã‚·ãƒ£ãƒ‰ã‚¦ */
            /* ...æ—¢å­˜ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£... */
            display: inline-flex;
            /* inline-block ã‹ã‚‰å¤‰æ›´: SVGã‚’ä¸­å¤®é…ç½®ã—ã‚„ã™ãã™ã‚‹ãŸã‚ */
            align-items: center;
            /* å‚ç›´ä¸­å¤® */
            justify-content: center;
            /* æ°´å¹³ä¸­å¤® */
            line-height: 0;
            /* æ—¢å­˜ã® 1em ã‹ã‚‰ 0 ã«å¤‰æ›´ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆç”¨ã®ä½™ç™½ã‚’æ¶ˆã™ */
            vertical-align: middle;
            /* ãƒ†ã‚­ã‚¹ãƒˆæœ‰ç„¡ã«ã‚ˆã‚‹é«˜ã•ã‚ºãƒ¬ã‚’è§£æ¶ˆ */
        }

        .other_button_css:hover,
        .run_button_css:hover,
        .stop_button_css:hover {
            box-shadow: none;
            /* ãƒ›ãƒãƒ¼æ™‚ã®ãƒœãƒƒã‚¯ã‚¹ã‚·ãƒ£ãƒ‰ã‚¦ã‚’è§£é™¤ */
            opacity: 1;
            /* ãƒ›ãƒãƒ¼æ™‚ã®ä¸é€æ˜åº¦: 100% */
        }

        .other_button_css {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸€èˆ¬ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background: rgba(40, 40, 40, 1);
            /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ (ä¸é€æ˜) */
            color: rgba(210, 210, 210, 1);
            /* æ–‡å­—è‰²: ç™½ */
        }

        .run_button_css {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background: rgba(120, 200, 180, 1);
            /* èƒŒæ™¯è‰²: ç·‘ãŒã‹ã£ãŸé’ (ä¸é€æ˜) */
            color: rgba(50, 50, 50, 1);
            /* æ–‡å­—è‰²: ç™½ */
        }

        .stop_button_css {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background: rgba(217, 83, 79, 1);
            /* èƒŒæ™¯è‰²: ç·‘ãŒã‹ã£ãŸé’ (ä¸é€æ˜) */
            color: rgba(50, 50, 50, 1);
            /* æ–‡å­—è‰²: ç™½ */
        }

        .other_selector_css,
        .other_input_css {
            border: 1px solid #555;
            border-radius: 5%;
            /* è§’ä¸¸: 5% */
            font-size: 10pt;
            /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 10pt */
            background: rgba(40, 40, 40, 1);
            /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ (ä¸é€æ˜) */
            color: rgba(255, 255, 255, 1);
            /* æ–‡å­—è‰²: ç™½ */
            padding: 2px 3px;
            /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šä¸‹2px, å·¦å³3px) */
        }
    </style>

</head>

<body>

    <div id="loader">
        <div>Initializing Sandbox...</div>
    </div>

    <header>
        <div id="buttons">
            <!-- [â‰¡] -->
            <button id="toggle_sidebar" class="other_button_css" title="Toggle_Sidebar" disabled>
                <svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor">
                    <g>
                        <rect y="16" width="96" height="96"></rect>
                        <rect x="160" y="16" width="352" height="96"></rect>
                        <rect y="208" width="96" height="96"></rect>
                        <rect x="160" y="208" width="352" height="96"></rect>
                        <rect y="400" width="96" height="96"></rect>
                        <rect x="160" y="400" width="352" height="96"></rect>
                    </g>
                </svg>
            </button>
            <button id="drive_dir" class="other_button_css" style="display: none;" disabled>Drive_Dir</button>
            <!-- é–‹ç™ºç”¨ãªç‚ºéè¡¨ç¤º -->
            <button id="download_html" class="other_button_css" title="Download_html" style="display: none;"
                disabled>DL</button>
            <!-- [â‡©] -->
            <button id="save_script" class="other_button_css" title="Save_Script" disabled>
                <svg viewBox="0 0 48 48" width="22" height="22" fill="none" stroke="currentColor" stroke-width="4"
                    stroke-linecap="round" stroke-linejoin="round">
                    <g>
                        <polyline points="6 35 6 42 42 42 42 35"></polyline>
                        <line x1="24" y1="24" x2="24" y2="10"></line>
                        <line x1="24" y1="34" x2="35" y2="23"></line>
                        <line x1="24" y1="34" x2="13" y2="23"></line>
                    </g>
                </svg>
            </button>
            <!-- [â– ] -->
            <button id="stop_script" class="stop_button_css" title="STOP_Script" disabled>
                <svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor">
                    <g>
                        <path
                            d="M256,0C114.625,0,0,114.625,0,256s114.625,256,256,256s256-114.625,256-256S397.375,0,256,0z M328,328H184V184h144V328z">
                        </path>
                    </g>
                </svg>
            </button>
            <!-- [â–¶] -->
            <button id="run_script" class="run_button_css" title="RUN_Script" disabled>
                <svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor">
                    <g>
                        <path d="M256,0C114.625,0,0,114.625,0,256c0,141.374,114.625,256,256,256c141.374,0,256-114.626,256-256
							C512,114.625,397.374,0,256,0z M351.062,258.898l-144,85.945c-1.031,0.626-2.344,0.657-3.406,0.031
							c-1.031-0.594-1.687-1.702-1.687-2.937v-85.946v-85.946c0-1.218,0.656-2.343,1.687-2.938c1.062-0.609,2.375-0.578,3.406,0.031
							l144,85.962c1.031,0.586,1.641,1.718,1.641,2.89C352.703,257.187,352.094,258.297,351.062,258.898z">
                        </path>
                    </g>
                </svg>
            </button>
            <!-- [â—†] -->
            <button id="send_prompt" class="other_button_css" title="send_prompt" style="display: none;" disabled>
                <svg width="18" height="18" viewBox="0 0 100 100" fill="currentColor">
                    <defs>
                        <linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#4285F4" />
                            <stop offset="50%" stop-color="#9B72CB" />
                            <stop offset="100%" stop-color="#D96570" />
                        </linearGradient>
                    </defs>
                    <path
                        d="M50 0C50 27.6142 72.3858 50 100 50C72.3858 50 50 72.3858 50 100C50 72.3858 27.6142 50 0 50C27.6142 50 50 27.6142 50 0Z"
                        fill="url(#geminiGradient)" />
                </svg>
            </button>
            <!-- [ğŸ”‘] -->
            <button id="copy_token" class="other_button_css" title="copy_token" style="display: none;" disabled>
                <svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor">
                    <g>
                        <path class="st0" d="M491.103,490.634l-12.05-86.739c-0.925-6.66-6.167-11.902-12.85-12.818l-33.622-4.655l-0.016-0.023
							l-4.646-33.598c-0.916-6.676-6.166-11.934-12.843-12.843l-22.182-3.064c-6.731-0.932-12.02-6.26-12.874-12.999l-7.193-56.494
							c-0.423-3.322-1.927-6.378-4.286-8.744l-35.769-35.762l-89.129,89.137l195.559,195.566c3.416,3.416,8.267,4.983,13.03,4.208
							l26.351-4.247C486.66,506.258,492.224,498.736,491.103,490.634z M445.367,467.456L279.6,301.696l12.826-12.826l165.768,165.76
							L445.367,467.456z">
                        </path>
                        <path class="st0" d="M369.159,133.852L241.801,6.493c-8.658-8.658-22.7-8.658-31.358,0L27.241,189.703
							c-8.65,8.65-8.65,22.691,0,31.342L154.6,348.412c8.666,8.658,22.699,8.658,31.358,0L369.159,165.21
							C377.818,156.552,377.818,142.51,369.159,133.852z M205.201,133.499l-50.954,50.954c-7.569,7.57-19.855,7.57-27.432-0.008
							c-7.577-7.576-7.57-19.862-0.008-27.432l50.962-50.954c7.569-7.57,19.847-7.577,27.432,0.008
							C212.771,113.636,212.771,125.931,205.201,133.499z">
                        </path>
                    </g>
                </svg>
            </button>
            <button id="serial_connect" class="other_button_css" title="serial_connect">
                <svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor">
                    <g>
                        <path
                            d="M101.723,233.634H0v44.741h101.723c9.87,36.784,43.344,63.904,83.248,63.904h62.31V169.722h-62.31C145.066,169.722,111.584,196.842,101.723,233.634z">
                        </path>
                        <path
                            d="M512,233.634H410.269c-9.862-36.792-43.336-63.912-83.24-63.912H264.72v172.557h62.309c39.896,0,73.369-27.12,83.24-63.904H512V233.634z">
                        </path>
                    </g>
                </svg>
            </button>
            <button id="serial_cut" class="other_button_css" title="serial_cut" style="opacity: 0.5" disabled>
                <svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor">
                    <g>
                        <path
                            d="M76.987,235.517H0v40.973h76.987c9.04,33.686,39.694,58.522,76.238,58.522h57.062V176.988h-57.062C116.682,176.988,86.019,201.824,76.987,235.517z">
                        </path>
                        <path
                            d="M512,235.517h-76.995c-9.032-33.693-39.686-58.53-76.23-58.53h-57.062v158.024h57.062c36.537,0,67.19-24.836,76.23-58.522H512V235.517z">
                        </path>
                    </g>
                </svg>
            </button>
            <input type="text" id="serial_baud_rate" class="other_input_css" name="serial_baud_rate"
                title="serial_baud_rate" value=9600 required minlength="1" maxlength="3" size="2">
            <input type="text" id="serial_data_bits" class="other_input_css" name="serial_data_bits"
                title="serial_data_bits" value=8 required minlength="1" maxlength="3" size="2">
            <input type="text" id="serial_parity" class="other_input_css" name="serial_parity" title="serial_parity"
                value="none" required minlength="1" maxlength="3" size="2">
            <input type="text" id="serial_stop_bits" class="other_input_css" name="serial_stop_bits"
                title="serial_stop_bits" value=1 required minlength="1" maxlength="3" size="2">
        </div>
    </header>

    <iframe id="ide_container"
        sandbox="allow-scripts allow-modals allow-downloads allow-forms allow-popups allow-presentation"
        allow="clipboard-read; clipboard-write; serial; file-system-read; file-system-write;"
        style="display: none;"></iframe>

    <!-- ################################################# â†“â†“â†“ SandBoxFrame â†“â†“â†“ ################################################# -->

    <textarea id="sandbox_source" style="display:none;">

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
		content="
			default-src 'self' https://script.google.com;
			script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
			connect-src 'self' https://script.google.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://pypi.org https://files.pythonhosted.org;
			worker-src 'self' blob: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
            style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
			font-src 'self' https://cdnjs.cloudflare.com;
			img-src 'self' data:;
			frame-src 'self' data: blob:;
		"
    >
    <title>WEB_Python_IDE</title>

    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.53/dist/zip-full.min.js" integrity="sha512-ffhPCx9UDDSYkyVFRt5B8hfxWXyd6ESv2sgiwJA6f5KBUdqaHnisupMaSkarEcSoVaZQaChqnTqhO0t938f+3g==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js" integrity="sha512-i+WlWssP2nJz+zYK8roBdf3gWUgRRRtI/4oKo8dg8GugFPaS8K10dtzKHmvXe7lErA/IcfVBiyPw1OBa9fm61A==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4.13.3/dist/index.min.js" integrity="sha512-b2TcnEw3o4n9G5BG+aQAuSLqqvZul6xv22Jv+R1LlQertJrMTAvVcgOkJYsYlZmCV8ROY3QXxUQL7i7l8qYeJw==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4.13.3/dist/jspreadsheet.min.css" integrity="sha512-2X3KUVKv7dnY0iYdVMj9gKhkGyLXENUYowwlvJJTmoy81nC6+Wv9biiD8n+gHYdTTzJxa1HqRKl7Xm5KkzDuMA==" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jsuites@4.3.2/dist/jsuites.min.js" integrity="sha512-sgm/Ov3gASI1VNKngHM5bf1QJTDAaE6cDbcYaPL8AtFF9oBQrggXs22DqjObk0pJCZTKXvNOwqMXp8Y8WycYbw==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites@4.3.2/dist/jsuites.min.css" integrity="sha512-gRz/VtWpNeHxUiebwfBf1rSAYm1ABWaZ3an3GA6PdY3Gfj4b+8jP6XMas7ZTqMDFB6RaoHi41gefhV5PATBaWw==" crossorigin="anonymous">

    <style id="body_style">
		/* ### Base Layout (åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) ### */
		body {
        background-color: rgb(25, 25, 25); /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
        color: white; /* æ–‡å­—è‰²: ç™½ */
        font-family: "Segoe UI", "Meiryo UI", sans-serif; /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        margin: 0; /* ä½™ç™½ã‚’ãƒªã‚»ãƒƒãƒˆ (å¤–å´ã®ã‚¹ãƒšãƒ¼ã‚¹) */
        padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ (å†…å´ã®ã‚¹ãƒšãƒ¼ã‚¹) */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«é…ç½® (header, container, footer) */
        height: 100vh; /* é«˜ã•: ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
        overflow: hidden; /* ã¯ã¿å‡ºã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º (å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢) */
		}
		#container {
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ï¼‰ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        flex: 1; /* æ‹¡å¤§ç‡: 1 (æ®‹ã‚Šã®å‚ç›´ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦ä½¿ç”¨) */
        overflow: hidden; /* ã¯ã¿å‡ºã—ã‚’éš ã™ */
		}
		footer {
        /* ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå®Ÿè¡Œçµæœã‚¨ãƒªã‚¢ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        height: 25%; /* åˆæœŸé«˜ã•: 25% */
        background-color: #333; /* èƒŒæ™¯è‰²: ã‚„ã‚„æš—ã„ã‚°ãƒ¬ãƒ¼ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«é…ç½® */
        padding: 0px 0px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        box-sizing: border-box; /* ãƒœãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºè¨ˆç®—: ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’é«˜ã•ã«å«ã‚ã‚‹ */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆé«˜ã•å›ºå®šï¼‰ */
        width: 100%; /* å¹…: 100% (å¹…ã„ã£ã±ã„) */
		}

		/* ### Footer Elements (ãƒ•ãƒƒã‚¿ãƒ¼å†…ã®è¦ç´ ) ### */
		#footer_area_container {
        /* ãƒ•ãƒƒã‚¿ãƒ¼å†…éƒ¨ã®ã‚¨ãƒªã‚¢ã‚³ãƒ³ãƒ†ãƒŠï¼ˆçµæœã‚¨ãƒªã‚¢ã¨ãƒ—ãƒ­ãƒƒãƒˆã‚¨ãƒªã‚¢ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ï¼‰ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š (å­è¦ç´ ã‚’æ¨ªä¸¦ã³ã«é…ç½®) */
        flex: 1; /* æ‹¡å¤§ç‡: 1 (ç¸¦æ–¹å‘ã®æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦ä½¿ç”¨) */
        gap: 0px; /* ã‚¢ã‚¤ãƒ†ãƒ é–“ã®éš™é–“: 5px */
        min-height: 0; /* æœ€å°é«˜ã•: 0 (flexã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ã®é«˜ã•ã®æœ€å°å€¤ã‚’ç¢ºä¿) */
		}
		#py_result_area {
        /* Pythonã®å®Ÿè¡Œçµæœï¼ˆæ¨™æº–å‡ºåŠ›ï¼‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        flex: 6 1 0%; /* æ‹¡å¤§:0, ç¸®å°:0, åŸºæº–ã‚µã‚¤ã‚º:auto (ã‚µã‚¤ã‚ºå›ºå®š) */
        padding: 1% 1%; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šä¸‹1%, å·¦å³5%) */
        background: rgb(30, 30, 30); /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
        color: rgb(250, 250, 250); /* æ–‡å­—è‰²: éå¸¸ã«æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ */
        border: 1px solid #555; /* å¢ƒç•Œç·š: 1px æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        border-radius: 4px; /* è§’ä¸¸: 4px */
        font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 14px */
        overflow: auto; /* ã¯ã¿å‡ºã—å‡¦ç†: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¯ã¿å‡ºãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
        resize: none; /* æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºç¦æ­¢ */
        box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨å¢ƒç•Œç·šã‚’å¹…ã¨é«˜ã•ã«å«ã‚ã‚‹ */
        min-width: 50px; /* æœ€å°å¹…: 50px */
		}
		#js_result_area {
        /* JavaScriptã®å®Ÿè¡Œçµæœï¼ˆãƒ­ã‚°ãªã©ï¼‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        flex: 3 1 0%; /* æ‹¡å¤§:0, ç¸®å°:0, åŸºæº–ã‚µã‚¤ã‚º:auto (ã‚µã‚¤ã‚ºå›ºå®š) */
        padding: 1% 1%; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šä¸‹1%, å·¦å³5%) */
        background: rgb(30, 30, 30); /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
        color: rgb(250, 250, 250); /* æ–‡å­—è‰²: éå¸¸ã«æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ */
        border: 1px solid #555; /* å¢ƒç•Œç·š: 1px æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        border-radius: 4px; /* è§’ä¸¸: 4px */
        font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 14px */
        overflow: auto; /* ã¯ã¿å‡ºã—å‡¦ç†: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¯ã¿å‡ºãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
        resize: none; /* æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºç¦æ­¢ */
        box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨å¢ƒç•Œç·šã‚’å¹…ã¨é«˜ã•ã«å«ã‚ã‚‹ */
        min-width: 50px; /* æœ€å°å¹…: 50px */
		}
		#extension_area {
        /* ã‚°ãƒ©ãƒ•/ãƒ—ãƒ­ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        flex: 3 1 0%; /* æ‹¡å¤§:0, ç¸®å°:0, åŸºæº–ã‚µã‚¤ã‚º:auto (ã‚µã‚¤ã‚ºå›ºå®š) */
        padding: 0.5% 0.5%; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        background: rgb(30, 30, 30); /* èƒŒæ™¯è‰²: é»’ç³»ã®è‰²ã«å¤‰æ›´ */
        color: rgb(250, 250, 250); /* æ–‡å­—è‰²: ç™½ */
        border: 1px solid #555; /* å¢ƒç•Œç·š: 1px æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        border-radius: 4px; /* è§’ä¸¸: 4px */
        /* font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 14px */
        overflow: auto; /* ã¯ã¿å‡ºã—å‡¦ç†: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¯ã¿å‡ºãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
        box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨å¢ƒç•Œç·šã‚’å¹…ã¨é«˜ã•ã«å«ã‚ã‚‹ */
        min-width: 50px; /* æœ€å°å¹…: 50px */
        height: 100%; /* è¦ªè¦ç´ ã®é«˜ã•ã«å¼·åˆ¶çš„ã«åˆã‚ã›ã‚‹ */
        /* min-height: 0; /* Flexboxã®å­è¦ç´ ã«ã‚ˆã‚‹è¦ªè¦ç´ ã®é«˜ã•æŠ¼ã—åºƒã’ã‚’é˜²ãã€overflowã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«é…ç½® */
        align-items: center; /* å­è¦ç´ ã‚’æ°´å¹³æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ (ç”»åƒã‚’ä¸­å¤®å¯„ã›) */
		}
		#extension_area img {
        /* ãƒ—ãƒ­ãƒƒãƒˆã‚¨ãƒªã‚¢å†…ã®ç”»åƒ */
        max-width: 100%; /* æœ€å¤§å¹…: è¦ªè¦ç´ ã®å¹…ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ */
        margin-bottom: 10px; /* ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³ */
        /* box-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* ãƒœãƒƒã‚¯ã‚¹ã‚·ãƒ£ãƒ‰ã‚¦: x:2px, y:2px, ã¼ã‹ã—:5px, è‰²:é»’(é€æ˜åº¦0.2) */
		}

		/* ### Vertical Resizer (ãƒ•ãƒƒã‚¿ãƒ¼å†…ã®å‚ç›´ãƒªã‚µã‚¤ã‚ºãƒãƒ¼) ### */
		#output_resizer_v {
        /* py_result_area <-> js_result_area ã®ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ */
        width: 5px; /* å¹…: 5px */
        cursor: ew-resize; /* ã‚«ãƒ¼ã‚½ãƒ«: å·¦å³ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ« */
        background-color: #444; /* èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        height: 100%; /* é«˜ã•: è¦ªè¦ç´ ã„ã£ã±ã„ã« */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ */
		}
		#output_resizer_v2 {
        /* js_result_area <-> extension_area ã®ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ */
        width: 5px; /* å¹…: 5px */
        cursor: ew-resize; /* ã‚«ãƒ¼ã‚½ãƒ«: å·¦å³ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ« */
        background-color: #444; /* èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        height: 100%; /* é«˜ã•: è¦ªè¦ç´ ã„ã£ã±ã„ã« */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ */
		}

		/* ãã®ä»–ã®ãƒ•ãƒƒã‚¿ãƒ¼å†…ã®è¦ç´  */
		footer div {
        font-size: 0.8em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: è¦ªè¦ç´ ã®0.8å€ */
        margin-bottom: 0px; /* ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³: 4px */
		}
		button, input[type="file"] {
        margin-right: 10px; /* å³ãƒãƒ¼ã‚¸ãƒ³: 10px */
		}

		#main_content { /* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
        flex: 1; /* æ‹¡å¤§ç‡: 1 (æ¨ªå¹…ã®æ®‹ã‚Šã‚’å…¨ã¦ä½¿ã†) */
        height: 100%; /* é«˜ã•: è¦ªè¦ç´ ã„ã£ã±ã„ã« */
        min-width: 0; /* æœ€å°å¹…: 0 (Flexboxã®ç¸®å°ãƒˆãƒ©ãƒ–ãƒ«é˜²æ­¢) */
        overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
		}
		#editor { /* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æœ¬ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        flex: 1; /* æ‹¡å¤§ç‡: 1 (é«˜ã•ã®æ®‹ã‚Šã‚’å…¨ã¦ä½¿ã†ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼ä»¥å¤–ã®éƒ¨åˆ†ï¼‰) */
        width: 100%; /* å¹…: 100% */
        height: auto; /* é«˜ã•: è‡ªå‹• */
        min-height: 0; /* æœ€å°é«˜ã•: 0 (Flexboxã®ç¸®å°ãƒˆãƒ©ãƒ–ãƒ«é˜²æ­¢) */
		}
		#editor.editor-dragover { /* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¸ã®ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®è¦–è¦šåŠ¹æœ */
        opacity: 0.7; /* ä¸é€æ˜åº¦: 70% */
        border: 3px dashed #007acc; /* å¢ƒç•Œç·š: 3px é’ã£ã½ã„ç ´ç·š */
        background-color: #2d2d2d; /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
		}
		#plot_container {
        flex: 1;
        width: 100%;
        height: 100%;
        min-height: 0;
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        background-color: rgb(30, 30, 30); /* ã‚¨ãƒ‡ã‚£ã‚¿èƒŒæ™¯ã«åˆã‚ã›ã‚‹ */
        flex-direction: column;
        align-items: center; /* ç”»åƒã‚’ä¸­å¤®æƒãˆ */
        overflow-y: auto;    /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹ */
        padding: 10px;
        box-sizing: border-box;
		}
		#plot_container img {
        max-width: 95%;      /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
        margin-bottom: 20px; /* ç”»åƒé–“ã®ä½™ç™½ */
        box-shadow: 0 0 10px rgba(0,0,0,0.5); /* è¦–èªæ€§å‘ä¸Šã®ãŸã‚ã®å½± */
		}
		#preview_container {
        flex: 1;
        width: 100%;
        height: 100%;
        min-height: 0;
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        background-color: white;
        flex-direction: column;
		}
		#preview_frame {
        width: 100%;
        height: 100%;
        border: none;
		}
 		/* ### Spreadsheet Styles ### */
 		#spreadsheet_container {
        flex: 1;
        width: 100%;
        height: 100%;
        min-height: 0;
        display: none;
        background-color: #1e1e1e; /* IDEã¨åŒã˜èƒŒæ™¯è‰² */
        color: #ccc; /* IDEã¨åŒã˜æ–‡å­—è‰² */
        overflow: auto;
		}

		.spreadsheet_instance {
        display: none;
		}
		.spreadsheet_instance.active_spreadsheet {
        display: block;
		}

		/* --- Jspreadsheet ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒç”¨CSSã®ä¸Šæ›¸ã --- */
		/* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®èƒŒæ™¯ã¨æ ç·š */
		.jexcel {
        background-color: #1e1e1e !important;
        border: 1px solid #333 !important;
		}
		/* é€šå¸¸ã‚»ãƒ«ã®è‰²ã¨æ ç·š */
		.jexcel tbody tr td {
        background-color: #1e1e1e !important;
        color: #ccc !important;
        border-bottom: 1px solid #333 !important;
        border-right: 1px solid #333 !important;
		}
		/* è¡Œãƒ»åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ (A, B, C... / 1, 2, 3...) */
		.jexcel thead tr td, 
		.jexcel tbody tr td.jexcel_label {
        background-color: #2d2d2d !important; /* å°‘ã—æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ã§åŒºåˆ¥ */
        color: #ccc !important;
        border-bottom: 1px solid #444 !important;
        border-right: 1px solid #444 !important;
		}
		/* é¸æŠä¸­ã®ã‚»ãƒ« */
		.jexcel tbody tr td.highlight {
        background-color: #062f4f !important; /* VSCodeç­‰ã®é¸æŠè‰²ã«è¿‘ã„æ·±ã„é’ */
        color: #fff !important;
		}
		/* ç·¨é›†ä¸­ã®ã‚»ãƒ« (ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚) */
		.jexcel tbody tr td.editor {
        background-color: #1e1e1e !important;
        color: #fff !important;
		}
    .jexcel tbody tr td.editor input,
		.jexcel tbody tr td.editor textarea {
        color: #ffffff !important;
        background-color: #1e1e1e !important;
		}
		/* ### Tab Bar Styles (ã‚¿ãƒ–ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«) ### */
		#tab_bar_container {
        /* ã‚¿ãƒ–ãƒãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        background-color: #252526; /* èƒŒæ™¯è‰²: VSCodeãƒ©ã‚¤ã‚¯ãªãƒ˜ãƒƒãƒ€ãƒ¼è‰² */
        height: 35px; /* é«˜ã•: 35px */
        overflow-x: auto; /* Xè»¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ã‚¿ãƒ–ãŒå¤šã„å ´åˆã¯æ°´å¹³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆé«˜ã•å›ºå®šï¼‰ */
        align-items: center; /* å­è¦ç´ ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ */
        border-bottom: 1px solid #1e1e1e; /* ä¸‹å¢ƒç•Œç·š: 1px éå¸¸ã«æš—ã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
		}
		/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆwebkitç³»ï¼‰ */
		#tab_bar_container::-webkit-scrollbar {
        height: 4px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®é«˜ã•: 4px */
		}
		#tab_bar_container::-webkit-scrollbar-thumb {
			  background: #424242; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ„ãƒãƒŸã®è‰² */
		}
		.tab_item {
        /* å„ã‚¿ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        align-items: center; /* å­è¦ç´ ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ */
        padding: 0 10px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šä¸‹0, å·¦å³10px) */
        height: 100%; /* é«˜ã•: è¦ªè¦ç´ ã„ã£ã±ã„ã« */
        background-color: #2d2d2d; /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
        color: #969696; /* æ–‡å­—è‰²: ã‚°ãƒ¬ãƒ¼ */
        font-size: 13px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 13px */
        cursor: pointer; /* ã‚«ãƒ¼ã‚½ãƒ«: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
        border-right: 1px solid #252526; /* å³å¢ƒç•Œç·š: 1px éå¸¸ã«æš—ã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        min-width: 80px; /* æœ€å°å¹…: 80px */
        max-width: 200px; /* æœ€å¤§å¹…: 200px */
        user-select: none; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹é¸æŠã‚’ç¦æ­¢ */
		}
		.tab_item:hover {
			  background-color: #383838; /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
		}
		.tab_item.active_tab {
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ– */
        background-color: #1e1e1e; /* èƒŒæ™¯è‰²: ã‚¨ãƒ‡ã‚£ã‚¿èƒŒæ™¯ã¨åŒã˜è‰² */
        color: #ffffff; /* æ–‡å­—è‰²: ç™½ */
        border-top: 1px solid #007acc; /* ä¸Šå¢ƒç•Œç·š: 1px é’ã®å®Ÿç·š (å¼·èª¿) */
		}
		.tab_name {
        /* ã‚¿ãƒ–ã®ãƒ•ã‚¡ã‚¤ãƒ«å */
        white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’ç¦æ­¢ */
        overflow: hidden; /* ã¯ã¿å‡ºã—ãŸéƒ¨åˆ†ã‚’éš ã™ */
        text-overflow: ellipsis; /* ã¯ã¿å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸‰ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼ã§è¡¨ç¤º */
        margin-right: 8px; /* å³ãƒãƒ¼ã‚¸ãƒ³: 8px */
		}
		.tab_close_btn {
        /* ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
        border-radius: 50%; /* è§’ä¸¸: å††å½¢ */
        width: 16px; /* å¹…: 16px */
        height: 16px; /* é«˜ã•: 16px */
        text-align: center; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
        line-height: 14px; /* è¡Œã®é«˜ã•: 14px */
        font-size: 12px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 12px */
        color: #ccc; /* æ–‡å­—è‰²: è–„ã„ã‚°ãƒ¬ãƒ¼ */
        margin-left: auto; /* å·¦ãƒãƒ¼ã‚¸ãƒ³ã‚’è‡ªå‹•ã«ã—ã€è¦ç´ ã‚’å³å¯„ã› */
		}
		.tab_close_btn:hover {
        background-color: #444; /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        color: #fff; /* ãƒ›ãƒãƒ¼æ™‚ã®æ–‡å­—è‰²: ç™½ */
		}
		.tab_unsaved_indicator {
        /* æœªä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆé€šå¸¸ã¯éè¡¨ç¤ºï¼‰ */
        font-size: 18px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 18px */
        line-height: 10px; /* è¡Œã®é«˜ã•: 10px */
        margin-left: 5px; /* å·¦ãƒãƒ¼ã‚¸ãƒ³: 5px */
        display: none; /* è¦ç´ ã‚’éè¡¨ç¤º */
		}
		.tab_plus_btn {
        /* æ–°è¦ã‚¿ãƒ–ã‚’è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        align-items: center; /* å­è¦ç´ ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ */
        justify-content: center; /* å­è¦ç´ ã‚’æ°´å¹³æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ */
        padding: 0 10px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šä¸‹0, å·¦å³10px) */
        height: 100%; /* é«˜ã•: è¦ªè¦ç´ ã„ã£ã±ã„ã« */
        background-color: transparent; /* èƒŒæ™¯è‰²: é€æ˜ */
        color: #969696; /* æ–‡å­—è‰²: ã‚°ãƒ¬ãƒ¼ */
        font-size: 16px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 16px */
        cursor: pointer; /* ã‚«ãƒ¼ã‚½ãƒ«: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
        min-width: 30px; /* æœ€å°å¹…: 30px */
        border-right: 1px solid #252526; /* å³å¢ƒç•Œç·š: 1px éå¸¸ã«æš—ã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        user-select: none; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹é¸æŠã‚’ç¦æ­¢ */
		}
		.tab_plus_btn:hover {
        background-color: #383838; /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
        color: #fff; /* ãƒ›ãƒãƒ¼æ™‚ã®æ–‡å­—è‰²: ç™½ */
		}

		/* ### Resizer Styles (ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«) ### */

		/* Sidebar <-> Editor ã®å‚ç›´ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ */
		#sidebar_resizer_v {
        width: 5px; /* å¹…: 5px */
        cursor: ew-resize; /* ã‚«ãƒ¼ã‚½ãƒ«: å·¦å³ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ« */
        background-color: #444; /* èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        height: 100%; /* é«˜ã•: è¦ªè¦ç´ ã„ã£ã±ã„ã« */
		}

		/* Script_Explorer <-> VFS_Explorer ã®æ°´å¹³ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ */
		#sidebar_resizer_h {
        height: 5px; /* é«˜ã•: 5px */
        cursor: ns-resize; /* ã‚«ãƒ¼ã‚½ãƒ«: ä¸Šä¸‹ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ« */
        background-color: #444; /* èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆé«˜ã•å›ºå®šï¼‰ */
		}

		/* VFS_Explorer <-> Outline ã®æ°´å¹³ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ */
		#sidebar_resizer_h2 {
        height: 5px; /* é«˜ã•: 5px */
        cursor: ns-resize; /* ã‚«ãƒ¼ã‚½ãƒ«: ä¸Šä¸‹ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ« */
        background-color: #444; /* èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆé«˜ã•å›ºå®šï¼‰ */
		}

		#footer_resizer_h { /* Editor <-> Footer ã®æ°´å¹³ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ */
        height: 5px; /* é«˜ã•: 5px */
        cursor: ns-resize; /* ã‚«ãƒ¼ã‚½ãƒ«: ä¸Šä¸‹ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ« */
        background-color: #444; /* èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆæ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰ */
        width: 100%; /* å¹…: 100% */
		}

		/* ### Sidebar Layout (ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) ### */
		#sidebar_area_container {
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ (Script_Explorer + VFS_Explorer + Outline) */
        width: 280px; /* åˆæœŸå¹…: 280px */
        min-width: 150px; /* æœ€å°å¹…: 150px */
        background-color: rgb(30, 30, 30); /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«é…ç½® */
        overflow: hidden; /* ã¯ã¿å‡ºã—ã‚’éš ã™ */
        flex-shrink: 0; /* ç¸®å°ã‚’ç¦æ­¢ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼å¹…æ‹¡å¤§ã‚’å¯èƒ½ã«ã™ã‚‹ï¼‰ */
		}

		/* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®å„ãƒ‘ãƒãƒ«ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
		#script_explorer_container, #vfs_explorer_container, #outline_container {
        padding: 10px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¹…ã¨é«˜ã•ã«å«ã‚ã‚‹ */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ */
        flex-shrink: 1; /* ç¸®å°ã‚’è¨±å¯ */
        flex-grow: 1; /* æ‹¡å¤§ã‚’è¨±å¯ */
		}
		#script_explorer_container {
			  flex-basis: 25%; /* åˆæœŸåŸºæº–é«˜ã•: 25% (Script Explorerã®åˆæœŸé«˜ã•ã®å‰²åˆ) */
		}
		#vfs_explorer_container {
		  	flex-basis: 25%; /* åˆæœŸåŸºæº–é«˜ã•: 25% (VFS Explorerã®åˆæœŸé«˜ã•ã®å‰²åˆ) */
		}
		#outline_container {
		  	flex-basis: 50%; /* åˆæœŸåŸºæº–é«˜ã•: 50% (Outlineã®åˆæœŸé«˜ã•ã®å‰²åˆ) */
		}

		/* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— (h3) */
		#sidebar_area_container h3 {
        margin: 0 0 10px 0; /* ãƒãƒ¼ã‚¸ãƒ³ (ä¸Š:0, å·¦å³:0, ä¸‹:10px) */
        font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 14px */
        color: #ccc; /* æ–‡å­—è‰²: è–„ã„ã‚°ãƒ¬ãƒ¼ */
        border-bottom: 1px solid #555; /* ä¸‹å¢ƒç•Œç·š: 1px æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        padding-bottom: 5px; /* ä¸‹éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: 5px */
		}

		/* ### File Explorer Styles (ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«) ### */
		#script_explorer ul, #vfs_explorer ul { /* ãƒ„ãƒªãƒ¼æ§‹é€ ã®ãƒªã‚¹ãƒˆ */
        list-style: none; /* ãƒªã‚¹ãƒˆã®ãƒãƒ¼ã‚«ãƒ¼ã‚’éè¡¨ç¤º */
        padding-left: 15px; /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: 15px (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ) */
        margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
		}
		/* li è‡ªä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ§‹é€ ç”¨ã®ã¿ã«æ®‹ã™ */
		.explorer-item {
        /* ä»¥å‰ã® padding, cursor, color, hover ã¯ item_row ã¸ç§»å‹• */
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
		}
		/* ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’å«ã‚€ã€Œè¡Œã€ã®ã‚¹ã‚¿ã‚¤ãƒ« */
		.item_row {
        padding: 4px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        cursor: pointer; /* ã‚«ãƒ¼ã‚½ãƒ« */
        color: #ddd; /* æ–‡å­—è‰² */
        display: block; /* ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤ºã§å¹…ã„ã£ã±ã„ã«ã™ã‚‹ */
        border-radius: 3px; /* å°‘ã—è§’ä¸¸ã« */
		}
		/* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰²ã¯ã€Œè¡Œã€ã«å¯¾ã—ã¦é©ç”¨ */
		.item_row:hover {
			  background-color: #555; /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰²: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
		}
		/* ã‚¯ãƒªãƒƒã‚¯é¸æŠæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
		.item_row.selected_item {
        background-color: #007acc; /* é¸æŠæ™‚: é’è‰² (VSCodeé¢¨) */
        color: white; /* æ–‡å­—è‰²ã‚’ç™½ã§å¼·èª¿ */
		}

		/* ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆ:beforeç–‘ä¼¼è¦ç´ ï¼‰ã¯ item_row ã«å¯¾ã—ã¦é©ç”¨ */
		.item_row::before {
        font-family: "Consolas", monospace; /* ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®ãƒ•ã‚©ãƒ³ãƒˆ */
        margin-right: 8px; /* å³ãƒãƒ¼ã‚¸ãƒ³ */
        width: 16px; /* å¹… */
        display: inline-block;
        text-align: center;
		}
		/* ãƒ•ã‚©ãƒ«ãƒ€ã‹ã©ã†ã‹ã¯è¦ªã® li (.folder-item) ã§åˆ¤æ–­ã—ã€ã‚¢ã‚¤ã‚³ãƒ³ã¯å­ã® .item_row ã«å‡ºã™ */
		.folder-item > .item_row::before {
		  	content: "ğŸ“"; /* ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¤ã‚³ãƒ³ */
		}
		.folder-item.expanded > .item_row::before {
		  	content: "ğŸ“‚"; /* å±•é–‹ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¤ã‚³ãƒ³ */
		}
		.file-item > .item_row::before {
		  	content: "ğŸ“„"; /* ä¸€èˆ¬ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ */
		}
		.python-file > .item_row::before {
		  	content: "ğŸ"; /* Pythonãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ */
		}

		.folder-item.collapsed > ul {
		  	display: none; /* é–‰ã˜ã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®å­è¦ç´  (ul) ã‚’éè¡¨ç¤º */
		}

		/* ### Outline Styles (ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«) ### */
		.outline-item {
        /* ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã®åŸºæœ¬ã‚¢ã‚¤ãƒ†ãƒ  */
        padding: 1px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: 1px */
        cursor: pointer; /* ã‚«ãƒ¼ã‚½ãƒ«: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
        color: #fff; /* æ–‡å­—è‰²: ç™½ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        align-items: center; /* å­è¦ç´ ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«æƒãˆã‚‹ */
        font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 14px */
		}
		.outline-item:hover {
			  background-color: rgb(150, 150, 150); /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰²: ä¸­ç¨‹åº¦ã®ã‚°ãƒ¬ãƒ¼ */
		}
		.class-item {
        /* ã‚¯ãƒ©ã‚¹å®šç¾©ã®ã‚¢ã‚¤ãƒ†ãƒ  */
        color: rgb(30, 170, 30); /* æ–‡å­—è‰²: ç·‘ç³» */
        font-size: 16px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 16px */
		}
		.function-item {
        /* é–¢æ•°/ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã®ã‚¢ã‚¤ãƒ†ãƒ  */
        color: rgb(30, 120, 170); /* æ–‡å­—è‰²: é’ç³» */
        padding-left: 15px; /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: 15px (ã‚¯ãƒ©ã‚¹ã‚ˆã‚Šã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ) */
        font-size: 16px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: 16px */
		}

		/* ### Button Styles (å„ç¨®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«) ### */
		.sidebar_button_css {
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        display: inline-flex; /* inline-block ã‹ã‚‰å¤‰æ›´: SVGã‚’ä¸­å¤®é…ç½®ã—ã‚„ã™ãã™ã‚‹ãŸã‚ */
        width: 30px; /* å¹…: 30px */
        height: 20px; /* é«˜ã•: 20px */
        border-radius: 5%; /* è§’ä¸¸: 5% */
        font-size: 1em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: è¦ªè¦ç´ ã¨åŒã˜ */
        margin-right: 3px; /* å³ãƒãƒ¼ã‚¸ãƒ³: 3px */
        text-align: center; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
        align-items: center;  /* å‚ç›´ä¸­å¤® */
        justify-content: center; /* æ°´å¹³ä¸­å¤® */
        cursor: pointer; /* ã‚«ãƒ¼ã‚½ãƒ«: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
        padding: 0px 0px; /* å†…éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: 0 */
        background: rgba(30, 30, 30, 1); /* èƒŒæ™¯è‰²: æš—ã„ã‚°ãƒ¬ãƒ¼ (ä¸é€æ˜) */
        color: #ccc; /* æ–‡å­—è‰²: è–„ã„ã‚°ãƒ¬ãƒ¼ */
        line-height: 1em; /* è¡Œã®é«˜ã•: è¦ªè¦ç´ ã¨åŒã˜ */
        opacity: 1; /* ä¸é€æ˜åº¦: 100% */
        vertical-align: middle; /* å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆ */
        transition: .1s; /* ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³: 0.1ç§’ */
		}
		.sidebar_button_css:hover {
        box-shadow: none; /* ãƒ›ãƒãƒ¼æ™‚ã®ãƒœãƒƒã‚¯ã‚¹ã‚·ãƒ£ãƒ‰ã‚¦ã‚’è§£é™¤ */
        opacity: 1; /* ãƒ›ãƒãƒ¼æ™‚ã®ä¸é€æ˜åº¦: 100% */
		}

		/* VFSã‚¨ãƒªã‚¢ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®è¦–è¦šåŠ¹æœ */
		#vfs_explorer_container.dragover {
        background-color: #444; /* èƒŒæ™¯ã‚’å°‘ã—æ˜ã‚‹ã */
        border: 2px dashed #888; /* å¢ƒç•Œç·š: 2px æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã®ç ´ç·šã‚’è¡¨ç¤º */
        opacity: 0.8; /* ä¸é€æ˜åº¦: 80% */
		}
		/* VFSå†…éƒ¨ç§»å‹•æ™‚ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¼·èª¿ */
		.vfs_drop_target {
        background-color: #2a4d69 !important; /* èƒŒæ™¯è‰²: é’ã£ã½ãå¼·èª¿ (æœ€å„ªå…ˆ) */
        border: 1px dashed #63ace5; /* å¢ƒç•Œç·š: 1px æ˜ã‚‹ã„é’ã®ç ´ç·š */
        color: white; /* æ–‡å­—è‰²: ç™½ */
		}

		.sidebar_button_container {
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæ¨ªä¸¦ã³ç”¨ï¼‰ */
        display: flex; /* Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š */
        gap: 0px; /* ã‚¢ã‚¤ãƒ†ãƒ é–“ã®éš™é–“: 0px */
		}
		/* ### Sidebar Toggle Style (ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆ) ### */
		/* bodyã‚¿ã‚°ã« "sidebar-hidden" ã‚¯ãƒ©ã‚¹ãŒä»˜ã„ãŸæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
		body.sidebar-hidden #sidebar_area_container {
        display: none; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤º */
		}
			body.sidebar-hidden #sidebar_resizer_v {
			  display: none; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼æ¨ªã®ãƒªã‚µã‚¤ã‚ºãƒãƒ¼ã‚‚éè¡¨ç¤º */
		}

		/* ### Loading Overlay (ãƒ­ãƒ¼ãƒ‰ä¸­ç”»é¢) ### */
		#loading_overlay {
        position: fixed; /* é…ç½®: ç”»é¢ã«å›ºå®š */
        top: 0; /* ä¸Šç«¯ã‹ã‚‰: 0 */
        left: 0; /* å·¦ç«¯ã‹ã‚‰: 0 */
        width: 100%; /* å¹…: 100% */
        height: 100%; /* é«˜ã•: 100% */
        background-color: rgba(0, 0, 0, 0.5); /* èƒŒæ™¯è‰²: åŠé€æ˜ã®é»’èƒŒæ™¯ */
        z-index: 9999; /* Zè»¸ã®æ·±ã•: æœ€å‰é¢ã«è¡¨ç¤º (ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸‹) */
        display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
        justify-content: center; /* æ°´å¹³æ–¹å‘ã®ä¸­å¤®æƒãˆ */
        align-items: center; /* å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆ */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«é…ç½® */
        color: white; /* æ–‡å­—è‰²: ç™½ */
        font-size: 1.2em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: è¦ªè¦ç´ ã®1.2å€ */
		}
		.spinner {
        /* å›è»¢ã™ã‚‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å†† */
        border: 8px solid #f3f3f3; /* å¢ƒç•Œç·š: 8px è–„ã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿç·š */
        border-top: 8px solid #3498db; /* å¢ƒç•Œç·šã®ä¸Šéƒ¨: 8px é’è‰² (å›è»¢ã™ã‚‹éƒ¨åˆ†) */
        border-radius: 50%; /* å½¢çŠ¶: å††å½¢ */
        width: 60px; /* å¹…: 60px */
        height: 60px; /* é«˜ã•: 60px */
        animation: spin 1s linear infinite; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: spin ã‚’ 1ç§’ã‹ã‘ã¦ç·šå½¢ã«ç„¡é™ã«ç¹°ã‚Šè¿”ã™ */
        margin-bottom: 15px; /* ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³: 15px */
		}
		  	@keyframes spin {
        /* ã‚¹ãƒ”ãƒŠãƒ¼ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
        0% { transform: rotate(0deg); } /* é–‹å§‹æ™‚: 0åº¦å›è»¢ */
        100% { transform: rotate(360deg); } /* çµ‚äº†æ™‚: 360åº¦å›è»¢ */
		}
    </style>

	</head>
	<body>
    <div id="loading_overlay">
		<div class="spinner"></div>
		<div id="loading_text">Loading...</div>
    </div>
    <header>
		<div id="buttons">
			<input type="file" id="input_script_folder" webkitdirectory directory multiple style="display: none;">
			<input type="file" id="input_vfs_folder" webkitdirectory directory multiple style="display: none;">
		</div>
    </header>
    <div id="container">
		<div id="sidebar_area_container">
			<div id="script_explorer_container">
				<h3>
					<div class="sidebar_button_container">
						<!-- [ğŸ”—] ã—ã‹ã—sandboxç’°å¢ƒä¸‹ã§ã¯è¨±å¯ã•ã‚Œãªã„-->
						<button id="script_mount" class="sidebar_button_css" title="Script_Folder_Mount" style="display: none;" disabled>
							<svg viewBox="0 0 512 512" width="16" height="16" fill="#ccc" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
								<g>
									<path class="st0" d="M443.291,100.34c-4.563-23.391-16-45.938-34.078-64.016C397.15,24.293,383.134,15.137,368.149,9.09
										c-22.406-9.094-46.859-11.344-70.297-6.844c-23.406,4.563-45.953,16-64.031,34.078l-94.125,94.156
										c-12.063,12.047-21.172,26.094-27.266,41.016c-9.078,22.453-11.328,46.859-6.781,70.313c4.484,23.406,15.938,45.938,34.047,64.016
										c12.031,12.078,26.078,21.203,41.047,27.234c22.438,9.141,46.844,11.375,70.281,6.844c23.422-4.516,45.969-15.953,64.047-34.078
										l7.063-7.016c0.844-6.469,0-13.234-2.422-19.234c-1.906-4.625-4.672-8.859-8.344-12.469c-5.422-5.469-12.031-8.922-19.516-10.438
										c-3.984-0.75-8.141-0.859-12.219-0.344l-7.031,7.078c-6.313,6.25-13.453,10.906-21.125,14.078
										c-11.531,4.656-24.234,5.859-36.328,3.453c-12.156-2.328-23.563-8.094-32.984-17.531c-6.328-6.313-10.938-13.484-14.078-21.188
										c-4.656-11.469-5.828-24.203-3.516-36.297c2.406-12.109,8.125-23.516,17.594-33.016l94.141-94.125
										c6.281-6.297,13.453-10.953,21.125-14.031c11.5-4.703,24.219-5.875,36.313-3.516c12.141,2.359,23.531,8.141,33,17.547
										c6.313,6.313,10.938,13.5,14.078,21.172c4.642,11.484,5.845,24.203,3.485,36.297c-2.298,11.859-7.876,23-16.923,32.328
										c8.328,5.547,16.141,11.938,23.313,19.094c7.234,7.203,13.594,15.031,19.109,23.375c11.75-11.891,20.688-25.672,26.641-40.391
										C445.525,148.199,447.807,123.793,443.291,100.34z">
									</path>
									<path class="st0" d="M372.259,206.168c-12.031-12.047-26.047-21.188-41.016-27.234c-22.406-9.078-46.875-11.328-70.313-6.797
										c-23.406,4.5-45.938,15.938-64.016,34.031l-7.078,7.063c-0.797,6.484,0,13.188,2.469,19.203c1.859,4.641,4.672,8.875,8.344,12.531
										c5.406,5.375,12,8.906,19.5,10.344c3.953,0.797,8.156,0.891,12.188,0.359l7.047-7.031c6.297-6.328,13.438-10.953,21.141-14.063
										c11.5-4.656,24.203-5.844,36.313-3.547c12.125,2.391,23.516,8.172,33,17.609c6.297,6.297,10.922,13.422,14.031,21.078
										c4.688,11.563,5.844,24.266,3.531,36.359c-2.359,12.156-8.125,23.547-17.563,33.016l-94.156,94.109
										c-6.281,6.344-13.453,10.953-21.141,14.078c-11.516,4.641-24.203,5.828-36.313,3.516c-12.141-2.391-23.531-8.156-33-17.594
										c-6.297-6.266-10.922-13.422-14.031-21.094c-4.688-11.563-5.891-24.25-3.531-36.328c2.344-11.875,7.891-23.016,16.953-32.344
										c-8.359-5.5-16.141-11.906-23.344-19.109l-0.078-0.047c-7.188-7.172-13.516-14.984-19.031-23.297
										c-11.75,11.891-20.688,25.688-26.625,40.359c-9.094,22.438-11.344,46.906-6.813,70.313c4.516,23.469,15.953,45.984,34.063,64.031
										c12.047,12.063,26.063,21.156,41.031,27.266c22.406,9.063,46.859,11.313,70.297,6.781s45.953-15.938,64.031-34.047l94.109-94.125
										c12.095-12.063,21.22-26.109,27.267-41.031c9.094-22.453,11.344-46.906,6.813-70.328C401.838,246.762,390.4,224.23,372.259,206.168z">
									</path>
								</g>
							</svg>
						</button>
						<!-- [â‡§] -->
						<button id="script_upload" class="sidebar_button_css" title="Script_Folder_Upload">
							<svg viewBox="0 0 48 48" width="16" height="16" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
								<g>
									<polyline points="6 34.83 6 41.83 42 41.83 42 34.83"></polyline>
									<line x1="24" y1="32.82" x2="24" y2="18.82"></line>
									<line x1="24" y1="9" x2="13" y2="20"></line>
									<line x1="24" y1="9" x2="35" y2="20"></line>
								</g>
							</svg>
						</button>
						<!-- [âŸ³] -->
						<button id="refresh_script_explorer" class="sidebar_button_css" title="Refresh_Script">
							<svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor">
								<g>
									<path class="st0" d="M499.795,195.596c-11.804-27.884-31.438-51.515-56.186-68.24c-24.717-16.724-54.739-26.526-86.773-26.518
                                        h-44.222l10.195-24.234c1.335-3.176,0.531-6.834-1.994-9.158c-2.541-2.316-6.255-2.798-9.295-1.19l-108.932,57.578
                                        c-2.67,1.399-4.342,4.173-4.326,7.18c0,3.015,1.656,5.797,4.326,7.189l108.932,57.585c3.023,1.608,6.738,1.126,9.279-1.181
                                        c2.541-2.324,3.344-5.991,2.01-9.158l-10.211-24.266h44.238c13.187,0.008,25.569,2.654,36.906,7.438
                                        c16.982,7.172,31.518,19.24,41.746,34.389c10.228,15.172,16.161,33.248,16.177,52.994c-0.016,13.17-2.653,25.569-7.445,36.89
                                        c-7.172,16.982-19.232,31.518-34.381,41.746c-15.18,10.228-33.255,16.161-53.003,16.177v60.344c21.34,0,41.827-4.342,60.416-12.206
                                        c27.869-11.803,51.508-31.438,68.231-56.178c16.725-24.732,26.534-54.748,26.518-86.773
                                        C512,234.665,507.658,214.178,499.795,195.596z">
                                    </path>
									<path class="st0" d="M309.413,373.796l-108.932-57.585c-3.023-1.608-6.738-1.126-9.278,1.182c-2.541,2.324-3.345,5.998-2.01,9.158
                                        l10.211,24.265h-44.238c-13.187-0.008-25.569-2.653-36.906-7.437c-16.982-7.172-31.518-19.24-41.746-34.389
                                        c-10.228-15.164-16.161-33.247-16.178-52.986c0.016-13.178,2.654-25.576,7.445-36.897c7.172-16.982,19.234-31.519,34.381-41.747
                                        c15.18-10.227,33.256-16.16,53.003-16.177v-60.344c-21.339,0-41.827,4.342-60.416,12.205
                                        c-27.869,11.804-51.508,31.439-68.231,56.187C9.793,193.956-0.016,223.971,0,256.004c0,21.34,4.342,41.818,12.205,60.4
                                        c11.804,27.885,31.438,51.516,56.187,68.24c24.716,16.724,54.74,26.526,86.773,26.518h44.222l-10.195,24.234
                                        c-1.335,3.176-0.53,6.842,1.994,9.158c2.541,2.315,6.256,2.798,9.295,1.19l108.932-57.57c2.669-1.407,4.342-4.181,4.326-7.188
                                        C313.739,377.97,312.082,375.188,309.413,373.796z">
                                    </path>
								</g>
							</svg>
						</button>Script_Explorer
					</div>
				</h3>
				<div id="script_explorer"></div>
			</div>
			<div id="sidebar_resizer_h"></div>
			<div id="vfs_explorer_container">
				<h3>
					<div class="sidebar_button_container">
						<!-- [â‡§] -->
						<button id="vfs_upload" class="sidebar_button_css" title="Folder_Upload">
							<svg viewBox="0 0 48 48" width="16" height="16" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
								<g>
									<polyline points="6 34.83 6 41.83 42 41.83 42 34.83"></polyline>
									<line x1="24" y1="32.82" x2="24" y2="18.82"></line>
									<line x1="24" y1="9" x2="13" y2="20"></line>
									<line x1="24" y1="9" x2="35" y2="20"></line>
								</g>
							</svg>
						</button>
						<!-- [âŸ³] -->
						<button id="refresh_vfs_explorer" class="sidebar_button_css" title="Refresh_VFS">
							<svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor">
								<g>
									<path class="st0" d="M499.795,195.596c-11.804-27.884-31.438-51.515-56.186-68.24c-24.717-16.724-54.739-26.526-86.773-26.518
										h-44.222l10.195-24.234c1.335-3.176,0.531-6.834-1.994-9.158c-2.541-2.316-6.255-2.798-9.295-1.19l-108.932,57.578
										c-2.67,1.399-4.342,4.173-4.326,7.18c0,3.015,1.656,5.797,4.326,7.189l108.932,57.585c3.023,1.608,6.738,1.126,9.279-1.181
										c2.541-2.324,3.344-5.991,2.01-9.158l-10.211-24.266h44.238c13.187,0.008,25.569,2.654,36.906,7.438
										c16.982,7.172,31.518,19.24,41.746,34.389c10.228,15.172,16.161,33.248,16.177,52.994c-0.016,13.17-2.653,25.569-7.445,36.89
										c-7.172,16.982-19.232,31.518-34.381,41.746c-15.18,10.228-33.255,16.161-53.003,16.177v60.344c21.34,0,41.827-4.342,60.416-12.206
										c27.869-11.803,51.508-31.438,68.231-56.178c16.725-24.732,26.534-54.748,26.518-86.773
										C512,234.665,507.658,214.178,499.795,195.596z">
									</path>
									<path class="st0" d="M309.413,373.796l-108.932-57.585c-3.023-1.608-6.738-1.126-9.278,1.182c-2.541,2.324-3.345,5.998-2.01,9.158
										l10.211,24.265h-44.238c-13.187-0.008-25.569-2.653-36.906-7.437c-16.982-7.172-31.518-19.24-41.746-34.389
										c-10.228-15.164-16.161-33.247-16.178-52.986c0.016-13.178,2.654-25.576,7.445-36.897c7.172-16.982,19.234-31.519,34.381-41.747
										c15.18-10.227,33.256-16.16,53.003-16.177v-60.344c-21.339,0-41.827,4.342-60.416,12.205
										c-27.869,11.804-51.508,31.439-68.231,56.187C9.793,193.956-0.016,223.971,0,256.004c0,21.34,4.342,41.818,12.205,60.4
										c11.804,27.885,31.438,51.516,56.187,68.24c24.716,16.724,54.74,26.526,86.773,26.518h44.222l-10.195,24.234
										c-1.335,3.176-0.53,6.842,1.994,9.158c2.541,2.315,6.256,2.798,9.295,1.19l108.932-57.57c2.669-1.407,4.342-4.181,4.326-7.188
										C313.739,377.97,312.082,375.188,309.413,373.796z">
									</path>
								</g>
							</svg>
						</button>
						<!-- [x] -->
						<button id="reset_vfs_explorer" class="sidebar_button_css" title="Reset_VFS">
							<svg viewBox="0 0 512 512" width="12" height="12" fill="currentColor">
								<g>
									<polygon class="st0" points="512,89.75 422.256,0.005 256.004,166.256 89.754,0.005 0,89.75 166.255,256 0,422.25 89.754,511.995 
									256.004,345.745 422.26,511.995 512,422.25 345.744,256"></polygon>
								</g>
							</svg>
						</button>VFS_Explorer
					</div>
				</h3>
				<div id="vfs_explorer"></div>
			</div>
			<div id="sidebar_resizer_h2"></div>
			<div id="outline_container">
				<h3>Outline</h3>
				<div id="code_outline"></div>
			</div>
		</div>
		<div id="sidebar_resizer_v"></div>
		<div id="main_content">
			<div id="tab_bar_container"></div>
			<div id="editor"></div>
			<div id="plot_container"></div>
			<div id="preview_container">
				<iframe
					id="preview_frame"
					sandbox="allow-scripts allow-forms allow-modals allow-popups allow-presentation"
					allow="serial; file-system-write; clipboard-read; clipboard-write;"
					style="width: 100%; height: 100%; border: none; background-color: white;">
				</iframe>
			</div>
            <div id="spreadsheet_container"></div>
			<div id="footer_resizer_h"></div>
			<footer>
				<div id="footer_area_container">
					<textarea id="py_result_area" name="py_result_area">&lt;/textarea&gt;
					<div id="output_resizer_v"></div>
					<textarea id="js_result_area" name="js_result_area">&lt;/textarea&gt;
					<div id="output_resizer_v2"></div>
					<div id="extension_area"></div>
				</div>
			</footer>
		</div>
    </div>

<!-- ================================================================================================== -->

    <script id="script_global_variables">
        /* #################### â†“â†“â†“ script_global_variables â†“â†“â†“ #################### */
        // --------------- ### global_variables
        var pyodide_js;
        let js_map_global_data = new Map();
        let js_obj_global_data = {};
        const max_print_len = 100000;
        let editor = null;
        let file_name_val = null;
        let interrupt_buffer = null;
        let stop_watchdog_timer = null; // å¼·åˆ¶åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ã®IDç®¡ç†ç”¨
        let agent_run_flag = false; // AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒæŒ‡ç¤ºã‹ã©ã†ã‹

        // --------------- ### editor_element
        const editor_element = document.getElementById("editor");
        const preview_container_element = document.getElementById("preview_container");
        const preview_frame_element = document.getElementById("preview_frame");
        const plot_container_element = document.getElementById("plot_container");
        const spreadsheet_container_element = document.getElementById("spreadsheet_container");
        const tab_bar_element = document.getElementById("tab_bar_container");
        // --------------- ### footer_element
        const footer_area_container_element = document.getElementById("footer_area_container"); // (py_result_area & js_result_area & extension_area)
        const py_result_area_element = document.getElementById("py_result_area");
        const js_result_area_element = document.getElementById("js_result_area");
        const extension_area_element = document.getElementById("extension_area");
        // --------------- ### sidebar_element
        const sidebar_area_container_element = document.getElementById("sidebar_area_container"); // (script_exp & vfs_exp & outline)
        const script_container_element = document.getElementById("script_explorer_container");
        const vfs_container_element = document.getElementById("vfs_explorer_container");
        const outline_container_element = document.getElementById("outline_container");
        const outline_content_element = document.getElementById("code_outline");

        // --------------- ### footer_resizer_element
        const footer_resizer_h_element = document.getElementById("footer_resizer_h"); // (editor <-> footer)
        const footer_resizer_v_element = document.getElementById("output_resizer_v"); // (py_result_area <-> js_result_area)
        const footer_resizer_v2_element = document.getElementById("output_resizer_v2"); // (js_result_area <-> extension_area)
        // --------------- ### sidebar_resizer_element
        const sidebar_resizer_v_element = document.getElementById("sidebar_resizer_v"); // (sidebar <-> (editor & footer))
        const sidebar_resizer_h_element = document.getElementById("sidebar_resizer_h"); // (Script_Explorer <-> VFS_Explorer)
        const sidebar_resizer_h2_element = document.getElementById("sidebar_resizer_h2"); // (VFS_Explorer <-> outline)

        // --------------- ### sidebar_button_element
        const script_mount_button = document.getElementById("script_mount");
        const script_upload_button = document.getElementById("script_upload");
        const refresh_script_button = document.getElementById("refresh_script_explorer");
        const vfs_upload_button = document.getElementById("vfs_upload");
        const refresh_vfs_button = document.getElementById("refresh_vfs_explorer");
        const reset_vfs_button = document.getElementById("reset_vfs_explorer");

        // --------------- ### tree_element
        const script_explorer_element = document.getElementById("script_explorer"); // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ„ãƒªãƒ¼
        const vfs_explorer_element = document.getElementById("vfs_explorer"); // VFSãƒ„ãƒªãƒ¼

        // --------------- ### tab_system_variables
        let tabs_data = {}; // ã‚¿ãƒ–æƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ { tab_id: { model: ..., name: ... } }
        let active_tab_id = null; // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ID
        let tab_counter = 0; // ä¸€æ„ãªIDç”Ÿæˆç”¨
        let tab_plus_button_element = null; // ã‚¿ãƒ–è¿½åŠ ãƒœã‚¿ãƒ³ã®è¦ç´ ã‚’ä¿æŒ
        let dragging_tab_element = null; // ç¾åœ¨ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¿ãƒ–è¦ç´ 
        let spreadsheet_instances = {}; // CSVã‚¿ãƒ–ã”ã¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ

        // --------------- ### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ãƒã‚¦ãƒ³ãƒˆé–¢é€£
        let mounted_dir_handle = null; // ç¾åœ¨ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹DirectoryHandle
        let is_mounted = false; // ãƒã‚¦ãƒ³ãƒˆçŠ¶æ…‹ã‚’è¿½è·¡
        const MOUNT_PATH = "/mnt/vfs_root"; // Pyodideã®VFSå†…ã§ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãƒ‘ã‚¹

        // --------------- ### é€šä¿¡ãƒ–ãƒªãƒƒã‚¸ç”¨å¤‰æ•°
        const pending_host_requests = {}; // å¿œç­”å¾…ã¡ã®Promiseã‚’ç®¡ç† { req_id: {resolve, reject} }

        // --------------- ### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹Pythonã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        let py_message_callback = null;
        // Pythonå´ã‹ã‚‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã®é–¢æ•°
        function js_register_python_callback(callback) {
            py_message_callback = callback;
            console.log("Python callback registered.")
            js_result_area.value = "Python callback registered.";
        }

        /* #################### â†‘â†‘â†‘ script_global_variables â†‘â†‘â†‘ #################### */
    </script>

<!-- ================================================================================================== -->

    <script id="script_initial_code">
        /* #################### â†“â†“â†“ script_initial_code â†“â†“â†“ #################### */

        let initial_code = `<?= web_initial_code ?>`;

        if (initial_code.includes("web_initial_code")) {

            initial_code = `
# Sample
# ========== import ==========
import js
import micropip
import asyncio

# ========== def ==========
async def main_async_def():
	print("# å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«_é–‹å§‹ #")
	await micropip.install("numpy")
	print("# å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«_çµ‚äº† #")
	import numpy as np

	a = 0
	for i in range(1000):
		r = np.random.randint(1, 9)
		a = a + r
		if i % 200 == 0:
		    print(a)
	print("# TEST_COMPLETE #")

# ========== Main ==========
# Python ã‹ã‚‰ JavaScript ã®å¤‰æ•°ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
if "JsProxy" in str(type(js_map_global_data)):
	js_map_global_data = js_map_global_data.to_py()

await main_async_def()
`;
        }

        /* #################### â†‘â†‘â†‘ script_initial_code â†‘â†‘â†‘ #################### */
    </script>

<!-- ================================================================================================== -->

<!-- ================================================================================================== -->

    <script id="script_js_call_by_pyodide">
        /* #################### â†“â†“â†“ script_js_call_by_pyodide â†“â†“â†“ #################### */

        //------------------------------------------------------------------------ ### post_message (ide_frame_to_host_frame) é€ä¿¡ ###
        function js_post_message(cmd, target = "host", origin = "*", obj = {}, args = []) {
            return new Promise((resolve, reject) => {
                console.log("# called_js_post_message :", cmd)

                if (target == "host") { // host_frame ã« post_message
                    const req_id = "req_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9); // ä¸€æ„ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ç”Ÿæˆ
                    if (cmd == "fetch_post" || cmd == "serial_write") { // å¿œç­”å¾…ã¡ãƒªã‚¹ãƒˆã«ç™»éŒ²
                        pending_host_requests[req_id] = { resolve, reject };
                    }
                    // host_frameã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
                    post_message_data = { "cmd": cmd, "req_id": req_id, "obj": obj, "args": args }
                    window.parent.postMessage(post_message_data, origin);

                } else if (target == "preview") { // preview_frame ã« post_message
                    const frame = document.getElementById("preview_frame");
                    if (frame && frame.contentWindow) {
                        // ãƒ‡ãƒ¼ã‚¿ã¯JSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                        // "*" æŒ‡å®šã«ã‚ˆã‚Šã€ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚ŒãŸ(null originã®)iframeã«ã‚‚é€ä¿¡å¯èƒ½
                        frame.contentWindow.postMessage(obj, origin);
                        // console.log("Sent to preview:", obj);
                        js_result_area.value = JSON.stringify(obj, null, 2);
                    }
                }
            });
        }

        //------------------------------------------------------------------------ ### js_injector ###
        // JavaScriptã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ <script> ã‚¿ã‚°ã¨ã—ã¦å‹•çš„ã«æŒ¿å…¥ãƒ»å®Ÿè¡Œ
        // Web Serial API ç­‰ã€å‹•çš„ã«æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã„å ´åˆã«æœ‰åŠ¹
        // é‡å¿ƒçš„ã ãŒã€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸è‡ªä½“ã‚’æ”¹å¤‰ã™ã‚‹å±é™ºãªæ©Ÿèƒ½ã§ã‚‚ã‚ã‚‹
        //*
        function js_inject_script(code_str) {
            try {
                if (dev_flag === true) {
                    const script = document.createElement("script");
                    script.textContent = code_str;
                    document.body.appendChild(script); // bodyã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹ã“ã¨ã§å³æ™‚å®Ÿè¡Œã•ã‚Œã‚‹

                    console.log("Injected JS code successfully.");
                    js_result_area_element.value = "Injected JS code successfully.\n" + js_result_area_element.value;
                } else {
                    js_result_area_element.value = "é–‹ç™ºç’°å¢ƒä»¥å¤–ã§ã€Œjs_inject_script()ã€ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“";
                }
            } catch (e) {
                console.error("JS Injection Error:", e);
                js_result_area_element.value = "JS Injection Error: " + e.message + "\n" + js_result_area_element.value;
            }
        }
        //*/

        //------------------------------------------------------------------------ ### js_print ###
        function js_print(data) {
            if (py_result_area_element.value.length > max_print_len + 1000) { // ãƒãƒƒãƒ•ã‚¡ã‚’æŒãŸã›ã¦é »åº¦ã‚’ä¸‹ã’ã‚‹
                py_result_area_element.value = "[...Logs truncated...]\n" + py_result_area_element.value.substring(py_result_area_element.value.length - max_print_len);
            }
            py_result_area_element.setRangeText(data, py_result_area_element.value.length, py_result_area_element.value.length, 'end'); // æœ«å°¾ã«è¿½åŠ 
            py_result_area_element.scrollTop = py_result_area_element.scrollHeight; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        }

        //------------------------------------------------------------------------ ### js_print_clear ###
        function js_print_clear() {
            py_result_area_element.value = "";
        }

        //------------------------------------------------------------------------ ### JS_Plot_Display ###
        function js_add_plot_image_old(base64_str) { // Base64ç”»åƒã‚’å—ã‘å–ã£ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const img = document.createElement("img");
            img.src = "data:image/png;base64," + base64_str;
            extension_area_element.appendChild(img); // æ–°ã—ã„ç”»åƒã‚’å…ˆé ­ã«è¿½åŠ ã™ã‚‹ã‹æœ«å°¾ã«è¿½åŠ ã™ã‚‹ã‹ã¯ãŠå¥½ã¿ã§ï¼ˆã“ã“ã¯æœ«å°¾ã«è¿½åŠ ï¼‰

            // ãƒ¡ãƒ¢ãƒªå¯¾ç­–: ç”»åƒã®æœ€å¤§è¡¨ç¤ºæšæ•°ã‚’åˆ¶é™ã™ã‚‹ (ä¾‹: 20æš)
            const max_plots = 20;
            while (extension_area_element.children.length > max_plots) {
                // å¤ã„ç”»åƒï¼ˆæœ€åˆã®å­è¦ç´ ï¼‰ã‹ã‚‰å‰Šé™¤ã—ã¦ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾
                extension_area_element.removeChild(extension_area_element.firstChild);
            }

            extension_area_element.scrollTop = extension_area_element.scrollHeight; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            //console.log("Plot added.");
        }

        function js_clear_extension_area_old() { // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°ï¼ˆå¿…è¦ã«å¿œã˜ã¦Pythonã‹ã‚‰å‘¼ã¶ï¼‰
            extension_area_element.innerHTML = "";
        }

        //------------------------------------------------------------------------ ### JS_Plot_Display (New Tab Version) ###
        function js_add_plot_image(base64_str) {
            const PLOT_TAB_NAME = "Matplotlib_Plots";

            // 1. ãƒ—ãƒ­ãƒƒãƒˆç”¨ã‚¿ãƒ–ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            let target_tab_id = null;
            for (const id in tabs_data) {
                if (tabs_data[id].name === PLOT_TAB_NAME) {
                    target_tab_id = id;
                    break;
                }
            }

            // 2. å­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦ä½œæˆ (type="plot"ã¨ã—ã¦ä½œæˆ)
            if (!target_tab_id) {
                // ç¬¬3å¼•æ•°ã« "plot" ã‚’æ¸¡ã—ã¦å°‚ç”¨ã‚¿ãƒ–ã¨ã—ã¦é–‹ã
                open_tab(PLOT_TAB_NAME, "", "plot");

                // open_tabå†…éƒ¨ã§ active_tab_id ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã¯ãšã ãŒã€IDã‚’å–å¾—ã—ç›´ã™
                for (const id in tabs_data) {
                    if (tabs_data[id].name === PLOT_TAB_NAME) {
                        target_tab_id = id;
                        break;
                    }
                }
            }

            // 3. ãƒ—ãƒ­ãƒƒãƒˆã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            if (active_tab_id !== target_tab_id) {
                activate_tab(target_tab_id);
            }

            // 4. ç”»åƒè¦ç´ ã‚’ä½œæˆ
            const img = document.createElement("img");
            img.src = "data:image/png;base64," + base64_str;

            // 5. ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
            // activate_tab æ¸ˆã¿ãªã®ã§ plot_container_element ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å‰æ
            plot_container_element.appendChild(img);

            // 6. ãƒ¡ãƒ¢ãƒª/è¡¨ç¤ºæšæ•°åˆ¶é™ (ä¾‹: æœ€æ–°20æšã®ã¿ä¿æŒ)
            const max_plots = 20;
            while (plot_container_element.children.length > max_plots) {
                plot_container_element.removeChild(plot_container_element.firstChild);
            }

            // 7. æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            plot_container_element.scrollTop = plot_container_element.scrollHeight;

            // å¿µã®ãŸã‚ãƒ•ãƒƒã‚¿ãƒ¼ã®js_resultã«ã‚‚ãƒ­ã‚°ã‚’å‡ºã™
            // js_result_area_element.value = "Plot added to 'Matplotlib_Plots' tab.\n" + js_result_area_element.value;
        }

        // ã‚°ãƒ©ãƒ•ã‚¯ãƒªã‚¢ç”¨é–¢æ•°ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã‚’å¯¾è±¡ã«ã™ã‚‹ã‚ˆã†å¤‰æ›´
        function js_clear_plot_area() {
            if (plot_container_element) {
                plot_container_element.innerHTML = "";
            }
        }

        //------------------------------------------------------------------------ ### js_encrypt_zipper ###
        /**
         * Pyodide VFS ã®å†…å®¹ã‚’ZIPã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
         * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯æš—å·åŒ–ã€ãªã„å ´åˆã¯æ¨™æº–ZIPã¨ãªã‚Šã¾ã™ã€‚
         * PythonãŠã‚ˆã³å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸¡æ–¹ã‹ã‚‰åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
         */
        async function js_encrypt_zipper(path, save_name, pass_word, crypto_type) {

            const FORBIDDEN_EXTENSIONS = new Set([
                ".exe", ".scr", ".bat", ".cmd", ".sh", ".ps1", ".vbs",
                ".js", ".jar", ".com", ".msi", ".wsf", ".scf", ".lnk"
            ]);

            js_result_area_element.value = `Starting zip for: ${path}, Filename: ${save_name}, Pass: ${pass_word ? "Yes" : "No"}`;
            console.log(`Starting zip for: ${path}, Filename: ${save_name}, Pass: ${pass_word ? "Yes" : "No"}`);

            if (!pyodide_js || !pyodide_js.FS) {
                const msg = "Error: Pyodide FS is not initialized.";
                console.error(msg);
                js_result_area_element.value = msg;
                return;
            }
            if (typeof zip === "undefined") {
                const msg = "Error: zip.js is not loaded.";
                console.error(msg);
                js_result_area_element.value = msg;
                return;
            }

            // å±é™ºæ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
            function validate_vfs_content(vfs_path) {
                let entries;
                try {
                    entries = pyodide_js.FS.readdir(vfs_path);
                } catch (e) {
                    console.warn(`Skipping validation for ${vfs_path}: ${e.message}`);
                    return true; // èª­ã¿è¾¼ã‚ãªã„å ´æ‰€ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã¾ãŸã¯falseã§å³æ ¼ã«ã™ã‚‹ï¼‰
                }

                for (const entry of entries) {
                    if (entry === "." || entry === "..") continue;

                    const full_vfs_path = `${vfs_path}/${entry}`;
                    let stat;
                    try {
                        stat = pyodide_js.FS.stat(full_vfs_path);
                    } catch (e) { continue; }

                    if (pyodide_js.FS.isDir(stat.mode)) {
                        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã‚‰å†å¸°ãƒã‚§ãƒƒã‚¯
                        if (!validate_vfs_content(full_vfs_path)) return false;
                    } else if (pyodide_js.FS.isFile(stat.mode)) {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ãªã‚‰æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
                        // ãƒ•ã‚¡ã‚¤ãƒ«åã®æœ€å¾Œã®ãƒ‰ãƒƒãƒˆä»¥é™ã‚’å–å¾—ã—ã¦å°æ–‡å­—åŒ–
                        const dotIndex = entry.lastIndexOf(".");
                        if (dotIndex !== -1) {
                            const ext = entry.substring(dotIndex).toLowerCase();
                            if (FORBIDDEN_EXTENSIONS.has(ext)) {
                                const warning = `Security Alert: Blocked forbidden file extension "${ext}" in file: ${full_vfs_path}`;
                                console.error(warning);
                                js_result_area_element.value = warning;
                                alert(`ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã€‘\nå±é™ºãªå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ZIPä½œæˆã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚\n\næ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«: ${entry}`);
                                return false; // æ¤œçŸ¥
                            }
                        }
                    }
                }
                return true; // å•é¡Œãªã—
            }
            if (!validate_vfs_content(path)) {
                return; // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«æŠµè§¦ã—ãŸãŸã‚çµ‚äº†
            }

            let zip_writer = null;
            try {
                // 1. Writerã®æº–å‚™
                const blob_writer = new zip.BlobWriter("application/zip");
                // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã›ãšã€ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ æ™‚ã«æŒ‡å®šã™ã‚‹æ–¹å¼ã«å¤‰æ›´
                zip_writer = new zip.ZipWriter(blob_writer);

                // 2. ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ æ™‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã‚’ä½œæˆ
                const file_options = {};
                if (pass_word) {
                    file_options.password = pass_word;
                    if (crypto_type) {
                        file_options.zipCrypto = true; // Legacy ZipCrypto
                    } else {
                        file_options.encryptionStrength = 3; // AES-256
                    }
                }

                // 3. å†å¸°å‡¦ç†é–¢æ•°
                async function add_files_to_zip(vfs_path, path_in_zip) {
                    let entries;
                    try {
                        entries = pyodide_js.FS.readdir(vfs_path);
                    } catch (e) {
                        console.warn(`Skipping ${vfs_path}: ${e.message}`);
                        return;
                    }

                    for (const entry of entries) {
                        if (entry === "." || entry === "..") continue;

                        const full_vfs_path = `${vfs_path}/${entry}`;
                        const full_zip_path = path_in_zip ? `${path_in_zip}/${entry}` : entry;

                        let stat;
                        try {
                            stat = pyodide_js.FS.stat(full_vfs_path);
                        } catch (e) { continue; }

                        if (pyodide_js.FS.isDir(stat.mode)) {
                            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦
                            await zip_writer.add(full_zip_path + "/", null, { directory: true });
                            await add_files_to_zip(full_vfs_path, full_zip_path);

                        } else if (pyodide_js.FS.isFile(stat.mode)) {
                            // ãƒ•ã‚¡ã‚¤ãƒ«: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š(file_options)ã‚’é©ç”¨
                            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒnullã®å ´åˆã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¸¡ã•ã‚Œã€é€šå¸¸ZIPã«ãªã‚‹
                            const file_data = pyodide_js.FS.readFile(full_vfs_path);
                            await zip_writer.add(full_zip_path, new zip.Uint8ArrayReader(file_data), file_options);
                        }
                    }
                }

                // 4. å®Ÿè¡Œ
                await add_files_to_zip(path, "");

                // 5. çµ‚äº†ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const zip_blob = await zip_writer.close();
                zip_writer = null;
                js_download_file(zip_blob, save_name, "application/zip");

                js_result_area_element.value = `Zip created: ${save_name}`;

            } catch (err) {
                console.error("Zip Error:", err);
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`ZIPä½œæˆã‚¨ãƒ©ãƒ¼:\n${err.message}`);

            } finally {
                if (zip_writer) { // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ãªã©ã€ã¾ã é–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
                    try {
                        await zip_writer.close();
                        js_result_area_element.value = "zip_writer closed via finally block.";
                        console.log("zip_writer closed via finally block.");
                    } catch (e) {
                        js_result_area_element.value = "Error closing zip_writer in finally:" + e;
                        console.error("Error closing zip_writer in finally:", e);
                    }
                }
            }
        }

        //------------------------------------------------------------------------ ### js_decrypt_zipper_vfs ###
        /**
         * VFSä¸Šã®æš—å·åŒ–ZIPã‚’èª­ã¿è¾¼ã¿ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ãŸæ¨™æº–ZIPã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         * @param {string} input_vfs_path - VFSä¸Šã®æš—å·åŒ–ZIPã®ãƒ‘ã‚¹ (ä¾‹: "/mnt/secret.zip")
         * @param {string} output_zip_name - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å (ä¾‹: "decrypted.zip")
         * @param {string} password - è§£å‡ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
         */
        async function js_decrypt_zipper_vfs(input_vfs_path, output_zip_name, password) {
            js_result_area_element.value = `Reading ${input_vfs_path} from VFS...`;

            let zip_reader = null;
            let zip_writer = null;
            try {
                // 1. VFSã‹ã‚‰æš—å·åŒ–ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒŠãƒªã¨ã—ã¦èª­ã¿è¾¼ã‚€
                if (!pyodide_js.FS.analyzePath(input_vfs_path).exists) {
                    throw new Error(`File not found in VFS: ${input_vfs_path}`);
                }
                const file_data = pyodide_js.FS.readFile(input_vfs_path);

                // 2. èª­ã¿è¾¼ã¿ç”¨(Reader)ã¨æ›¸ãè¾¼ã¿ç”¨(Writer)ã®æº–å‚™
                // Uint8ArrayReaderã‚’ä½¿ã†ã“ã¨ã§ãƒ¡ãƒ¢ãƒªã‚³ãƒ”ãƒ¼ã‚’æœ€å°é™ã«æŠ‘ãˆã¾ã™
                zip_reader = new zip.ZipReader(new zip.Uint8ArrayReader(file_data));
                const blobWriter = new zip.BlobWriter("application/zip");
                zip_writer = new zip.ZipWriter(blobWriter); // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã—ï¼æ¨™æº–ZIP(éæš—å·åŒ–)

                // 3. ã‚¨ãƒ³ãƒˆãƒªä¸€è¦§å–å¾—
                const entries = await zip_reader.getEntries();
                js_result_area_element.value = `Decrypting ${entries.length} files...`;

                // 4. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤ å¾©å· -> å†åœ§ç¸®ï¼‰
                let count = 0;
                for (const entry of entries) {
                    if (entry.directory) {
                        await zip_writer.add(entry.filename, null, { directory: true });
                        continue;
                    }

                    // é€²æ—è¡¨ç¤ºï¼ˆé‡ã„å‡¦ç†ãªã®ã§é‡è¦ï¼‰
                    if (count % 5 === 0) {
                        js_result_area_element.value = `Processing: ${entry.filename} ...`;
                    }

                    // A. å¾©å·ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™ (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä½¿ç”¨)
                    // ã“ã“ã§å±•é–‹ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ä¸€æ™‚ãƒ¡ãƒ¢ãƒªã«ã—ã‹ä¹—ã‚Šã¾ã›ã‚“
                    const decrypted_data = await entry.getData(new zip.Uint8ArrayWriter(), {
                        password: password
                    });

                    // B. æ¨™æº–ZIPã«æ›¸ãè¾¼ã‚€ (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—)
                    await zip_writer.add(entry.filename, new zip.Uint8ArrayReader(decrypted_data));

                    count++;
                }

                // 5. çµ‚äº†å‡¦ç† & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                js_result_area_element.value = "Finalizing ZIP...";
                await zip_reader.close();
                const out_blob = await zip_writer.close();

                js_result_area_element.value = `Decrypted ZIP created. Size: ${out_blob.size}`;
                console.log(`Decrypted ZIP created. Size: ${out_blob.size}`);
                js_download_file(out_blob, output_zip_name, "application/zip");

                js_result_area_element.value = `Success! Downloaded ${output_zip_name}`;

            } catch (err) {
                js_result_area_element.value = "Decrypt Error:" + err;
                console.error("Decrypt Error:", err);
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`è§£å‡ã‚¨ãƒ©ãƒ¼: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã¾ã™ã€‚\n${err.message}`);

            } finally {
                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã§ã‚‚ç¢ºå®Ÿã« close ã™ã‚‹
                if (zip_reader) {
                    try { await zip_reader.close(); } catch (e) { }
                }
                if (zip_writer) {
                    try { await zip_writer.close(); } catch (e) { }
                }
            }
        }

        //------------------------------------------------------------------------ ### VFS_File_Download ###
        /**
         * Pyodide VFS å†…ã®å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚
         * @param {string} vfs_path - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®VFSãƒ•ãƒ«ãƒ‘ã‚¹
         */
        function js_download_vfs_file(vfs_path) {
            // Pyodideã¨FSã®åˆæœŸåŒ–ç¢ºèª
            if (!pyodide_js || !pyodide_js.FS) {
                console.error("Pyodide FS not ready.");
                return;
            }

            try {
                js_result_area_element.value = `Downloading ${vfs_path}...`;

                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ‘ã‚¹ã‹ã‚‰æŠ½å‡º
                const file_name = vfs_path.split("/").pop();

                // VFSã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒŠãƒª(Uint8Array)ã¨ã—ã¦èª­ã¿è¾¼ã‚€
                // â€» encodingã‚’æŒ‡å®šã—ãªã„ã“ã¨ã§ãƒã‚¤ãƒŠãƒªå–å¾—ã¨ãªã‚Šã€ç”»åƒã‚„zipãªã©ã‚‚ç ´æã›ãšæ‰±ãˆã¾ã™
                const file_data = pyodide_js.FS.readFile(vfs_path);

                // æ—¢å­˜ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’åˆ©ç”¨
                // MIMEã‚¿ã‚¤ãƒ—ã¯è‡ªå‹•åˆ¤åˆ¥ãŒé›£ã—ã„ãŸã‚ã€æ±ç”¨çš„ãªãƒã‚¤ãƒŠãƒªã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦æ‰±ã„ã¾ã™
                js_download_file(file_data, file_name, "application/octet-stream");

                js_result_area_element.value = `Download triggered for ${vfs_path}`;
                console.log(`Download triggered for ${vfs_path}`);

            } catch (err) {
                js_result_area_element.value = `Download Error: ${err.message}`;
                const msg = `Download Error: ${err.message}`;
                console.error(msg);
                js_result_area_element.value = msg;
                alert(msg);
            }
        }

        //------------------------------------------------------------------------ ### File_Download_Helper ###
        function js_download_file(data, filename, mime_type = "application/octet-stream") {
            let blob;
            if (data instanceof Uint8Array) {
                blob = new Blob([data], { type: mime_type });
            } else {
                // æ–‡å­—åˆ—ã¨ä»®å®š
                blob = new Blob([data], { type: mime_type });
            }

            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a); // Firefoxã§ã®äº’æ›æ€§ã®ãŸã‚
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        //------------------------------------------------------------------------ ### JS_Get_CSV_Data ###
        function js_get_csv_data(file_name) {
            // 1. æœ€å„ªå…ˆï¼šç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆè¡¨ç¤ºä¸­ï¼‰ãªã‚¿ãƒ–ãŒå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‹ãƒã‚§ãƒƒã‚¯
            if (active_tab_id && tabs_data[active_tab_id]) {
                const active_tab = tabs_data[active_tab_id];
                if (active_tab.name === file_name && active_tab.type === "spreadsheet") {
                    if (spreadsheet_instances[active_tab_id]) {
                        return spreadsheet_instances[active_tab_id].getData();
                    }
                }
            }

            // 2. æ¬¡ç‚¹ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã§ã¯ãªã„å ´åˆã€é–‹ã„ã¦ã„ã‚‹å…¨ã‚¿ãƒ–ã®ä¸­ã‹ã‚‰æ¢ã™
            for (const tab_id in tabs_data) {
                if (tabs_data[tab_id].name === file_name && tabs_data[tab_id].type === "spreadsheet") {
                    if (spreadsheet_instances[tab_id]) {
                        return spreadsheet_instances[tab_id].getData();
                    }
                }
            }

            return null; // é–‹ã‹ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–ã®ä¸­ã«è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        }

        //------------------------------------------------------------------------ ### Monacoãƒ­ãƒ¼ãƒ€ãƒ¼ ###
        function load_script(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = src;
                script.onload = () => resolve();
                script.onerror = (e) => reject(new Error(`Script load error for ${src}. Error: ${e}`));
                document.head.appendChild(script);
            });
        }

        /* #################### â†‘â†‘â†‘ script_js_call_by_pyodide â†‘â†‘â†‘ #################### */
    </script>

<!-- ================================================================================================== -->

    <script id="script_MAIN">
        /* #################### â†“â†“â†“ script_MAIN â†“â†“â†“ #################### */

        //------------------------------------------------------------------------ ### IDE_frame_post_message_æ±ç”¨å—ä¿¡ ###
        window.addEventListener("message", (event) => {
            const data = event.data;
            if (!data) return;

            // 1. host_frameã‹ã‚‰ã®éåŒæœŸå‡¦ç†å®Ÿè¡Œçµæœã®å—ä¿¡å‡¦ç†
            if (data && data.status && data.req_id && pending_host_requests[data.req_id]) {
                const { req_id, status, result, error } = data;
                const { resolve, reject } = pending_host_requests[req_id];
                // å‡¦ç†æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤
                delete pending_host_requests[req_id];
                if (status === "success") {
                    resolve(result);
                } else {
                    console.error("Async Bridge Error:", error);
                    reject(error instanceof Error ? error : new Error(String(error)));
                }
            }

            // 2. host_frameã‹ã‚‰ã®post
            if (event.source === window.parent) {

                // --------------- ### ãƒœã‚¿ãƒ³å…¥åŠ›å—ä¿¡
                if (data.cmd === "click") {
                    //console.log("# host_to_ide : button_clicked")
                    switch (data.obj.click) {
                        case "toggle_sidebar_button":
                            document.body.classList.toggle("sidebar-hidden");
                            if (editor && typeof editor.layout === "function") {
                                editor.layout();
                            }
                            break;
                        case "input_file_button":
                            input_file_button_click();
                            break;
                        case "drive_dir_button":
                            drive_dir_button_click();
                            break;
                        case "download_html_button":
                            handle_download_self_html();
                            break;
                        case "save_script_button":
                            save_file_button_click();
                            break;
                        case "stop_script_button":
                            button_STOP_click();
                            break;
                        case "run_script_button":
                            button_RUN_click();
                            break;
                    }
                }

                // --------------- ### ã‚·ãƒªã‚¢ãƒ«å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                else if (data.cmd === "serial_rx") {
                    // Pythonå´ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°å‘¼ã³å‡ºã™
                    if (typeof py_message_callback === "function") {
                        // ãƒ‡ãƒ¼ã‚¿å½¢å¼: { cmd: "serial_rx", data: Uint8Array }
                        py_message_callback(data);
                    }
                }

                // --------------- ### å¤‰æ•°ãƒ‡ãƒ¼ã‚¿å—ä¿¡
                else if (data.cmd === "var_val") {
                    //console.log("# host_to_ide : val_post")
                    const local_obj = data.obj;
                    const local_keys = Object.keys(local_obj);
                    local_keys.forEach((local_keys) => {
                        // ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¨˜æ³• [key] ã‚’ä½¿ã£ã¦å€¤ã«ã‚¢ã‚¯ã‚»ã‚¹
                        const local_value = local_obj[local_keys];
                        js_obj_global_data[local_keys] = local_value;
                    });
                    if (local_keys.includes("js_result")) {
                        js_result_area_element.value = local_obj["js_result"];
                    }
                    //console.log("# js_obj_global_data :", js_obj_global_data)
                    //console.log("# js_obj_global_data[temp] :", js_obj_global_data["temp"])
                }

                // --------------- ### Agent_Run_Handler
                else if (data.cmd === "agent_run") {
                    const code = data.code;
                    if (editor && code) {
                        // ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ
                        editor.setValue(code);
                        console.log("# IDE_frame_log : agent_run : set_code")
                        // ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã§è§£æã‚’å®Ÿè¡Œ
                        analyze_python_code(code);

                        // å®Ÿè¡Œé–‹å§‹ (å®Ÿè¡Œå…ƒãŒAgentã§ã‚ã‚‹ã“ã¨ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°ãŒã‚ã‚Œã°å°šè‰¯ã„ãŒã€ä»Šå›ã¯æ—¢å­˜ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨)
                        // å®Ÿè¡Œå‰ã«çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                        js_print_clear();

                        // å®Ÿè¡Œãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’å‘¼ã³å‡ºã™
                        // button_RUN_click ã¯ async ãªã®ã§ await å¯èƒ½ã ãŒã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ãªã®ã§ãã®ã¾ã¾å‘¼ã¶
                        agent_run_flag = true;
                        console.log("# IDE_frame_log : agent_run : run_code")
                        button_RUN_click();
                    }
                }

                return; // host_frameã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†çµ‚äº†
            }

            // 3. preview_frameã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
            const preview_frame = document.getElementById("preview_frame");
            if (preview_frame && event.source === preview_frame.contentWindow) {
                // Pythonå´ã§è¨­å®šã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°(py_message_callback)ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
                if (typeof py_message_callback === "function") {
                    try {
                        py_message_callback(event.data);
                    } catch (e) {
                        console.error("Error in Python callback:", e);
                    }
                }
            }
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãæ©Ÿèƒ½
        async function input_file_button_click() {
            const [file] = e.target.files;
            if (file) {
                const reader = new FileReader();
                reader.addEventListener("load", () => {
                    update_editor_with_content(file.name, reader.result, "Input File");
                });
                reader.readAsText(file);
            }
        };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹æ©Ÿèƒ½
        async function save_file_button_click() {
            const content = (() => {
                if (tabs_data[active_tab_id] && tabs_data[active_tab_id].type === "spreadsheet") {
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’CSVæ–‡å­—åˆ—åŒ–ã—ã¦å–å¾—
                    const sheet_data = spreadsheet_instances[active_tab_id].getData();
                    return sheet_data.map(row => row.join(",")).join("\n");
                } else {
                    return editor.getValue();
                }
            })();
            const blob = new Blob([content], { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            const current_name = file_name_val || "python_script.py";
            a.download = current_name;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ (Ctrl + S)
        window.addEventListener("keydown", (e) => {
            // Ctrl + S ã¾ãŸã¯ Cmd + Sï¼ˆMacï¼‰
            if ((e.ctrlKey || e.metaKey) && e.key === "s") {
                e.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¿å­˜ã‚’ç„¡åŠ¹åŒ–
                const content = (() => {
                    if (tabs_data[active_tab_id] && tabs_data[active_tab_id].type === "spreadsheet") {
                        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’CSVæ–‡å­—åˆ—åŒ–ã—ã¦å–å¾—
                        const sheet_data = spreadsheet_instances[active_tab_id].getData();
                        return sheet_data.map(row => row.join(",")).join("\n");
                    } else {
                        return editor.getValue();
                    }
                })();
                const blob = new Blob([content], { type: "text/plain" });

                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);

                // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆ©ç”¨ï¼ˆãªã‘ã‚Œã° python_script.pyï¼‰
                const current_name = file_name_val || "python_script.py";
                a.download = current_name;
                a.click();

                URL.revokeObjectURL(a.href);

                js_result_area_element.value = `Saved: ${current_name}`;
            }
        });

        //------------------------------------------------------------------------ ### Loading_åˆ¶å¾¡é–¢æ•° ###
        function toggle_loading(is_loading, text = "Loading...") {
            const overlay = document.getElementById("loading_overlay");
            const msg_el = document.getElementById("loading_text");

            if (msg_el) msg_el.textContent = text;

            if (is_loading) {
                overlay.style.display = "flex";
            } else {
                overlay.style.display = "none";
            }
        }

        //------------------------------------------------------------------------ ### button_enabled_disabled ###
        const control_button_list = [
            "script_upload",
            "vfs_upload",
            "refresh_script_explorer",
            "refresh_vfs_explorer",
            "reset_vfs_explorer",
        ];

        function set_sidebar_buttons_state(enabled) {
            control_button_list.forEach(id => {
                const btn = document.getElementById(id);
                if (!btn) return;
                if (enabled) btn.removeAttribute("disabled");
                else btn.setAttribute("disabled", true);
            });
        }

        //------------------------------------------------------------------------ ### Reset_VFS_Button ###
        if (reset_vfs_button) {
            reset_vfs_button.addEventListener("click", () => {
                const ok = confirm("VFS å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
                if (!ok) return;

                try {
                    // CWD (ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª) ãŒå‰Šé™¤å¯¾è±¡ã®ä¸­ã«ã‚ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€ä¸€æ—¦ãƒ«ãƒ¼ãƒˆã«ç§»å‹•
                    try { pyodide_js.FS.chdir("/"); } catch (e) { console.warn("chdir / failed", e); }

                    // --- 1. NativeFS ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚Œã°è§£é™¤ ---
                    if (is_mounted) {
                        if (mounted_dir_handle) {
                            const prev = `${MOUNT_PATH}/${mounted_dir_handle.name}`;
                            try { pyodide_js.FS.unmount(prev); } catch (e) { }
                        }
                        try { pyodide_js.FS.unmount(MOUNT_PATH); } catch (e) { }
                        is_mounted = false;
                        mounted_dir_handle = null;
                    }
                    remove_directory_recursive_vfs(MOUNT_PATH); // --- 2. VFSã®å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ ---
                    pyodide_js.FS.mkdirTree(MOUNT_PATH); // --- 3. ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚Šç›´ã— ---

                    // å‰Šé™¤å¾Œã«Pythonå´ã®CWDã‚’å†åº¦ MOUNT_PATH ã«æˆ»ã—ã¦ãŠã
                    try {
                        pyodide_js.FS.chdir(MOUNT_PATH);
                        // Pythonå´ã® os.getcwd() ã‚‚åŒæœŸã•ã›ã‚‹ãŸã‚ã« runPython ã‚’å®Ÿè¡Œ
                        pyodide_js.runPython(`import os; os.chdir('${MOUNT_PATH}')`);
                    } catch (e) { console.warn("chdir back failed", e); }

                    refresh_vfs_explorer_view(); // --- 4. ç”»é¢ã‚’æ›´æ–° ---
                    js_result_area_element.value = "VFS was reset.";

                } catch (err) {
                    console.error("VFS Reset Error:", err);
                    alert(`VFSãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n${err.message}`);
                }
            });
        }

        //------------------------------------------------------------------------ ### Monaco_Editor_Initialization ###
        function initialize_monaco_editor() {
            // Promiseã‚’è¿”ã™ã‚ˆã†ã«ã—ã€Monacoã®æº–å‚™å®Œäº†ã‚’å¾…ã¦ã‚‹ã‚ˆã†ã«ã™ã‚‹
            return new Promise((resolve) => {

                // loader.min.jsãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã§ãªã„ã¨ "require" ã¯å®šç¾©ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€
                // ã“ã®é–¢æ•°ã® *å†…éƒ¨* ã§configã‚’è¨­å®šã—ã¾ã™ã€‚
                require.config({ paths: { "vs": "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.49.0/min/vs" } });

                // Monaco Editorã®æœ¬ä½“ï¼ˆeditor.mainï¼‰ã‚’éåŒæœŸã§èª­ã¿è¾¼ã‚€
                require(["vs/editor/editor.main"], function () {
                    // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç”Ÿæˆãƒ»åˆæœŸåŒ–ã™ã‚‹
                    editor = monaco.editor.create(editor_element, {
                        theme: "vs-dark",
                        language: "python",
                        automaticLayout: true, // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«è‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´
                    });

                    open_tab("main.py", initial_code);

                    // ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³æ›´æ–°ã¨æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹
                    let outline_timer = null;
                    editor.onDidChangeModelContent(() => {
                        clearTimeout(outline_timer);

                        // å…¥åŠ›ã‹ã‚‰ 300ms å¾Œã«ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³æ›´æ–°ã¨æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
                        outline_timer = setTimeout(() => {
                            const code = editor.getValue();
                            analyze_python_code(code);
                        }, 300);
                    });

                    // åˆå›ã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ç”Ÿæˆã¨æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
                    analyze_python_code(initial_code);

                    // ã“ã‚Œã§Monacoã®åˆæœŸåŒ–ãŒã™ã¹ã¦å®Œäº†ã—ãŸãŸã‚ã€
                    // å¾…æ©Ÿã—ã¦ã„ã‚‹ window.onload ã® await ã«å‡¦ç†ã‚’è¿”ã™
                    resolve();
                });
            });
        }

        // ------------------------------------------------------------------------ ### Create_&_Open_Tab ###
        function open_tab(file_name, content, is_preview = false) {
            // æ—¢ã«åŒã˜åå‰ã®ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèª
            for (const id in tabs_data) {
                if (tabs_data[id].name === file_name) {
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„(URL)ã‚’æ›´æ–°ã—ã¦å†è¡¨ç¤º
                    if (is_preview && tabs_data[id].type === "preview") {
                        tabs_data[id].content = content; // URLã‚’æ›´æ–°
                        activate_tab(id);
                        return;
                    }
                    activate_tab(id);
                    return;
                }
            }

            const tab_id = `tab_${tab_counter++}`;

            // Monaco Modelã®ä½œæˆ (è¨€èªã¯æ‹¡å¼µå­ã‹ã‚‰ç°¡æ˜“åˆ¤å®šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯python)
            // ã“ã‚Œã«ã‚ˆã‚Šå„ã‚¿ãƒ–ã§ Undo/Redo å±¥æ­´ãŒä¿æŒã•ã‚Œã¾ã™
            let lang = "python";
            let type = "editor"; // "editor" or "preview"

            if (is_preview === true) {
                type = "preview";
            } else if (is_preview === "plot") { // "plot" ã¨ã„ã†æ–‡å­—åˆ—ãŒæ¸¡ã•ã‚ŒãŸå ´åˆ
                type = "plot";
                lang = "text"; // ãƒ—ãƒ­ãƒƒãƒˆç”¨ãªã®ã§è¨€èªã¯é–¢ä¿‚ãªã„
            } else {
                // æ‹¡å¼µå­ã‹ã‚‰è¨€èªã‚’æ±ºå®š
                if (file_name.endsWith(".py")) lang = "python";
                else if (file_name.endsWith(".json")) lang = "json";
                else if (file_name.endsWith(".js")) lang = "javascript";
                else if (file_name.endsWith(".html")) lang = "html";
                else if (file_name.endsWith(".css")) lang = "css";
                else if (file_name.endsWith(".txt")) lang = "text/plain";
                else if (file_name.endsWith(".csv")) {
                    lang = "csv";
                    type = "spreadsheet";
                }
                else lang = "text/plain";
            }

            // Monaco Modelã®ä½œæˆ (ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿)
            let new_model = null;
            if (type === "editor") {
                if (content !== "" || file_name !== "Untitled") {
                    new_model = monaco.editor.createModel(content, lang);
                }
            }

            // ãƒ‡ãƒ¼ã‚¿æ ¼ç´
            tabs_data[tab_id] = {
                name: file_name,
                model: new_model,
                type: type, // ã‚¿ãƒ–ã®ç¨®é¡
                content: content, // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã¯BlobURLã€ã‚¨ãƒ‡ã‚£ã‚¿ã®å ´åˆã¯åˆæœŸå€¤ãªã©
                scroll_state: null
            };

            // --- DOMè¦ç´ ã®ä½œæˆ ---
            const tab_div = document.createElement("div");
            tab_div.id = tab_id;
            tab_div.className = "tab_item";
            tab_div.title = file_name; // ãƒ›ãƒãƒ¼æ™‚ã«ãƒ•ãƒ«ãƒãƒ¼ãƒ è¡¨ç¤º

            enable_tab_drag_and_drop(tab_div); // ã‚¿ãƒ–ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã‚’æœ‰åŠ¹åŒ–

            // --- ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆ ---
            tab_div.addEventListener("mousedown", (e) => {
                // ãƒŸãƒ‰ãƒ«ã‚¯ãƒªãƒƒã‚¯(1)ã§é–‰ã˜ã‚‹ã€å·¦ã‚¯ãƒªãƒƒã‚¯(0)ã§åˆ‡ã‚Šæ›¿ãˆ
                if (e.button === 1) {
                    e.preventDefault();
                    close_tab(tab_id);
                } else if (e.button === 0) {
                    activate_tab(tab_id);
                }
            });

            // --- ã‚¿ãƒ–ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ãƒ–åå¤‰æ›´ ---
            tab_div.addEventListener("dblclick", (e) => {
                e.stopPropagation(); // ã‚¯ãƒªãƒƒã‚¯ç³»ã‚¤ãƒ™ãƒ³ãƒˆã®å¹²æ¸‰é˜²æ­¢

                const old_name = tabs_data[tab_id].name;

                // æ‹¡å¼µå­ã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆ†é›¢ã™ã‚‹å‡¦ç†
                const last_dot_idx = old_name.lastIndexOf(".");
                let base_name = old_name;
                let ext_name = "";
                // ãƒ‰ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã€ã‹ã¤å…ˆé ­ã§ã¯ãªã„å ´åˆï¼ˆéš ã—ãƒ•ã‚¡ã‚¤ãƒ«ç­‰ã§ãªã„å ´åˆï¼‰
                if (last_dot_idx > 0) {
                    base_name = old_name.substring(0, last_dot_idx);
                    ext_name = old_name.substring(last_dot_idx);
                }
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯æ‹¡å¼µå­ã‚’é™¤ã„ãŸåå‰ã‚’è¡¨ç¤ºã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ‹¡å¼µå­ãŒå›ºå®šã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹
                const input_base_name = prompt(`Rename tab (extension '${ext_name}' is fixed)`, base_name);
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»ç©ºæ–‡å­—ã¯ç„¡è¦–
                if (!input_base_name) return;
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã¨å…ƒã®æ‹¡å¼µå­ã‚’çµåˆ
                const new_name = input_base_name + ext_name;

                // åŒåã¯ç„¡è¦–
                if (new_name === old_name) return;
                // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                tabs_data[tab_id].name = new_name;
                // è¡¨ç¤ºåæ›´æ–°
                const name_span = tab_div.querySelector(".tab_name");
                if (name_span) {
                    name_span.textContent = new_name;
                }

                // title å±æ€§æ›´æ–°
                tab_div.title = new_name;

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ãªã‚‰ç¾åœ¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚‚æ›´æ–°
                if (active_tab_id === tab_id) {
                    file_name_val = new_name;
                    const code = editor.getValue();
                    analyze_python_code(code);
                }
            });

            // ã‚¿ãƒ–å
            const name_span = document.createElement("span");
            name_span.className = "tab_name";
            name_span.textContent = file_name;
            tab_div.appendChild(name_span);

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            const close_btn = document.createElement("span");
            close_btn.className = "tab_close_btn";
            close_btn.textContent = "[x]";
            close_btn.addEventListener("click", (e) => {
                e.stopPropagation(); // host_frameã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’é˜²æ­¢
                close_tab(tab_id);
            });
            tab_div.appendChild(close_btn);

            if (tab_plus_button_element) {
                tab_bar_element.insertBefore(tab_div, tab_plus_button_element);
            } else {
                tab_bar_element.appendChild(tab_div);
            }

            // ä½œæˆã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            activate_tab(tab_id);
        }

        // ------------------------------------------------------------------------ ### Activate Tab ###
        function activate_tab(target_id) {
            if (!tabs_data[target_id]) return;

            active_tab_id = target_id;
            const data = tabs_data[target_id];

            // 1. ã‚¿ãƒ–ã®è¦‹ãŸç›®ã‚’æ›´æ–°ï¼ˆactiveã‚¯ãƒ©ã‚¹ã®ä»˜ã‘æ›¿ãˆï¼‰
            const all_tabs = document.querySelectorAll(".tab_item");
            all_tabs.forEach(el => el.classList.remove("active_tab"));

            const target_tab_el = document.getElementById(target_id);
            if (target_tab_el) {
                target_tab_el.classList.add("active_tab");
                target_tab_el.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }

            const old_ui = document.getElementById("lang_select_box");
            if (old_ui) old_ui.remove();

            editor_element.style.display = "none";
            preview_container_element.style.display = "none";
            plot_container_element.style.display = "none";
            spreadsheet_container_element.style.display = "none";

            // 2. Monaco Editorã®ãƒ¢ãƒ‡ãƒ«ã‚’å·®ã—æ›¿ãˆ
            if (data.type === "preview") {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰
                preview_container_element.style.display = "flex";
                // iframeã®ã‚½ãƒ¼ã‚¹ã‚’è¨­å®š (contentã«ã¯Blob URLãŒå…¥ã£ã¦ã„ã‚‹æƒ³å®š)
                preview_frame_element.src = data.content;
                file_name_val = data.name;

            } else if (data.type === "plot") {
                // --- ãƒ—ãƒ­ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ (æ–°è¦è¿½åŠ ) ---
                plot_container_element.style.display = "flex";
                file_name_val = data.name;

            } else if (data.type === "spreadsheet") {
                // --- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ (CSVç”¨) ---
                spreadsheet_container_element.style.display = "block";
                file_name_val = data.name;

                // å…¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’éè¡¨ç¤ºåŒ–
                document.querySelectorAll(".spreadsheet_instance").forEach(el => el.classList.remove("active_spreadsheet"));

                if (!spreadsheet_instances[target_id]) {
                    // åˆå›è¡¨ç¤ºæ™‚ã®ã¿ã‚³ãƒ³ãƒ†ãƒŠç”Ÿæˆã¨Jspreadsheetã®åˆæœŸåŒ–
                    const sheet_div = document.createElement("div");
                    sheet_div.id = `sheet_${target_id}`;
                    sheet_div.className = "spreadsheet_instance active_spreadsheet";
                    spreadsheet_container_element.appendChild(sheet_div);

                    // CSVæ–‡å­—åˆ—ã‚’2æ¬¡å…ƒé…åˆ—ã«ç°¡æ˜“å¤‰æ›
                    const parsed_data = data.content 
                        ? data.content.trim().split("\n").map(row => row.split(",")) 
                        : [[]];

                    spreadsheet_instances[target_id] = jspreadsheet(sheet_div, {
                        data: parsed_data,
                        minDimensions: [10, 15],
                        defaultColWidth: 100,
                        parseFormulas: false
                    });
                } else {
                    // æ—¢ã«ä½œæˆæ¸ˆã¿ã®å ´åˆã¯è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
                    const sheet_div = document.getElementById(`sheet_${target_id}`);
                    if (sheet_div) sheet_div.classList.add("active_spreadsheet");
                }

            } else {
                // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰
                editor_element.style.display = "block";

                const old_ui = document.getElementById("lang_select_overlay");
                if (old_ui) old_ui.remove();

                if (!data.model) {

                    // editor DOM ã®ç ´å£Šã‚’é¿ã‘ã‚‹ãŸã‚ overlay ã‚’ä¸Šã‹ã‚‰é‡ã­ã‚‹
                    const overlay = document.createElement("div");
                    overlay.id = "lang_select_overlay";
                    overlay.style = `
        position: absolute;
        top: 10%;
        left: 20%;
        background: #1e1e1e;
        padding: 10px;
        border: 1px solid #555;
        z-index: 50;
        display: flex;
        gap: 5px;
      `;
                    overlay.innerHTML = `
        <button data-lang="python" style="width: 45px;">.py</button>
        <button data-lang="javascript" style="width: 45px;">.js</button>
        <button data-lang="html" style="width: 45px;">.html</button>
        <button data-lang="css" style="width: 45px;">.css</button>
        <button data-lang="csv" style="width: 45px;">.csv</button>
      `;

                    // editor ã®ä¸Šã«é‡ã­ã‚‹
                    editor_element.appendChild(overlay);

                    document.querySelectorAll("#lang_select_overlay button").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const lang = btn.dataset.lang;
                            let initial_content = "";

                            if (lang === "python") {
                                initial_content = `
# Sample
# ========== import ==========
import js
import micropip
import asyncio

# ========== def ==========
async def main_async_def():
	print("# å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«_é–‹å§‹ #")
	await micropip.install("numpy")
	print("# å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«_çµ‚äº† #")
	import numpy as np

	a = 0
	for i in range(1000):
		r = np.random.randint(1, 9)
		a = a + r
		if i % 200 == 0:
		    print(a)
	print("# TEST_COMPLETE #")

# ========== Main ==========
# Python ã‹ã‚‰ JavaScript ã®å¤‰æ•°ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
if "JsProxy" in str(type(js_map_global_data)):
	js_map_global_data = js_map_global_data.to_py()

await main_async_def()
`;
                            } else if (lang === "javascript") {
                                initial_content =
                                    `
// Sample
async function setup_web_serial() {
	// ã™ã§ã«ãƒœã‚¿ãƒ³ãŒã‚ã‚‹å ´åˆã¯ä½œæˆã—ãªã„ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
	if (document.getElementById("btn_connect_serial")) {
		console.log("Serial button already exists.");
		return;
	}

	const new_btn = document.createElement("button");
	new_btn.id = "btn_connect_serial";
	new_btn.textContent = "new_btn";
	new_btn.className = "other_button_css"; // æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚¯ãƒ©ã‚¹ã‚’æµç”¨
	new_btn.style.marginTop = "10px";
	new_btn.style.height = "30px";
	new_btn.style.width = "70px";

	// ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç† (Web Serial API)
	new_btn.onclick = async () => {
		try {
            js_result_area_element.value = "clicked_new_btn..."
		} catch (e) {
            console.error("Serial Connection Failed:", e);
            alert("Serial Connection Failed: " + e);
		}
	};

	// extension_area ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã¦ã¿ã‚‹
	const extension_area = document.getElementById("extension_area");
	extension_area.appendChild(new_btn);
}

// é–¢æ•°å®šç¾©å¾Œã«å³å®Ÿè¡Œã—ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã•ã›ã‚‹
setup_web_serial();
`;
                            } else if (lang === "html") {
                                initial_content =
                                    `
<!-- Sample -->
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Sample_Page</title>
</head>
<body>
	<h1>Hello HTML</h1>
</body>
</html>
`;
                            } else if (lang === "csv") {
                                initial_content = ""; // åˆæœŸã¯ç©ºãƒ‡ãƒ¼ã‚¿
                            }

                            const new_model = monaco.editor.createModel(initial_content, lang);
                            data.model = new_model;

                            data.name = `Untitled.${lang === "python" ? "py" :
                                lang === "javascript" ? "js" :
                                    lang
                                }`;
                            file_name_val = data.name;

                            if (lang === "csv") {
                                data.type = "spreadsheet";
                                data.content = initial_content;
                            }

                            // ã‚¿ãƒ–ã®è¡¨ç¤ºå(DOM)ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†
                            const target_tab_element = document.getElementById(target_id);
                            if (target_tab_element) {
                                const name_span = target_tab_element.querySelector(".tab_name");
                                if (name_span) {
                                    name_span.textContent = data.name; // è¡¨ç¤ºåã‚’æ›´æ–° (ä¾‹: Untitled.py)
                                }
                                target_tab_element.title = data.name; // ãƒ›ãƒãƒ¼æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚‚æ›´æ–°
                            }

                            overlay.remove();

                            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãªã‚‰å†æç”»ã€ã‚¨ãƒ‡ã‚£ã‚¿ãªã‚‰æ—¢å­˜ã®å‡¦ç†
                            if (data.type === "spreadsheet") {
                                activate_tab(target_id); // å†å¸°å‘¼ã³å‡ºã—ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºå‡¦ç†ã«å›ã™
                            } else {
                                editor.setModel(new_model);
                                editor.focus();
                                editor.layout();
                                const code = editor.getValue();
                                analyze_python_code(code);
                            }
                        });
                    });

                    return;
                }

                if (editor && data.model) {
                    editor.setModel(data.model);
                    editor.focus();
                    editor.layout(); // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢
                    file_name_val = data.name;
                    const code = editor.getValue();
                    analyze_python_code(code);
                }
            }
        }

        // ------------------------------------------------------------------------ ### Close_Tab ###
        function close_tab(tab_id) {
            // Monaco Editor ã®ãƒ¢ãƒ‡ãƒ«ã‚’ç ´æ£„ï¼ˆdisposeï¼‰ã™ã‚‹
            if (tabs_data[tab_id] && tabs_data[tab_id].model) {
                // ãƒ¢ãƒ‡ãƒ«ã‚’ç ´æ£„ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ³ãƒ‰ã‚¥å±¥æ­´ã‚„å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒãƒ¡ãƒ¢ãƒªã‹ã‚‰è§£æ”¾ã•ã‚Œã¾ã™
                tabs_data[tab_id].model.dispose();
            }

            // 1. ã‚¿ãƒ–ã®DOMè¦ç´ ã‚’å‰Šé™¤
            const tab_element = document.getElementById(tab_id);
            if (tab_element) {
                tab_element.remove();
            }

            // 2. ã‚¿ãƒ–ã®å†…å®¹ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ã‚’å‰Šé™¤
            // â€» ã‚¨ãƒ‡ã‚£ã‚¿ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªä½“ã¯ãƒ¢ãƒ‡ãƒ«ç ´æ£„ã§é–“æ¥çš„ã«è§£æ”¾ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ãŒã€
            // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚‚ä¿æŒã—ã¦ã„ã‚‹å ´åˆã¯ã€editor.dispose() ã‚‚å‘¼ã³å‡ºã™ã®ãŒå®‰å…¨ã§ã™ã€‚
            // ä»Šå›ã®ã‚³ãƒ¼ãƒ‰æ§‹é€ ã§ã¯ model ã®ç ´æ£„ãŒæœ€ã‚‚é‡è¦ã§ã™ã€‚
            const editor_container = document.getElementById(`editor-container-${tab_id}`);
            if (editor_container) {
                editor_container.remove();
            }

            // 3. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‹ã‚‰æƒ…å ±ã‚’å‰Šé™¤
            delete tabs_data[tab_id];

            // 4. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç ´æ£„
            if (spreadsheet_instances[tab_id]) {
                spreadsheet_instances[tab_id].destroy();
                delete spreadsheet_instances[tab_id];
                const sheet_div = document.getElementById(`sheet_${tab_id}`);
                if (sheet_div) sheet_div.remove();
            }

            // 5. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã ã£ãŸã‚¿ãƒ–ã‚’é–‰ã˜ãŸå ´åˆã€åˆ¥ã®ã‚¿ãƒ–ã‚’é–‹ã
            if (active_tab_id === tab_id) {
                const remaining_ids = Object.keys(tabs_data);
                if (remaining_ids.length > 0) {
                    // æœ€å¾Œã®ã‚¿ãƒ–ã‚’é–‹ãï¼ˆã¾ãŸã¯éš£ã®ã‚¿ãƒ–ã‚’é–‹ããƒ­ã‚¸ãƒƒã‚¯ï¼‰
                    activate_tab(remaining_ids[remaining_ids.length - 1]);
                } else {
                    // ã‚¿ãƒ–ãŒãªããªã£ãŸå ´åˆã€æ–°è¦ã‚¿ãƒ–ã‚’ä½œæˆ
                    open_tab("Untitled", "");
                }
            }
        }

        //------------------------------------------------------------------------ ### +_Tab ###
        function setup_tab_plus_button() {
            if (tab_plus_button_element) return;
            tab_plus_button_element = document.createElement("div");
            tab_plus_button_element.className = "tab_plus_btn";
            tab_plus_button_element.textContent = "[+]";
            tab_plus_button_element.title = "New_Tab";
            tab_plus_button_element.addEventListener("click", () => { open_tab("Untitled", "") });
            tab_bar_element.appendChild(tab_plus_button_element);
        }

        // ------------------------------------------------------------------------ ### Tab_Drag_And_Drop ###
        function enable_tab_drag_and_drop(tab_element) {
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚’æœ‰åŠ¹åŒ–
            tab_element.setAttribute("draggable", true);

            // --- ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ ---
            tab_element.addEventListener("dragstart", (e) => {
                dragging_tab_element = tab_element;
                tab_element.classList.add("dragging");
                e.dataTransfer.effectAllowed = "move";
            });

            // --- ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº† ---
            tab_element.addEventListener("dragend", () => {
                dragging_tab_element = null;
                tab_element.classList.remove("dragging");
            });

            // --- ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ä»–ã‚¿ãƒ–ä¸Šã«ä¹—ã£ãŸæ™‚ ---
            tab_element.addEventListener("dragover", (e) => {
                e.preventDefault(); // dropã‚’è¨±å¯
                if (!dragging_tab_element || dragging_tab_element === tab_element) return;

                const rect = tab_element.getBoundingClientRect();
                const offset_x = e.clientX - rect.left;

                // å·¦åŠåˆ† or å³åŠåˆ†ã§æŒ¿å…¥ä½ç½®ã‚’åˆ¤æ–­
                if (offset_x < rect.width / 2) {
                    tab_bar_element.insertBefore(dragging_tab_element, tab_element);
                } else {
                    tab_bar_element.insertBefore(dragging_tab_element, tab_element.nextSibling);
                }
            });
        }

        //------------------------------------------------------------------------ ### File_Explorer_Logic ###
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’æç”»ã™ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚‚å¯¾å¿œï¼‰
        function render_file_explorer(tree, type = "drive", target_element) { // target_element å¼•æ•°ã‚’è¿½åŠ 
            target_element.innerHTML = ""; // Clear loading message
            const rootUl = create_tree_level(tree, type);
            target_element.appendChild(rootUl);
        }

        //------------------------------------------------------------------------ ### Explorer_Selection_Helper ###
        // ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼å†…ã®ã‚¢ã‚¤ãƒ†ãƒ é¸æŠçŠ¶æ…‹ï¼ˆè‰²å¤‰ãˆï¼‰ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
        function handle_explorer_item_click(target_row_element) {
            // 1. æ—¢å­˜ã®é¸æŠçŠ¶æ…‹(.selected_item)ã‚’ã™ã¹ã¦è§£é™¤
            // (script_explorer ã¨ vfs_explorer ä¸¡æ–¹ã‹ã‚‰æ¢ã—ã¦æ¶ˆã™)
            const all_selected = document.querySelectorAll(".selected_item");
            all_selected.forEach(el => el.classList.remove("selected_item"));

            // 2. ä»Šå›ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã«ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
            if (target_row_element) {
                target_row_element.classList.add("selected_item");
            }
        }

        //------------------------------------------------------------------------ ### update_editor ###
        function update_editor_with_content(file_name, content, source_desc) {
            try {
                if (!editor) throw new Error("Editor not initialized");

                open_tab(file_name, content);
                const code = editor.getValue();
                analyze_python_code(code);

                file_name_val = file_name;
                js_result_area_element.value = `${file_name} loaded successfully (${source_desc}).`;

            } catch (err) {
                console.error(`Error loading ${file_name}:`, err);
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}`);
            }
        }

        //------------------------------------------------------------------------ ### Script_Explorerã‚’æ›´æ–°ã™ã‚‹ ###
        function refresh_script_explorer_view() {
            try {
                toggle_loading(true, "Refreshing Script Tree..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹

                // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                script_explorer_element.textContent = "Use 'script_dir' to browse local scripts.";
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†

            } catch (err) {
                console.error(`Error Refreshing Script Tree:`, err);
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}`);
            }
        }

        //------------------------------------------------------------------------ ### ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢ ###
        function attach_explorer_item_events(li, row_div, item, type) { // å¼•æ•°ã« row_div ã‚’è¿½åŠ 
            // --- ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (å…±é€š) ---
            // li ã§ã¯ãªã row_div (è¡Œéƒ¨åˆ†) ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è²¼ã‚‹ã“ã¨ã§ã€å­è¦ç´ ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒ–ãƒªãƒ³ã‚°å•é¡Œã‚’å›é¿
            if (item.type === "file") {
                row_div.addEventListener("click", (e) => {
                    e.stopPropagation();
                    handle_explorer_item_click(row_div); // é¸æŠè‰²ã‚’é©ç”¨

                    if (type === "drive") load_file_content(item.id, item.name);
                    else if (type === "local") load_local_file_content_from_handle(item.handle, item.name);
                    else if (type === "local_upload") load_local_file_content_from_file(item.handle, item.name);
                    else if (type === "vfs") load_local_file_content_from_vfs(item.vfs_path, item.name);
                });
            }

            // --- VFSç‰¹æœ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— / å³ã‚¯ãƒªãƒƒã‚¯) ---
            if (type === "vfs") {
                // Drag Start (è¡Œéƒ¨åˆ†ã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹)
                row_div.setAttribute("draggable", "true");
                row_div.addEventListener("dragstart", (e) => {
                    e.stopPropagation();
                    // ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã¯é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    handle_explorer_item_click(row_div); // â˜… é¸æŠè‰²ã‚’é©ç”¨
                    e.dataTransfer.setData("application/vfs-path", item.vfs_path);
                    e.dataTransfer.effectAllowed = "move";
                });

                if (item.type === "folder") {
                    // Drop Target (ãƒ•ã‚©ãƒ«ãƒ€è¡Œã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—)
                    row_div.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        row_div.classList.add("vfs_drop_target"); // liã§ã¯ãªãrow_divã«ã‚¯ãƒ©ã‚¹ä»˜ä¸
                        e.dataTransfer.dropEffect = "move";
                    });

                    row_div.addEventListener("dragleave", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        row_div.classList.remove("vfs_drop_target");
                    });

                    row_div.addEventListener("drop", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        row_div.classList.remove("vfs_drop_target");

                        const src_path = e.dataTransfer.getData("application/vfs-path");
                        if (src_path) {
                            handle_vfs_move(src_path, item.vfs_path);
                        }
                    });

                    // Context Menu: ZIP Download (Folder)
                    row_div.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handle_explorer_item_click(row_div); // â˜… å³ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚‚é¸æŠè‰²ã‚’é©ç”¨

                        const user_pass = window.prompt(
                            `ã€Folder Downloadã€‘: ${item.name}\n\nZIPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(ç©ºæ¬„ã§éæš—å·åŒ–ZIP)`
                        );

                        if (user_pass === null) return;
                        // ... (ä»¥ä¸‹æ—¢å­˜å‡¦ç†ã¨åŒã˜) ...
                        if (user_pass === "") {
                            if (typeof js_encrypt_zipper === "function") {
                                js_encrypt_zipper(item.vfs_path, item.name + ".zip", null, false);
                            }
                        } else {
                            const use_legacy = window.confirm(`ã€æš—å·åŒ–æ–¹å¼ã€‘\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: "${user_pass}"\n[OK]: Legacy ZipCrypto\n[ã‚­ãƒ£ãƒ³ã‚»ãƒ«]: AES-256`);
                            if (typeof js_encrypt_zipper === "function") {
                                js_encrypt_zipper(item.vfs_path, item.name + ".zip", user_pass, use_legacy);
                            }
                        }
                    });
                } else if (item.type === "file") {
                    // Context Menu: File Download
                    row_div.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handle_explorer_item_click(row_div); // â˜… å³ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚‚é¸æŠè‰²ã‚’é©ç”¨

                        const do_download = window.confirm(`ã€File Downloadã€‘\n\nFile: ${item.name}\n\nãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ`);
                        if (do_download) {
                            if (typeof js_download_vfs_file === "function") {
                                js_download_vfs_file(item.vfs_path);
                            }
                        }
                    });
                }
            }
        }

        //------------------------------------------------------------------------ ### å†å¸°çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã®HTMLè¦ç´ ã‚’ç”Ÿæˆã™ã‚‹ ###
        function create_tree_level(items, type) {
            const ul = document.createElement("ul");

            items.forEach(item => {
                const li = document.createElement("li");
                // li.textContent = item.name; // â† å‰Šé™¤: liã«ç›´æ¥æ–‡å­—ã‚’å…¥ã‚Œãªã„

                // è¡Œã‚’è¡¨ã™ div ã‚’ä½œæˆã—ã€ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥ã‚Œã‚‹
                const row_div = document.createElement("div");
                row_div.classList.add("item_row");
                row_div.textContent = item.name;
                li.appendChild(row_div);

                li.classList.add("explorer-item");

                // ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸é–¢æ•°ã«ã¯ li ã¨ row_div ã®ä¸¡æ–¹ã‚’æ¸¡ã™
                attach_explorer_item_events(li, row_div, item, type);

                if (item.type === "folder") {
                    // --- ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆ ---
                    li.classList.add("folder-item", "collapsed");

                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯ row_div (è¡Œéƒ¨åˆ†) ã«å¯¾ã—ã¦è¨­å®š
                    row_div.addEventListener("click", (e) => {
                        e.stopPropagation();
                        handle_explorer_item_click(row_div); // â˜… é¸æŠè‰²ã‚’é©ç”¨

                        // è¦ªã® li ã®ã‚¯ãƒ©ã‚¹ã‚’æ“ä½œã—ã¦é–‹é–‰ã™ã‚‹
                        li.classList.toggle("expanded");
                        li.classList.toggle("collapsed");
                    });

                    if (item.children && item.children.length > 0) {
                        const childrenUl = create_tree_level(item.children, type);
                        li.appendChild(childrenUl);
                    }

                } else {
                    li.classList.add("file-item");
                    if (item.name.endsWith(".py")) {
                        li.classList.add("python-file");
                    }
                }
                ul.appendChild(li);
            });
            return ul;
        }

        //------------------------------------------------------------------------ ### ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚¦ãƒ³ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚€ ###
        async function load_local_file_content_from_handle(file_handle, file_name) {
            try {
                js_result_area_element.value = `Loading ${file_name}...`;
                file_name_val = file_name;

                const file = await file_handle.getFile();
                const content = await file.text();
                update_editor_with_content(file_name, content, "Local Handle");

            } catch (err) {
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
            }
        }

        //------------------------------------------------------------------------ ### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (File Object) ã‹ã‚‰èª­ã¿è¾¼ã‚€ ###
        async function load_local_file_content_from_file(file_object, file_name) {

            if (!file_object || typeof file_object.text !== "function") {
                js_result_area_element.value = `Error: Not a valid File object.`;
                return;
            }
            try {
                js_result_area_element.value = `Loading ${file_name}...`;
                file_name_val = file_name;

                const content = await file_object.text();

                update_editor_with_content(file_name, content, "Local File");

            } catch (err) {
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
            }
        }

        //------------------------------------------------------------------------ ### VFS (Pyodide FS) ã‹ã‚‰èª­ã¿è¾¼ã‚€ ###
        function load_local_file_content_from_vfs(vfs_path, file_name) {
            try {
                if (!pyodide_js || !pyodide_js.FS) {
                    throw new Error("Pyodide FS not available.");
                }
                js_result_area_element.value = `Loading ${file_name} from VFS...`;
                file_name_val = file_name;

                const data = pyodide_js.FS.readFile(vfs_path);
                const content = decode_auto(data);

                update_editor_with_content(file_name, content, "VFS");

            } catch (err) {
                js_result_area_element.value = `Error: ${err.message}`;
                alert(`VFSãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
                console.error(err);
            }
        }

        //------------------------------------------------------------------------ ### æ–‡å­—ã‚³ãƒ¼ãƒ‰è‡ªå‹•åˆ¤åˆ¥é–¢æ•° ###
        function decode_auto(uint8_array) {
            // 1. UTF-8 (fatal: true ã§ä¸æ­£ãƒã‚¤ãƒˆãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’åã‹ã›ã‚‹)
            try {
                const decoder = new TextDecoder("utf-8", { fatal: true });
                return decoder.decode(uint8_array);
            } catch (e) {
                console.log("Not UTF-8, trying Shift_JIS...");
            }

            // 2. Shift_JIS (CP932)
            try {
                const decoder = new TextDecoder("shift_jis", { fatal: true });
                return decoder.decode(uint8_array);
            } catch (e) {
                console.log("Not Shift_JIS, trying EUC-JP...");
            }

            // 3. EUC-JP
            try {
                const decoder = new TextDecoder("euc-jp", { fatal: true });
                return decoder.decode(uint8_array);
            } catch (e) {
                console.log("Encoding detection failed. Fallback to UTF-8.");
            }

            // 4. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (ã‚¨ãƒ©ãƒ¼ç„¡è¦–ã§ UTF-8 ã§é–‹ã)
            const decoder = new TextDecoder("utf-8", { fatal: false });
            return decoder.decode(uint8_array);
        }

        //------------------------------------------------------------------------ ### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç†
        async function handle_script_upload_click() {
            try {
                const dir_handle = await window.showDirectoryPicker();
                if (!dir_handle) return; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ
                toggle_loading(true, "Mounting Local Folder...");  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹

                const folder_name = dir_handle.name; // ä¾‹: "Data"

                // 1. æ—¢å­˜ã®ãƒã‚¦ãƒ³ãƒˆãŒã‚ã‚Œã°ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆ
                if (is_mounted) {
                    // å‰å›ãƒã‚¦ãƒ³ãƒˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ã‚’ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆ
                    if (mounted_dir_handle) {
                        const prev_mount_path = `${MOUNT_PATH}/${mounted_dir_handle.name}`;
                        try {
                            pyodide_js.FS.unmount(prev_mount_path);
                            console.log(`Unmounted: ${prev_mount_path}`);
                        } catch (e) {
                            console.warn("Unmount specific path failed:", e);
                        }
                    }

                    // å¿µã®ãŸã‚ãƒ«ãƒ¼ãƒˆã®ãƒã‚¦ãƒ³ãƒˆã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¤ã„ãƒ­ã‚¸ãƒƒã‚¯å¯¾ç­–ï¼‰
                    try {
                        pyodide_js.FS.unmount(MOUNT_PATH);
                    } catch (e) { }

                    // VFSå†…ã‚’æƒé™¤ (vfs_dirã®ä¸­èº«ã‚’ç©ºã«ã™ã‚‹)
                    // ãƒã‚¦ãƒ³ãƒˆè§£é™¤å¾Œã‚‚ç©ºãƒ•ã‚©ãƒ«ãƒ€ãŒæ®‹ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚
                    remove_directory_recursive_vfs(MOUNT_PATH);
                    pyodide_js.FS.mkdirTree(MOUNT_PATH); // ãƒ«ãƒ¼ãƒˆå†ä½œæˆ

                    is_mounted = false;
                }

                js_result_area_element.value = `Mounting local folder: ${folder_name}...`;

                // ãƒã‚¦ãƒ³ãƒˆå…ˆã‚’ "/mnt/vfs_root" ã§ã¯ãªã "/mnt/vfs_root/Data" ã«ã™ã‚‹
                const target_mount_path = `${MOUNT_PATH}/${folder_name}`;

                // ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆï¼ˆç©ºãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã‚’ä½œæˆ
                pyodide_js.FS.mkdirTree(target_mount_path);

                // NativeFSãƒã‚¦ãƒ³ãƒˆå®Ÿè¡Œ
                await pyodide_js.mountNativeFS(target_mount_path, dir_handle);

                mounted_dir_handle = dir_handle; // ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿å­˜ï¼ˆæ¬¡å›ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆç”¨ï¼‰
                is_mounted = true;

                // ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã®æç”»
                refresh_vfs_explorer_view();

                js_result_area_element.value = `Local folder "${folder_name}" mounted at ${target_mount_path}.`;

            } catch (error) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                if (error.name !== "AbortError") {
                    console.error("Error opening local folder:", error);
                    js_result_area_element.value = `Error: ${error.message}`;
                    alert(`ãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            } finally {
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
            }
        }

        //------------------------------------------------------------------------ ### ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ„ãƒªãƒ¼ç”¨ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç† (Localå°‚ç”¨, VFSãƒã‚¦ãƒ³ãƒˆãªã—)
        async function handle_open_script_folder_click() {
            try {
                const dir_handle = await window.showDirectoryPicker();
                if (!dir_handle) return; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ

                toggle_loading(true, "Loading Script Folder..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
                js_result_area_element.value = `Loading script folder: ${dir_handle.name}...`;

                // ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã®æç”» (VFSã«ã¯ãƒã‚¦ãƒ³ãƒˆã—ãªã„)
                const tree = await create_tree_from_directory(dir_handle);
                render_file_explorer(tree, "local", script_explorer_element); // "local" ã‚¿ã‚¤ãƒ—ã€æç”»å…ˆ Script

                js_result_area_element.value = `Script folder "${dir_handle.name}" loaded.`;

            } catch (error) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                if (error.name !== "AbortError") {
                    console.error("Error opening script folder:", error);
                    js_result_area_element.value = `Error: ${error.message}`;
                    alert(`ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            } finally {
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
            }
        }

        //------------------------------------------------------------------------ ### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰å†å¸°çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼æ§‹é€ ã‚’ç”Ÿæˆã™ã‚‹
        async function create_tree_from_directory(directoryHandle) {
            const tree = [];
            for await (const entry of directoryHandle.values()) {
                const item = {
                    name: entry.name,
                    handle: entry, // ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿æŒ
                };
                if (entry.kind === "directory") {
                    item.type = "folder";
                    item.children = await create_tree_from_directory(entry);
                } else {
                    item.type = "file";
                }
                tree.push(item);
            }
            // ãƒ•ã‚©ãƒ«ãƒ€ãŒå…ˆã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¾Œã«ãªã‚‹ã‚ˆã†ã«ã‚½ãƒ¼ãƒˆ
            tree.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === "folder" ? -1 : 1;
            });
            return tree;
        }

        //------------------------------------------------------------------------ ### (Pyodide VFSç”¨) ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‰Šé™¤ã™ã‚‹
        /**
         * @param {string} path - VFSå†…ã®ãƒ‘ã‚¹
         */
        function remove_directory_recursive_vfs(path) {
            let stat;
            try {
                stat = pyodide_js.FS.stat(path);
            } catch (e) {
                return; // å­˜åœ¨ã—ãªã„
            }

            if (pyodide_js.FS.isDir(stat.mode)) {
                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆ
                const entries = pyodide_js.FS.readdir(path);
                for (const entry of entries) {
                    if (entry !== "." && entry !== "..") {
                        remove_directory_recursive_vfs(`${path}/${entry}`);
                    }
                }
                pyodide_js.FS.rmdir(path); // ä¸­èº«ãŒç©ºã«ãªã£ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
            } else if (pyodide_js.FS.isFile(stat.mode)) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                pyodide_js.FS.unlink(path); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            }
        }

        //------------------------------------------------------------------------ ### ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ„ãƒªãƒ¼æ§‹ç¯‰ãƒ˜ãƒ«ãƒ‘ãƒ¼
        /**
         * @param {string} path - VFSå†…ã®ç›¸å¯¾ãƒ‘ã‚¹ (ä¾‹: "sub/data.txt")
         * @param {Array} tree - æ§‹ç¯‰ä¸­ã®ãƒ„ãƒªãƒ¼é…åˆ— (ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«)
         * @param {Object} handle_map - ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€è­˜åˆ¥ã®ãŸã‚ã®ä»®ãƒãƒƒãƒ—
         * @param {File} file_object - å…ƒã®Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã®ã¿)
         */
        function add_path_to_tree_vfs(path, tree, handle_map, file_object) {
            if (!path) return; // ç©ºã®ãƒ‘ã‚¹ã¯ç„¡è¦–

            const parts = path.split("/");
            let current_level = tree;
            let current_path = ""; // ãƒ„ãƒªãƒ¼æ§‹ç¯‰ç”¨ã®ä»®æƒ³ãƒ‘ã‚¹

            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                current_path = current_path ? `${current_path}/${part}` : part;

                let node = handle_map[current_path];

                if (!node) {
                    const is_file = (i === parts.length - 1);
                    node = {
                        name: part,
                        type: is_file ? "file" : "folder",
                        handle: is_file ? file_object : null, // ãƒ•ã‚¡ã‚¤ãƒ«ã¯Fileã‚ªãƒ–ã‚¸ã‚§ã€ãƒ•ã‚©ãƒ«ãƒ€ã¯null
                        children: []
                    };
                    handle_map[current_path] = node;
                    current_level.push(node);
                }

                if (node.type === "folder") {
                    current_level = node.children;
                }
            }
        }

        //------------------------------------------------------------------------ ### é¸æŠã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ„ãƒªãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function handle_upload_folder_to_script_tree(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            toggle_loading(true, "Processing Script Tree..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹

            try {
                let root_folder = files[0].webkitRelativePath.split("/")[0];
                let tree = [];
                let map = {};

                for (const file of files) {
                    const rel = file.webkitRelativePath;
                    const path = rel.substring(root_folder.length + 1);
                    if (!path) continue;
                    add_path_to_tree_vfs(path, tree, map, file);
                }

                const final_tree = [{
                    name: root_folder,
                    type: "folder",
                    children: tree,
                    handle: null
                }];

                render_file_explorer(final_tree, "local_upload", script_explorer_element);
                js_result_area_element.value = `Local Script Folder "${root_folder}" loaded.`;

            } catch (error) {
                console.error("Script Tree Load Error:", error);
                js_result_area_element.value = `Error: ${error.message}`;

            } finally {
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
                event.target.value = ""; // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«å€¤ã‚’ã‚¯ãƒªã‚¢
            }
        }

        //------------------------------------------------------------------------ ### é¸æŠã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’Pyodideã®VFSã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function handle_upload_folder_to_vfs(event) {
            const files = event.target.files;
            if (!files || files.length === 0) {
                return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã‹ã£ãŸ
            }

            toggle_loading(true, "Uploading to VFS..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹

            // ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€åã‚’ç‰¹å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã™ãŒã€ãƒ‘ã‚¹ã®é™¤å»ã¯ã—ã¾ã›ã‚“
            let root_folder_name = "";
            if (files.length > 0) {
                const first_path_parts = files[0].webkitRelativePath.split("/");
                if (first_path_parts.length > 0) {
                    root_folder_name = first_path_parts[0];
                }
            }

            // VFSã®ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆ
            const mount_point = MOUNT_PATH;
            js_result_area_element.value = `Uploading "${root_folder_name}" to VFS (${mount_point})...`;

            try {
                // æ—¢å­˜ã®ãƒã‚¦ãƒ³ãƒˆ/ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢ (vfs_dirã®ä¸­èº«ã‚’ç©ºã«ã™ã‚‹)
                if (is_mounted) {
                    try {
                        // å‰å›ãŒNativeFSãƒã‚¦ãƒ³ãƒˆã ã£ãŸå ´åˆã®ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆè©¦è¡Œ
                        // (å…·ä½“çš„ãªãƒã‚¦ãƒ³ãƒˆãƒ‘ã‚¹ãŒä¸æ˜ãªãŸã‚ã€MOUNT_PATHç›´ä¸‹ç­‰ã‚’æƒ³å®š)
                        // ä»Šå›ã®ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ã«ä¼´ã„ã€å¿µã®ãŸã‚å†å¸°å‰Šé™¤ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™
                        if (mounted_dir_handle) {
                            const prev_mount = `${MOUNT_PATH}/${mounted_dir_handle.name}`;
                            try { pyodide_js.FS.unmount(prev_mount); } catch (e) { }
                        }
                        try { pyodide_js.FS.unmount(MOUNT_PATH); } catch (e) { }
                    } catch (e_unmount) {
                        console.warn("Unmount failed (proceeding):", e_unmount.message);
                    }
                }

                // VFSã®ãƒªã‚»ãƒƒãƒˆ (vfs_dirè‡ªä½“ã‚’ä½œã‚Šç›´ã™)
                try {
                    remove_directory_recursive_vfs(mount_point);
                } catch (e) { console.log("Cleanup vfs info:", e); }

                try {
                    pyodide_js.FS.mkdirTree(mount_point);
                } catch (e) { } // æ—¢ã«å­˜åœ¨ã™ã‚Œã°OK

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’VFSã«æ›¸ãè¾¼ã‚€
                for (const file of files) {
                    // webkitRelativePath ã‚’ãã®ã¾ã¾ä½¿ã†ã“ã¨ã§ã€
                    // "Data/A.txt" ãªã‚‰ "/mnt/vfs_root/Data/A.txt" ã«é…ç½®ã•ã‚Œã¾ã™
                    const full_relative_path = file.webkitRelativePath;

                    if (!full_relative_path) continue;

                    const vfs_path = `${mount_point}/${full_relative_path}`;

                    // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«ä½œæˆ
                    const dir_name = vfs_path.substring(0, vfs_path.lastIndexOf("/"));
                    if (dir_name) {
                        pyodide_js.FS.mkdirTree(dir_name);
                    }

                    const file_buffer = await file.arrayBuffer();
                    const data = new Uint8Array(file_buffer);

                    pyodide_js.FS.writeFile(vfs_path, data);
                }

                is_mounted = true; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
                mounted_dir_handle = null; // NativeFSã§ã¯ãªã„ãŸã‚null

                refresh_vfs_explorer_view();

                js_result_area_element.value = `Folder "${root_folder_name}" uploaded to ${mount_point}.`;

            } catch (error) {
                console.error("Error uploading folder to VFS:", error);
                js_result_area_element.value = `Error: ${error.message}`;
                alert(`ãƒ•ã‚©ãƒ«ãƒ€ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);

            } finally {
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
                event.target.value = ""; // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«å€¤ã‚’ã‚¯ãƒªã‚¢
            }
        }

        //------------------------------------------------------------------------ ### Pyodide VFSã‹ã‚‰å†å¸°çš„ã«ãƒ„ãƒªãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹
        function create_tree_from_vfs(path) {
            const tree = [];
            let entries;
            try {
                const stat = pyodide_js.FS.stat(path);
                if (!pyodide_js.FS.isDir(stat.mode)) {
                    return []; // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ãªã„
                }
                entries = pyodide_js.FS.readdir(path);
            } catch (e) {
                return []; // ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„ã‹ã‚¨ãƒ©ãƒ¼
            }

            entries.forEach(entry => {
                if (entry === "." || entry === "..") return; // ã‚¹ã‚­ãƒƒãƒ—

                const full_path = `${path}/${entry}`;
                let entry_stat;
                try {
                    entry_stat = pyodide_js.FS.stat(full_path);
                } catch (e) {
                    return; // statãŒå–ã‚Œãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                const item = {
                    name: entry,
                    handle: null, // VFSå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ "handle" ã¯ç„¡ã„
                    vfs_path: full_path // VFSå†…ã®ãƒ‘ã‚¹ã‚’ä¿æŒ
                };

                if (pyodide_js.FS.isDir(entry_stat.mode)) {
                    item.type = "folder";
                    item.children = create_tree_from_vfs(full_path);
                } else {
                    item.type = "file";
                }
                tree.push(item);
            });

            // ã‚½ãƒ¼ãƒˆ
            tree.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === "folder" ? -1 : 1;
            });

            return tree;
        }

        // VFSã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’æ›´æ–°ã™ã‚‹
        function refresh_vfs_explorer_view() {
            if (!pyodide_js || !pyodide_js.FS) {
                vfs_explorer_element.textContent = "Pyodide not ready.";
                return;
            }
            vfs_explorer_element.textContent = `Scanning VFS at ${MOUNT_PATH}...`;
            const tree = create_tree_from_vfs(MOUNT_PATH);

            // VFSã® /mnt/vfs_root ã® *ä¸­èº«* ã§ã¯ãªãã€/mnt/vfs_root ãƒ•ã‚©ãƒ«ãƒ€è‡ªä½“ã‚’ãƒ„ãƒªãƒ¼ã®ãƒ«ãƒ¼ãƒˆã¨ã—ã¦è¡¨ç¤º
            const root_folder_name = MOUNT_PATH.split("/").pop() || "/mnt/vfs_root";
            const wrapper_tree = [{
                name: root_folder_name,
                type: "folder",
                children: tree,
                handle: null,
                vfs_path: MOUNT_PATH
            }];

            // æ–°ã—ã„ "vfs" ã‚¿ã‚¤ãƒ—ã§æç”»
            render_file_explorer(wrapper_tree, "vfs", vfs_explorer_element);

            if (tree.length === 0) {
                vfs_explorer_element.textContent = `VFS path ${MOUNT_PATH} is empty. Use "VFS_Upload".`;
            }
        }

        //------------------------------------------------------------------------ ### Syntax_Check_Logic ###
        // æ§‹æ–‡è§£æã¨ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’ä¸€åº¦ã«è¡Œã†é–¢æ•°
        async function analyze_python_code(code) {

            // ã‚¨ãƒ‡ã‚£ã‚¿ã®ç¾åœ¨ã®è¨€èªãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
            const model = editor.getModel();
            const language_id = model.getLanguageId(); // "python", "javascript", "html" ç­‰ãŒè¿”ã‚‹

            // Pythonã§ãªã„å ´åˆã¯è§£æã‚’è¡Œã‚ãšã€ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã¨ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦çµ‚äº†
            if (language_id !== "python") {
                render_outline([]); // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
                monaco.editor.setModelMarkers(model, "owner", []); // èµ¤ç·šã‚’ã‚¯ãƒªã‚¢
                return;
            }

            // ã‚³ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!code.trim()) {
                // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚¯ãƒªã‚¢ã¨ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢ã‚’è¡Œã£ã¦çµ‚äº†
                render_outline([]);
                monaco.editor.setModelMarkers(editor.getModel(), "owner", []);
                return;
            }

            pyodide_js.globals.set("code_js", code);

            const py_result = await pyodide_js.runPythonAsync(`
import ast, json, sys

code = code_js
result = {
	"outline": [],
	"errors": []
}

# NodeVisitorå®šç¾©ï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³æŠ½å‡ºç”¨ï¼‰
class OutlineVisitor(ast.NodeVisitor):
	def __init__(self):
		self.data = []
		self.level = 0

	def generic_visit(self, node):
		super().generic_visit(node)

	def visit_ClassDef(self, node):
		self.data.append({"type": "class", "name": node.name, "line": node.lineno, "level": self.level})
		self.level += 1
		self.generic_visit(node)
		self.level -= 1

	def visit_FunctionDef(self, node):
		if node.name != "__init__":
			self.data.append({"type": "function", "name": node.name, "line": node.lineno, "level": self.level})
			self.level += 1
			self.generic_visit(node)
			self.level -= 1

	def visit_AsyncFunctionDef(self, node):
		if node.name != "__init__":
			self.data.append({"type": "function", "name": node.name, "line": node.lineno, "level": self.level})
			self.level += 1
			self.generic_visit(node)
			self.level -= 1

try:
	# --- 1å›ã ã‘ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç† ---
	tree = ast.parse(code)

	# æˆåŠŸã—ãŸå ´åˆï¼šã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’æŠ½å‡º
	visitor = OutlineVisitor()
	visitor.visit(tree)
	result["outline"] = visitor.data

except SyntaxError as e:
	# å¤±æ•—ã—ãŸå ´åˆï¼šã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æŠ½å‡º
	err_dict = {
		"line": e.lineno,
		"col": e.offset,
		"end_line": e.end_lineno,
		"end_col": e.end_offset,
		"message": e.msg
	}
	# Noneã‚¬ãƒ¼ãƒ‰
	if err_dict["line"] is None: err_dict["line"] = 1
	if err_dict["col"] is None: err_dict["col"] = 1
	if err_dict["end_line"] is None: err_dict["end_line"] = err_dict["line"]
	if err_dict["end_col"] is None: err_dict["end_col"] = err_dict["col"] + 1

	result["errors"].append(err_dict)

except Exception:
	pass

json.dumps(result)
`);

            const data = JSON.parse(py_result);

            // --- 1. ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã®æ›´æ–°å‡¦ç† ---
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° outline_data ã‚’æ›´æ–°ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰ã—ã€æç”»é–¢æ•°ã‚’å‘¼ã¶
            // â€»ã“ã“ã§ã¯ç›´æ¥æç”»é–¢æ•°ã‚’å‘¼ã¶å½¢ã«ã—ã¦ã„ã¾ã™ã€‚æ—¢å­˜ã® update_outline ã®ä¸­èº«ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
            render_outline(data.outline);


            // --- 2. ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°å‡¦ç† ---
            const markers = data.errors.map(err => {
                return {
                    startLineNumber: err.line,
                    startColumn: err.col,
                    endLineNumber: err.end_line,
                    endColumn: err.end_col,
                    message: err.message,
                    severity: monaco.MarkerSeverity.Error
                };
            });
            monaco.editor.setModelMarkers(editor.getModel(), "owner", markers);
        }

        function render_outline(outline_list) {
            const outline_container = document.getElementById("code_outline");

            if (!outline_container) return;
            outline_container.innerHTML = "";

            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã€ã¾ãŸã¯é…åˆ—ã§ãªã„å ´åˆã¯çµ‚äº†
            if (!outline_list || !Array.isArray(outline_list)) return;

            outline_list.forEach(item => {
                // CSSã«åˆã‚ã›ã¦ div è¦ç´ ã‚’ä½œæˆ
                const div = document.createElement("div");

                // å…±é€šã‚¯ãƒ©ã‚¹
                div.classList.add("outline-item");

                // ã‚¿ã‚¤ãƒ—åˆ¥ã‚¯ãƒ©ã‚¹ã¨ã‚¢ã‚¤ã‚³ãƒ³ç­‰ã®è£…é£¾
                if (item.type === "class") {
                    div.classList.add("class-item");
                    div.textContent = `C: ${item.name}`; // Classã‚’ç¤ºã™ "C:" ã‚’ä»˜ä¸ï¼ˆãŠå¥½ã¿ã§å¤‰æ›´å¯ï¼‰
                } else {
                    div.classList.add("function-item");
                    div.textContent = `f: ${item.name}`; // Functionã‚’ç¤ºã™ "f:" ã‚’ä»˜ä¸
                }

                // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆå‡¦ç† (éšå±¤ãƒ¬ãƒ™ãƒ« * 15px)
                // function-item ã¯CSSã§æ—¢ã« padding-left: 15px ãŒã‚ã‚‹ãŸã‚ã€è¨ˆç®—ã«åŠ ç®—ã—ã¦èª¿æ•´
                const base_padding = item.type === "function" ? 15 : 0;
                div.style.paddingLeft = `${base_padding + (item.level * 15)}px`;

                // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¸ãƒ£ãƒ³ãƒ—å‹•ä½œ
                div.onclick = () => {
                    jump_to_line(item.line);
                };

                outline_container.appendChild(div);
            });
        }

        //------------------------------------------------------------------------ ### Outline_jump
        function jump_to_line(lineNumber) {
            editor.revealLineInCenter(lineNumber);
            editor.setPosition({ lineNumber: lineNumber, column: 1 });
            editor.focus();
        }

        //------------------------------------------------------------------------ ### Drag_Handler_(ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–) ###
        function attach_drag_handler(element, onDrag, onStart) {
            if (!element) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

            const startDrag = (e) => {
                // ãƒã‚¦ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆãƒ†ã‚­ã‚¹ãƒˆé¸æŠãªã©ï¼‰ã‚’ç„¡åŠ¹åŒ–
                e.preventDefault();

                let startX = e.clientX;
                let startY = e.clientY;

                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆåˆæœŸå€¤ã®å–å¾—ãªã©ã«ä½¿ç”¨ï¼‰
                if (onStart) onStart();

                // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å‡¦ç† (onMouseMove) ã‚’å®šç¾©
                const onMouseMove = (moveEvent) => {
                    const dx = moveEvent.clientX - startX;
                    const dy = moveEvent.clientY - startY;

                    // onDrag ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
                    if (onDrag) onDrag(dx, dy);
                };

                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç† (onMouseUp) ã‚’å®šç¾©
                const onMouseUp = () => {
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç¢ºå®Ÿã«å‰Šé™¤ã—ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ã
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                // ãƒªã‚¹ãƒŠãƒ¼ã‚’ document ã«è¿½åŠ ã—ã€ãƒ‰ãƒ©ãƒƒã‚°ãŒè¦ç´ å¤–ã«å‡ºã¦ã‚‚è¿½è·¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            element.addEventListener('mousedown', startDrag);
        }

        //------------------------------------------------------------------------ ### Resizer_Logic_(FIXED) ###
        function setup_resizers() {
            // 1. sidebar_area_width // (sidebar <-> (editor & footer))
            let start_sidebar_width;
            attach_drag_handler(sidebar_resizer_v_element, (dx) => {
                const new_width = start_sidebar_width + dx;
                if (new_width > 150) sidebar_area_container_element.style.width = `${new_width}px`;
            }, () => start_sidebar_width = sidebar_area_container_element.offsetWidth);

            // 2. script_explorer_height // (Script_Explorer <-> VFS_Explorer)
            let start_script_h;
            attach_drag_handler(sidebar_resizer_h_element, (dx, dy) => {
                const new_script_height = start_script_h + dy;
                const sidebar_height = sidebar_area_container_element.clientHeight;
                const new_vfs_height = sidebar_height - new_script_height - outline_container_element.offsetHeight - sidebar_resizer_h_element.offsetHeight - sidebar_resizer_h2_element.offsetHeight;
                if (new_script_height > 50 && new_vfs_height > 50) {
                    script_container_element.style.flexBasis = `${new_script_height}px`;
                    vfs_container_element.style.flexBasis = `${new_vfs_height}px`;
                }
            }, () => start_script_h = script_container_element.offsetHeight);

            // 3. VFS_explorer_height // (VFS_Explorer <-> outline)
            let start_vfs_h;
            attach_drag_handler(sidebar_resizer_h2_element, (dx, dy) => {
                const new_vfs_height = start_vfs_h + dy;
                const sidebar_height = sidebar_area_container_element.clientHeight;
                const new_outline_height = sidebar_height - new_vfs_height - script_container_element.offsetHeight - sidebar_resizer_h_element.offsetHeight - sidebar_resizer_h2_element.offsetHeight;
                if (new_vfs_height > 50 && new_outline_height > 50) {
                    vfs_container_element.style.flexBasis = `${new_vfs_height}px`;
                    outline_container_element.style.flexBasis = `${new_outline_height}px`;
                }
            }, () => start_vfs_h = vfs_container_element.offsetHeight);

            // 4. py_result_width // (py_result_area <-> js_result_area)
            let start_py_result_w;
            let start_js_result_w; // å¤‰æ•°è¿½åŠ 
            let start_plot_w;      // å¤‰æ•°è¿½åŠ 

            attach_drag_handler(footer_resizer_v_element, (dx, dy) => {
                const new_py_result_width = start_py_result_w + dx;
                const footer_width = footer_area_container_element.clientWidth;
                // å…¨ä½“å¹… - (å·¦ã‚¨ãƒªã‚¢æ–°å¹… + å³ã‚¨ãƒªã‚¢å›ºå®šå¹… + ãƒªã‚µã‚¤ã‚¶ãƒ¼åˆè¨ˆå¹…) = ä¸­å¤®ã‚¨ãƒªã‚¢æ–°å¹…
                const resizer_total_width = footer_resizer_v_element.offsetWidth + footer_resizer_v2_element.offsetWidth;
                const new_js_result_width = footer_width - new_py_result_width - start_plot_w - resizer_total_width;

                if (new_py_result_width > 50 && new_js_result_width > 50) {
                    // flex-growç­‰ã‚’ç„¡åŠ¹åŒ–ã—ã¤ã¤å¹…ã‚’æŒ‡å®š (flex: 0 0 Xpx)
                    py_result_area_element.style.flex = `0 0 ${new_py_result_width}px`;
                    js_result_area_element.style.flex = `0 0 ${new_js_result_width}px`;
                }
            }, () => {
                // onStart: ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«å…¨è¦ç´ ã®ç¾åœ¨ã®å¹…ã‚’å–å¾—ã—ã€å›ºå®šå¹…ãƒ¢ãƒ¼ãƒ‰(flex-grow:0)ã«ç§»è¡Œã•ã›ã‚‹
                start_py_result_w = py_result_area_element.offsetWidth;
                start_js_result_w = js_result_area_element.offsetWidth;
                start_plot_w = extension_area_element.offsetWidth;

                py_result_area_element.style.flex = `0 0 ${start_py_result_w}px`;
                js_result_area_element.style.flex = `0 0 ${start_js_result_w}px`;
                extension_area_element.style.flex = `0 0 ${start_plot_w}px`;
            });

            // 5. js_result_width // (js_result_area <-> extension_area)
            let start_js_result_w_2;
            let start_plot_w_2;
            let start_py_result_w_2; // å¤‰æ•°è¿½åŠ 

            attach_drag_handler(footer_resizer_v2_element, (dx, dy) => {
                const new_js_result_width = start_js_result_w_2 + dx;
                const footer_width = footer_area_container_element.clientWidth;

                // å…¨ä½“å¹… - (å·¦ã‚¨ãƒªã‚¢å›ºå®šå¹… + ä¸­å¤®ã‚¨ãƒªã‚¢æ–°å¹… + ãƒªã‚µã‚¤ã‚¶ãƒ¼åˆè¨ˆå¹…) = å³ã‚¨ãƒªã‚¢æ–°å¹…
                const resizer_total_width = footer_resizer_v_element.offsetWidth + footer_resizer_v2_element.offsetWidth;
                const new_plot_width = footer_width - start_py_result_w_2 - new_js_result_width - resizer_total_width;

                if (new_js_result_width > 50 && new_plot_width > 50) {
                    // flex-growç­‰ã‚’ç„¡åŠ¹åŒ–ã—ã¤ã¤å¹…ã‚’æŒ‡å®š
                    js_result_area_element.style.flex = `0 0 ${new_js_result_width}px`;
                    extension_area_element.style.flex = `0 0 ${new_plot_width}px`;
                }
            }, () => {
                // onStart: åŒæ§˜ã«å…¨è¦ç´ ã‚’å›ºå®šå¹…ãƒ¢ãƒ¼ãƒ‰ã¸
                start_js_result_w_2 = js_result_area_element.offsetWidth;
                start_plot_w_2 = extension_area_element.offsetWidth;
                start_py_result_w_2 = py_result_area_element.offsetWidth;

                py_result_area_element.style.flex = `0 0 ${start_py_result_w_2}px`;
                js_result_area_element.style.flex = `0 0 ${start_js_result_w_2}px`;
                extension_area_element.style.flex = `0 0 ${start_plot_w_2}px`;
            });
        }

        //------------------------------------------------------------------------ ### Footer_Resizer_Logic ###
        // footer_area_height (editor <-> footer)
        function setup_footer_resizer() {
            const footer = document.querySelector("footer");
            let start_h;
            attach_drag_handler(footer_resizer_h_element, (dx, dy) => {
                // footerã¯ä¸Šã«ä¼¸ã°ã™ã¨dyãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ãŸã‚åè»¢
                const newHeight = start_h - dy;
                if (newHeight > 50 && newHeight < window.innerHeight - 100) {
                    footer.style.height = `${newHeight}px`;
                }
            }, () => start_h = footer.offsetHeight);
        }

        //------------------------------------------------------------------------ ### Editor_Drag&Drop_Logic ###
        function setup_editor_drag_and_drop() {
            const editor_div = document.getElementById("editor");

            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
            editor_div.addEventListener("dragover", (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor_div.classList.add("editor-dragover");
                e.dataTransfer.dropEffect = "copy"; // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œã‚³ãƒ”ãƒ¼ã€è¡¨ç¤ºã«
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ã‚¦ãƒˆ
            editor_div.addEventListener("dragleave", (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor_div.classList.remove("editor-dragover");
            });

            // ãƒ‰ãƒ­ãƒƒãƒ—
            editor_div.addEventListener("drop", async (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor_div.classList.remove("editor-dragover");

                const files = e.dataTransfer.files;
                if (!files || files.length === 0) return;

                // è¤‡æ•°ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¦ã‚‚ã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«ã¯æœ€åˆã®1ã¤ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
                const file = files[0];

                // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã‚€
                try {
                    js_result_area_element.value = `Reading ${file.name}...`;
                    const text = await file.text(); // ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å–å¾—

                    update_editor_with_content(file.name, text, "DragDrop");

                } catch (err) {
                    console.error("File Read Error:", err);
                    js_result_area_element.value = "Error: Failed to read file text.";
                    alert("ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ç­‰ã¯é–‹ã‘ã¾ã›ã‚“ã€‚");
                }
            });
        }

        //------------------------------------------------------------------------ ### VFS_Drag&Drop_Logic ###
        async function scanFiles(entry, path = "") {
            const files = [];
            if (entry.isFile) {
                const file = await new Promise((resolve, reject) => entry.file(resolve, reject));
                // ãƒ•ã‚©ãƒ«ãƒ€éšå±¤ã‚’å«ã‚ãŸãƒ‘ã‚¹ã‚’ä¿æŒã•ã›ã‚‹
                Object.defineProperty(file, "local_path", { value: path + entry.name });
                files.push(file);
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise((resolve, reject) => reader.readEntries(resolve, reject));
                for (const child of entries) {
                    files.push(...await scanFiles(child, path + entry.name + "/"));
                }
            }
            return files;
        }

        async function handle_vfs_drop(event) {
            event.preventDefault();
            vfs_container_element.classList.remove("dragover"); // æ ç·šã‚’æ¶ˆã™

            const items = event.dataTransfer.items;
            if (!items) return;

            toggle_loading(true, "Processing Dropped Files..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹

            js_result_area_element.value = "Processing dropped items...";
            const mount_point = MOUNT_PATH;

            if (!pyodide_js.FS.analyzePath(mount_point).exists) {
                pyodide_js.FS.mkdirTree(mount_point);
            }

            try {
                let count = 0;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i].webkitGetAsEntry();
                    if (item) {
                        const files = await scanFiles(item);
                        for (const file of files) {
                            // scanFilesã§ä½œã£ãŸç›¸å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨
                            const vfs_path = `${mount_point}/${file.local_path}`;

                            // è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œæˆ
                            const dir = vfs_path.substring(0, vfs_path.lastIndexOf("/"));
                            if (dir && !pyodide_js.FS.analyzePath(dir).exists) {
                                pyodide_js.FS.mkdirTree(dir);
                            }

                            const buffer = await file.arrayBuffer();
                            pyodide_js.FS.writeFile(vfs_path, new Uint8Array(buffer));
                            count++;
                        }
                    }
                }
                refresh_vfs_explorer_view();
                js_result_area_element.value = `Dropped & Uploaded ${count} files.`;

            } catch (e) {
                js_result_area_element.value = `Drop Error: ${e.message}`;

            } finally {
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
            }
        }

        function setup_drag_and_drop() {
            const drop_zone = document.getElementById("vfs_explorer_container");

            drop_zone.addEventListener("dragover", (e) => {
                e.preventDefault();
                drop_zone.classList.add("dragover");
            });

            drop_zone.addEventListener("dragleave", (e) => {
                e.preventDefault();
                drop_zone.classList.remove("dragover");
            });

            // ã‚ªãƒŸãƒƒãƒˆ // drop_zone.addEventListener("drop", handle_vfs_drop);
        }

        //------------------------------------------------------------------------ ### VFS_File_mover ###
        function handle_vfs_move(src_path, dest_folder_path) {
            if (src_path === dest_folder_path) return; // è‡ªåˆ†è‡ªèº«ã¸ã®ç§»å‹•ã¯ç„¡è¦–

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
            const file_name = src_path.split("/").pop();
            const new_path = `${dest_folder_path}/${file_name}`;

            // ç§»å‹•å…ˆãŒç¾åœ¨ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã¨åŒã˜ãªã‚‰ä½•ã‚‚ã—ãªã„
            const current_dir = src_path.substring(0, src_path.lastIndexOf("/"));
            if (current_dir === dest_folder_path) return;

            try {
                // è¦ªå­é–¢ä¿‚ã®ãƒã‚§ãƒƒã‚¯ï¼ˆè¦ªã‚’å­ã®ä¸­ã«ç§»å‹•ã—ã‚ˆã†ã¨ã—ã¦ã„ãªã„ã‹ï¼‰
                const normalizedSrc = src_path.endsWith("/") ? src_path : src_path + "/";
                if (dest_folder_path.startsWith(normalizedSrc)) {
                    throw new Error("Cannot move a parent folder into its own child.");
                }

                // åå‰ã®è¡çªãƒã‚§ãƒƒã‚¯ï¼ˆä¸Šæ›¸ãç¢ºèªã€ã¾ãŸã¯ãƒªãƒãƒ¼ãƒ ï¼‰
                if (pyodide_js.FS.analyzePath(new_path).exists) {
                    if (!confirm(`"${file_name}" already exists in destination.\nOverwrite?`)) {
                        return;
                    }
                    // ä¸Šæ›¸ãã®å ´åˆã¯å…ˆã«å‰Šé™¤ãŒå¿…è¦ï¼ˆrenameã¯ä¸Šæ›¸ãå‹•ä½œãŒç’°å¢ƒã«ã‚ˆã‚‹ãŸã‚å®‰å…¨ç­–ï¼‰
                    pyodide_js.FS.unlink(new_path);
                }

                // ç§»å‹•å®Ÿè¡Œ
                pyodide_js.FS.rename(src_path, new_path);
                console.log(`Moved: ${src_path} -> ${new_path}`);

                // ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                refresh_vfs_explorer_view();

            } catch (err) {
                console.error("Move Error:", err);
                alert(`Move Failed: ${err.message}`);
            }
        }

        //------------------------------------------------------------------------ ### Pyodide_and_Execution_Logic ###
        async function main_ini() { // pyodideåˆæœŸåŒ–
            //document.querySelector("header").style.zIndex = "9998";
            pyodide_js = await loadPyodide();
            py_result_area_element.value =
                `################################################
# â˜… Pyodide ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†
# â†’ Pyodide ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã§ã™...
# monaco Editor ã®ãƒ­ãƒ¼ãƒ‰å¾…æ©Ÿ
################################################`;

            try {
                pyodide_js.FS.mkdirTree(MOUNT_PATH); // mkdir â†’ mkdirTree ã«å¤‰æ›´ (è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª "/mnt" ãŒç„¡ãã¦ã‚‚å†å¸°çš„ã«ä½œæˆã™ã‚‹ãŸã‚å®‰å…¨)
            } catch (e) {
                if (e.errno !== 20 && e.errno !== 44 && e.code !== "EEXIST") { // æ—¢å­˜ãƒ‘ã‚¹ã®å ´åˆã¯ç„¡è¦–
                    console.error("mkdirTree failed:", e);
                    // throw e; // è‡´å‘½çš„ã§ã¯ãªã„å ´åˆãŒå¤šã„ã®ã§throwã¾ã§ã¯ã—ãªã„ã€ã‚‚ã—ãã¯çŠ¶æ³ã«å¿œã˜ã¦throw
                }
            }

            await pyodide_js.loadPackage(["micropip"]); // ["numpy", "pandas", "scipy, matplotlib, requests, pyodide-http, scikit-learn, opencv-python"]
            const micropip = pyodide_js.pyimport("micropip");
            //await micropip.install("scikit-learn");
            //await micropip.install("opencv-python");

            pyodide_js.globals.set("js_map_global_data", js_map_global_data); // javascriptã®å¤‰æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_obj_global_data", js_obj_global_data); // javascriptã®å¤‰æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_print", js_print); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_print_clear", js_print_clear); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_add_plot_image", js_add_plot_image); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_clear_plot_area", js_clear_plot_area); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_download_func", js_download_file); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_encrypt_zipper", js_encrypt_zipper); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_post_message", js_post_message); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_register_python_callback", js_register_python_callback); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            pyodide_js.globals.set("js_get_csv_data", js_get_csv_data); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã—
            if (dev_flag === true) {
                pyodide_js.globals.set("js_inject_script", js_inject_script); // javascriptã®é–¢æ•°ã‚’pyodideã«å¼•ãæ¸¡ã— // JSã‚³ãƒ¼ãƒ‰æŒ¿å…¥ç”¨é–¢æ•°_é‡å¿ƒçš„ã ãŒå±é™ºãªæ©Ÿèƒ½ // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã§ãƒªã‚¹ã‚¯ã‚’è¨±å®¹å€¤ã«
            }

            await pyodide_js.runPythonAsync(`
import ast

class AutoSleepInjector(ast.NodeTransformer):
	def __init__(self):
		self.in_async = True # asyncé–¢æ•°å†…ã«ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

	# -----------------------------------------------------------------
	# é€šå¸¸ã® def (åŒæœŸé–¢æ•°) ã«å…¥ã£ãŸå ´åˆã®å‡¦ç†ã‚’è¿½åŠ 
	# ã“ã‚ŒãŒãªã„ã¨ã€asyncé–¢æ•°ã®ä¸­ã«å…¥ã‚Œå­ã§ä½œã£ãŸåŒæœŸé–¢æ•°å†…ã®printã«ã‚‚
	# awaitãŒã¤ã„ã¦ã—ã¾ã„ã€SyntaxErrorã«ãªã‚Šã¾ã™ã€‚
	# -----------------------------------------------------------------
	def visit_FunctionDef(self, node):
		# ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜
		prev_async = self.in_async
		# åŒæœŸé–¢æ•°å†…ãªã®ã§ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã‚ã™
		self.in_async = False

		self.generic_visit(node) # å­ãƒãƒ¼ãƒ‰ã‚’å†å¸°çš„ã«å‡¦ç†

		# æŠœã‘ã‚‹ã¨ãã«å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
		self.in_async = prev_async
		return node
	# -----------------------------------------------------------------

	def visit_AsyncFunctionDef(self, node):
		# asyncé–¢æ•°ã«å…¥ã£ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
		prev_async = self.in_async
		self.in_async = True
		self.generic_visit(node) # å­ãƒãƒ¼ãƒ‰ã‚’å†å¸°çš„ã«å‡¦ç†
		self.in_async = prev_async # æŠœã‘ã‚‹ã¨ãã«ãƒ•ãƒ©ã‚°ã‚’æˆ»ã™
		return node

	def visit_Expr(self, node):
		# å¼ãƒãƒ¼ãƒ‰ï¼ˆé–¢æ•°å‘¼ã³å‡ºã—ãªã©ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
		self.generic_visit(node)

		if not self.in_async:
			return node

		# print() é–¢æ•°ã®å‘¼ã³å‡ºã—åˆ¤å®š
		# (ã“ã“ã§ã® print ã¯çµ„ã¿è¾¼ã¿é–¢æ•°ã® print ã¨ã—ã¦æ‰±ã„ã¾ã™)
		if isinstance(node.value, ast.Call) and \
			isinstance(node.value.func, ast.Name) and \
			node.value.func.id == 'print':

			# æŒ¿å…¥ã™ã‚‹ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ: await asyncio.sleep(0) ã‚’æŒ¿å…¥ã™ã‚‹
			sleep_node = ast.Expr(
				value=ast.Await(
                    value=ast.Call(
                        func=ast.Attribute(
                            value=ast.Name(id='asyncio', ctx=ast.Load()),
                            attr='sleep',
                            ctx=ast.Load()
                        ),
                        args=[ast.Constant(value=0)],
                        keywords=[]
                    )
				)
			)
		
			# å…ƒã®ãƒãƒ¼ãƒ‰(print)ã¨ã‚¹ãƒªãƒ¼ãƒ—ãƒãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™
			# å®Ÿè¡Œé †åº: print(...) -> await asyncio.sleep(0)
			return [node, sleep_node]

		return node

def apply_auto_sleep(source_code):
	try:
		tree = ast.parse(source_code)
		transformer = AutoSleepInjector()
		new_tree = transformer.visit(tree)
		ast.fix_missing_locations(new_tree)
		return ast.unparse(new_tree) # æ›¸ãæ›ãˆãŸã‚³ãƒ¼ãƒ‰ã‚’æ–‡å­—åˆ—ã«æˆ»ã™
	except Exception as e:
		return f"# Parse Error: {e}"

# --- 1) Matplotlib show injection function ---
def _inject_matplotlib_show():
	import matplotlib
	import matplotlib.pyplot as plt
	import io, base64, js

	def custom_show(*args, **kwargs):
		buf = io.BytesIO()
		plt.savefig(buf, format="png")
		buf.seek(0)
		img_str = base64.b64encode(buf.read()).decode("utf-8")
		js.js_add_plot_image(img_str)
		plt.clf()

	plt.show = custom_show

# --- 2) Monkey patch micropip.install ---
import micropip
_real_install = micropip.install

async def _patched_install(pkg):
	res = await _real_install(pkg)
	# matplotlib ã‚’æ¤œçŸ¥
	if (isinstance(pkg, str) and pkg == "matplotlib") or ("matplotlib" in pkg):
		try:
			_inject_matplotlib_show()
		except Exception as e:
			print("Inject matplotlib show failed:", e)
	return res

micropip.install = _patched_install
`);

            await pyodide_js.runPythonAsync(`
import os
if os.path.exists("${MOUNT_PATH}"):
	os.chdir("${MOUNT_PATH}")
	print(f"Current Working Directory changed to: {os.getcwd()}")
`);

            // interrupt_bufferã®è¨­å®š
            // SharedArrayBuffer ãŒä½¿ãˆã‚‹ç’°å¢ƒãªã‚‰ä½¿ç”¨ã€ãªã‘ã‚Œã°é€šå¸¸ã® ArrayBuffer (ãŸã ã—é€šå¸¸ã®ArrayBufferã ã¨ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã«åŠ¹ã‹ãªã„å¯èƒ½æ€§ã‚ã‚Š)
            if (typeof SharedArrayBuffer !== "undefined") {
                interrupt_buffer = new Uint8Array(new SharedArrayBuffer(1));
            } else {
                interrupt_buffer = new Uint8Array(new ArrayBuffer(1));
            }
            pyodide_js.setInterruptBuffer(interrupt_buffer);

            //pyodide_js.globals.get("py_result", py_result); // pyodideã®å¤‰æ•°(é–¢æ•°ã‚‚å¯)ã‚’JavaScriptã‹ã‚‰å‚ç…§
        };

        //------------------------------------------------------------------------ ### RUN
        async function button_RUN_click() {

            try {
                if (!editor) return;
                const model = editor.getModel();
                let code = editor.getValue(); // ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
                const lang_id = model.getLanguageId(); // "python", "html", "javascript" ç­‰

                if (lang_id === "html") { // --- HTMLã®å ´åˆ ---
                    if (dev_flag === true) {
                        // Blobã‚’ä½œæˆã—ã¦URLåŒ–
                        const blob = new Blob([code], { type: "text/html" });
                        const url = URL.createObjectURL(blob);
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ã‚¿ãƒ–ã‚’é–‹ã (ç¬¬3å¼•æ•° true)
                        // ãƒ•ã‚¡ã‚¤ãƒ«åã¯ "Preivew_[å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å]" ã¨ã™ã‚‹
                        const preview_name = `Preview_${file_name_val}`;
                        open_tab(preview_name, url, true);
                        js_result_area_element.value = "# HTML Preview Started #";
                    } else {
                        js_result_area_element.value = "JS execution is disabled. Use HTML Preview.";
                        alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚");
                    }
                    return; // Pythonå®Ÿè¡Œå‡¦ç†ã«ã¯è¡Œã‹ãªã„

                } else if (lang_id === "javascript") { // --- JavaScriptã®å ´åˆ ---
                    if (dev_flag === true) {
                        js_inject_script(code)  // JSã‚³ãƒ¼ãƒ‰æŒ¿å…¥ç”¨é–¢æ•°_é‡å¿ƒçš„ã ãŒå±é™ºãªæ©Ÿèƒ½ // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã§ãƒªã‚¹ã‚¯ã‚’è¨±å®¹å€¤ã«
                    } else {
                        js_result_area_element.value = "JS execution is disabled. Use HTML Preview.";
                        alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç›´æ¥å®Ÿè¡Œã¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚");
                    }
                    return;

                } else if (lang_id === "python") {  // --- pythonã®å ´åˆ ---
                    if (stop_watchdog_timer) {// ã‚‚ã—å¼·åˆ¶åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ãŒå¾…æ©Ÿä¸­ãªã‚‰ã€æ–°ã—ã„å®Ÿè¡ŒãŒå§‹ã¾ã£ãŸã®ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹
                        clearTimeout(stop_watchdog_timer);
                        stop_watchdog_timer = null;
                    }
                    interrupt_buffer[0] = 0;
                    js_result_area_element.value = "# Python_Script_Running... #"; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€ŒRunningã€ã«æ›´æ–°
                    py_result_area_element.value = ""
                    toggle_loading(true, "Running Script..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
                    set_sidebar_buttons_state(false);
                    if (interrupt_buffer) interrupt_buffer[0] = 0; // å®Ÿè¡Œå‰ã«å‰²ã‚Šè¾¼ã¿ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢ (0ã«ã™ã‚‹)

                    // è‡ªå‹•sleepæ³¨å…¥å‡¦ç†
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‡¦ç†å†…å®¹ã‚’é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    console.log("Injecting asyncio.sleep(0) after print statements...")
                    js_result_area_element.value = "Injecting asyncio.sleep(0) after print statements...";

                    // Pythonå´ã®å¤‰æ›é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                    const transformer = pyodide_js.globals.get("apply_auto_sleep");
                    const transformed_code = transformer(code);
                    transformer.destroy(); // ãƒ¡ãƒ¢ãƒªè§£æ”¾

                    // å¤‰æ›ã‚¨ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å¤‰æ›ã«å¤±æ•—ã™ã‚‹ï¼‰
                    if (transformed_code.startsWith("# Parse Error")) {
                        console.warn("Auto-injection failed, running original code. Error:", transformed_code);
                        // å¤‰æ›å¤±æ•—æ™‚ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹ãŸã‚ï¼‰
                    } else {
                        // ãƒ‡ãƒãƒƒã‚°ç”¨: å¤‰æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ãŸã„å ´åˆ
                        // console.log(transformed_code);
                        code = transformed_code;
                    }

                    const stdout_redirect_code = `
import sys
import js
import asyncio

class Web_Stdout:
	def write(self, text): # é€šå¸¸ã® def (åŒæœŸãƒ¡ã‚½ãƒƒãƒ‰) ã¨ã—ã¦å®šç¾©
		js.js_print(text) # JSå´ã®åŒæœŸé–¢æ•° js_print ã‚’å‘¼ã³å‡ºã™

	def flush(self):
		pass

sys.stdout = Web_Stdout()
sys.stderr = Web_Stdout()
`;
                    // 2. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šã‚’å®Ÿè¡Œ
                    await pyodide_js.runPythonAsync(stdout_redirect_code);

                    // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’éåŒæœŸã§å®Ÿè¡Œ
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰å†…ã® print() ãŒ Web_Stdout.write() ã‚’å‘¼ã³å‡ºã—ã€
                    // PyodideãŒã“ã‚Œã‚’éåŒæœŸã¨ã—ã¦å‡¦ç†ã™ã‚‹ãŸã‚ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºãŒå®Ÿç¾ã—ã¾ã™ã€‚
                    await pyodide_js.runPythonAsync(code);

                    js_result_area_element.value = "# Python_Script_END #";

                } else {  // --- ãã®ä»–ã®å ´åˆ ---
                    js_result_area_element.value = `Run not supported for: ${lang_id}`;
                    return;
                }

            } catch (error) {

                const errStr = String(error);
                // KeyboardInterrupt (åœæ­¢ãƒœã‚¿ãƒ³) ã‹ã©ã†ã‹åˆ¤å®š
                if (errStr.includes("KeyboardInterrupt")) {
                    js_result_area_element.value = "# Script Interrupted #";
                    const msg = "\n==========\n[!] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚\n==========";
                    py_result_area_element.value += py_result_area_element.value ? "\n" + msg : msg;
                } else {
                    // é€šå¸¸ã®ã‚¨ãƒ©ãƒ¼
                    js_result_area_element.value = "# Python_Script_Error #";
                    const error_msg = "====================\n" + "Traceback (most recent call last):\n" + errStr;
                    const separator = py_result_area_element.value ? "\n\n" : "";
                    py_result_area_element.value += separator + error_msg;
                }
                py_result_area_element.scrollTop = py_result_area_element.scrollHeight;

            } finally {
                // 4. å®Ÿè¡Œã®æˆå¦ã«ã‹ã‹ã‚ã‚‰ãšã€æ¨™æº–å‡ºåŠ›(sys.stdout)ã‚’å…ƒã®çŠ¶æ…‹ (sys.__stdout__) ã«æˆ»ã™
                // æ¬¡ã®å®Ÿè¡Œã§å‡ºåŠ›ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†

                // AI_agentã‹ã‚‰å®Ÿè¡Œçµæœãƒ­ã‚°ã‚’å–å¾—ã—ã¦Hostã¸é€ä¿¡ã™ã‚‹
                if (agent_run_flag === true) {
                    js_post_message("script_complete", "host", "*", { "log": py_result_area_element.value }, []);
                    agent_run_flag = false;
                } else {
                    js_post_message("script_complete", "host", "*", {}, []);
                }

                pyodide_js.runPython("import sys; sys.stdout = sys.__stdout__");
                //if (interrupt_buffer) interrupt_buffer[0] = 0; // ãƒãƒƒãƒ•ã‚¡ã‚’å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
                set_sidebar_buttons_state(true);
                console.log("# IDE_frame_log : script_complete")
            }
        };

        //------------------------------------------------------------------------ ### STOP
        async function button_STOP_click() {
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            if (interrupt_buffer) {
                // 2 = SIGINT (KeyboardInterrupt) ã‚’ãƒãƒƒãƒ•ã‚¡ã«æ›¸ãè¾¼ã‚€
                for (let i = 0; i < 10; i++) {
                    //console.log("# stop_process_time :", i)
                    interrupt_buffer[0] = 2;
                    await sleep(50);
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                js_result_area_element.value = "# Stopping... #";
                console.log("Interrupt signal sent.");

                // 2. å¼·åˆ¶UIå¾©å¸°ã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆ
                // PyodideãŒå³åº§ã«åå¿œã—ãªã„å ´åˆã€1ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™
                if (stop_watchdog_timer) clearTimeout(stop_watchdog_timer);
                stop_watchdog_timer = setTimeout(() => {
                    const overlay = document.getElementById("loading_overlay");
                    // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã§ã‚ã‚Œã°å¼·åˆ¶è§£é™¤
                    if (overlay && overlay.style.display !== "none") {
                        console.warn("Stop watchdog triggered: Forcing UI unlock.");
                        js_result_area_element.value = "# Force Stopped #";
                        const msg = "\n==========\n[!] åœæ­¢å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸãŸã‚ã€UIãƒ­ãƒƒã‚¯ã‚’å¼·åˆ¶è§£é™¤ã—ã¾ã—ãŸã€‚\n==========";
                        if (js_result_area_element) {
                            js_result_area_element.value += msg;
                            js_result_area_element.scrollTop = js_result_area_element.scrollHeight;
                        }
                        toggle_loading(false);
                        set_sidebar_buttons_state(true);
                        js_post_message("script_complete", "host", "*", {}, []);
                    }
                    // ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†å¾Œã¯nullã«æˆ»ã™
                    stop_watchdog_timer = null;
                }, 3000);
            }
        }

        //------------------------------------------------------------------------ ### Initial_Load ###
        window.onload = async () => {

            try {
                set_sidebar_buttons_state(false);
                toggle_loading(true); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
                py_result_area_element.value =
                    `################################################
# â†’ Pyodide ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™...
# Pyodide ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾…æ©Ÿ
# monaco Editor ã®ãƒ­ãƒ¼ãƒ‰å¾…æ©Ÿ
################################################`;
                // 1. Pyodideã®åˆæœŸåŒ–ã‚’å¾…ã¡ã¾ã™
                await main_ini();
                // 2. Pyodideå®Œäº†å¾Œã€Monacoã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿ã€å¾…æ©Ÿ
                py_result_area_element.value =
                    `################################################
# â˜… Pyodide ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†
# â˜… Pyodide ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†
# â†’ monaco Editor ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™
################################################`;

                await load_script("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.49.0/min/vs/loader.min.js");
                // 3. Monacoãƒ­ãƒ¼ãƒ€ãƒ¼å®Œäº†å¾Œã€Monacoæœ¬ä½“ã®åˆæœŸåŒ–ã‚’å¾…ã¡ã¾ã™
                await initialize_monaco_editor();
                setup_tab_plus_button();
                // 3. ã™ã¹ã¦å®Œäº†ã—ã¦ã‹ã‚‰UIï¼ˆãƒªã‚µã‚¤ã‚¶ãƒ¼ãªã©ï¼‰ã‚’è¨­å®šã—ã¾ã™
                setup_resizers();
                setup_footer_resizer();
                //document.querySelector("header").style.zIndex = "9999";
                py_result_area_element.value =
                    `################################################
# â˜… å„ç¨®ãƒ­ãƒ¼ãƒ‰å®Œäº†
# â†’ [â–¶] ãƒœã‚¿ãƒ³ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™
################################################`;
                js_post_message("script_complete", "host", "*", {}, []);
                console.log("# IDE_frame_log : script_complete")
                // --------------- ### Refresh Button Logic ###
                if (refresh_script_button) {
                    refresh_script_button.addEventListener("click", (e) => {
                        e.stopPropagation(); // h3ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­¢ã‚ã‚‹
                        refresh_script_explorer_view();
                    });
                }

                if (refresh_vfs_button) {
                    refresh_vfs_button.addEventListener("click", (e) => {
                        e.stopPropagation();
                        refresh_vfs_explorer_view();
                    });
                }
                // VFS_Upload
                vfs_upload_button.addEventListener("click", () => {
                    input_vfs_folder.value = null; // é€£ç¶šé¸æŠãƒªã‚»ãƒƒãƒˆ
                    input_vfs_folder.click(); // éè¡¨ç¤ºinputèµ·å‹•
                });
                // script_mount
                script_mount_button.addEventListener("click", () => {
                    input_script_folder.value = null;
                    handle_script_upload_click();
                });
                // script_upload
                script_upload_button.addEventListener("click", () => {
                    input_script_folder.value = null;
                    input_script_folder.click();
                });
                input_script_folder.addEventListener("change", handle_upload_folder_to_script_tree);
                input_vfs_folder.addEventListener("change", handle_upload_folder_to_vfs);
                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ„ãƒªãƒ¼ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š
                refresh_script_explorer_view();

                setup_editor_drag_and_drop(); // drag_and_drop (ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç”¨)
                // VFSãƒ„ãƒªãƒ¼ã®åˆæœŸã‚¹ã‚­ãƒ£ãƒ³
                refresh_vfs_explorer_view();
                js_result_area_element.value = "All_Ready...";

            } catch (error) {
                js_result_area_element.value = `Initialization Error: ${error}`;
                console.error("Initialization failed:", error);

            } finally {
                set_sidebar_buttons_state(true);
                toggle_loading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºçµ‚äº†
            }
        }

        /* #################### â†‘â†‘â†‘ script_MAIN â†‘â†‘â†‘ #################### */
    </script>

  </body>
</html>

    </textarea>

    <!-- ################################################# â†‘â†‘â†‘ SandBoxFrame â†‘â†‘â†‘ ################################################# -->

    <script id="script_ROOT">
        /* #################### â†“â†“â†“ script_ROOT â†“â†“â†“ #################### */

        (() => {

            //------------------------------------------------------------------------ ### global_variables ###
            // --------------- ### global_variables

            const top_level_flag = (() => { // è‡ªèº«ãŒãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã€iframeå†…ã‹åˆ¤å®š
                try {
                    // è‡ªèº«(self) ã¨ æœ€ä¸Šä½(top) ãŒä¸€è‡´ã™ã‚Œã°ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«
                    return window.self === window.top;
                } catch (e) {
                    // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³åˆ¶é™ã§ window.top ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ç¢ºå®Ÿã«åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹
                    return false;
                }
            })();

            const dev_flag = (() => { // é–‹ç™ºãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã‹åˆ¤å®š
                const url_params = new URLSearchParams(window.location.search);
                return url_params.get("dev") === "true" ? true : false
            })();

            const session_token = (() => { // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
                const token_length = 32;
                const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~"; // RFC 3986 2.3. Unreserved Characters
                let result = "";
                const values = new Uint8Array(token_length);
                crypto.getRandomValues(values); // ãƒ–ãƒ©ã‚¦ã‚¶ãŠã‚ˆã³Node.jsã§åˆ©ç”¨å¯èƒ½ãªWeb Crypto APIã‚’ä½¿ç”¨
                for (let i = 0; i < token_length; i++) {
                    result += charset[values[i] % charset.length]; // æ–‡å­—ã‚»ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é¸æŠ
                }
                return result;
            })();

            console.log("# host_frame_log : top_level_flag :", top_level_flag, typeof top_level_flag);
            console.log("# host_frame_log : dev_flag :", dev_flag, typeof dev_flag);

            // --------------- ### Gemini_Window_Management
            let gemini_window = null; // Geminiã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å‚ç…§ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

            // --------------- ### custom_system_prompt
            const custom_system_prompt = `
#ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ 

##å½¹å‰²
ãƒ»ã‚ãªãŸã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒ†ã‚£ãƒƒã‚¯ã«å‹•ä½œã™ã‚‹Geminiã§ã™

##ç›®çš„
ãƒ»ã‚ãªãŸã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒ†ã‚£ãƒƒã‚¯ã«å‹•ä½œã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸ãˆãŸç›®çš„ã‚’é”æˆã—ã¦ãã ã•ã„

##è¨€èª
ãƒ»è²´æ–¹ãŒå›ç­”ã«ç”¨ã„ã‚‹è¨€èªã¯ã€Œ#ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ‚äº†ã€ä»¥é™ã«è¨˜è¿°ã•ã‚ŒãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨€èªã«åˆã‚ã›ã¦ãã ã•ã„

###ç›®çš„ã‚’é”æˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«
####Pyodideã‚’ç”¨ã„ãŸPython IDEã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ã‚ã‚Šã¾ã™
#####IDEã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã«ã¯ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€Pythonã®grobç­‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ãŒè¡Œãˆã‚‹ä»–ã€é€šå¸¸ã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã§ãã¾ã™
####ã‚ãªãŸãŒã“ã®IDEã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’æ“ä½œã™ã‚‹ç‚ºã®æ‹¡å¼µæ©Ÿèƒ½ã‚’é–‹ç™ºã—ã¦ã‚ã‚Šã¾ã™
####ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹
ãƒ»æ±ºã¾ã£ãŸjsonã®ä»•æ§˜ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æç¤ºã™ã‚Œã°ã€æ‹¡å¼µæ©Ÿèƒ½ã«ã‚ˆã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒIDEã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¸é€ä¿¡ã•ã‚Œã€å®Ÿè¡ŒçµæœãŒè¿”å´ã•ã‚Œã¾ã™
ãƒ»Pyodideã«ã¯ã€Œæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã¨ã€Œmicro pipã€ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„
ãƒ»ä¸€æ°—ã«è¤‡é›‘ãªæ¨è«–ã‚„å‡¦ç†ã‚’è¡Œã‚ãšã€ãƒã‚§ãƒ¼ãƒ³ãƒ»ã‚ªãƒ–ãƒ»ã‚½ãƒ¼ãƒˆã§æ®µéšçš„ã«å‡¦ç†ã‚’é€²ã‚ã¦ãã ã•ã„
ãƒ»ã©ã®ã‚ˆã†ãªjsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã®ã‹ã¯ã€Œ#webç‰ˆGeminiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåŒ–æ‹¡å¼µæ©Ÿèƒ½ã®ä»•æ§˜ ã€ã‚’ç¢ºèªã—ã¦ãã ã•ã„
#####éµå®ˆäº‹é …
ãƒ»æ‹¡å¼µæ©Ÿèƒ½ã«ä¾é ¼ã™ã‚‹jsonã¯ä¸€å›ã®å¿œç­”ã«å¿…ãšä¸€ã¤ã¾ã§ã§ã™

##ç›®çš„é”æˆã«å‹•ãå‰ã«
1. ã‚¿ã‚¹ã‚¯ã‚’ç­–å®šã—ã€æç¤ºã—ã¦ãã ã•ã„
2. ã€ŒVFS_search.pyã€ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã€ŒçŸ¥è­˜ã€ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚ã‚Šã¾ã™ã®ã§ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†… ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’æ¢ç´¢ã—ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ 

#å„ç¨®ã‚³ãƒãƒ³ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ 
##Geminiãƒšãƒ¼ã‚¸ã‹ã‚‰IDEãƒšãƒ¼ã‚¸ã¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œä¾é ¼jsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
    "cmd": "script_run_request",
    "script": "Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨˜è¿°"
}
##IDEãƒšãƒ¼ã‚¸ã‹ã‚‰Geminiãƒšãƒ¼ã‚¸ã¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œçµæœjsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
    "cmd": "script_result",
    "result": "å®Ÿè¡Œçµæœã‚’è¨˜è¿°"
}
##Geminiãƒšãƒ¼ã‚¸ã‹ã‚‰IDEãƒšãƒ¼ã‚¸ã¸ã®ä»£ç†è¨˜æ†¶ä¾é ¼jsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
    "cmd": "add_memory",
    "content":
        [
            {
                "key_1": "value_1"
            },
            {
                "key_2": "value_2"
            }
        ]
}
###ä»£ç†è¨˜æ†¶ã™ã‚‹å ´åˆã€ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä»£ç†è¨˜æ†¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ–°ã—ã„ã‚­ãƒ¼ã¨å€¤ã‚’è¿½åŠ ã—ã¾ã™
####é‡è¤‡ã‚­ãƒ¼ã®å ´åˆã¯å€¤ã‚’ä¸Šæ›¸ãã—ã¾ã™
###IDEãƒšãƒ¼ã‚¸ã®ä»£ç†è¨˜æ†¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã«ãªã‚Šã¾ã™
{
    "cmd": "memory",
    "content":
    [
        {
            "key_1": "value_1"
        },
        {
            "key_2": "value_2"
        }
    ]
}
##Geminiãƒšãƒ¼ã‚¸ã‹ã‚‰IDEãƒšãƒ¼ã‚¸ã¸ã®ä»£ç†è¨˜æ†¶æç¤ºä¾é ¼jsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
    "cmd": "memory_presentation"
}
##Geminiãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¤œè¨¼ä¾é ¼jsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ 
{
    "cmd": "user_verification",
    "message": "ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œè¨¼å†…å®¹"
}
##Geminiãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç›®çš„é”æˆjsonãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
{
    "cmd": "goal_achieved",
    "message": "ç›®çš„é”æˆå†…å®¹"
}
##Geminiã®å›ç­”ãŒä¸æ­£ãªå ´åˆ
ãƒ»IDEãƒšãƒ¼ã‚¸ãŒå›ç­”ã‚’è§£æã—ãŸçµæœã€è¦å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®jsonã«åˆè‡´ã™ã‚‹ã‚‚ã®ãŒç„¡ã„å ´åˆã€ã€Œä¾é ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆjsonã®æ¤œå‡ºç„¡ã—ã€å•é¡Œãªã‘ã‚Œã°æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚ ã€ã¨ã„ã†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’Geminiãƒšãƒ¼ã‚¸ã«é€ä¿¡ã—ã¾ã™

#IDEã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªè§£èª¬
##ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
###Python IDEã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ã¨Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œæ©Ÿèƒ½ã‚’æœ‰ã™ã‚‹
####ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ãªwebã‚¢ãƒ—ãƒª
####Pythonå®Ÿè¡Œç’°å¢ƒã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ã®IDEã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯sandboxå±æ€§ã‚’ä»˜ä¸ã—ãŸiframeå†…ã§å‹•ä½œï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ï¼‰
###webã‚¢ãƒ—ãƒªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã—ã¦ã®åˆ©ç”¨ã‚‚æƒ³å®š
###è¦ªwindowä¸”ã¤Geminiã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸPostMessageã‚’è§£æã—ã€æ—¢å®šã®JsonãŒæ¤œå‡ºã§ãã‚Œã°ãã‚Œã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™

#ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ‚äº†
`;

            // --------------- ### header_element
            const toggle_sidebar_button = document.getElementById("toggle_sidebar");
            const drive_dir_button = document.getElementById("drive_dir");
            const input_file_button = document.getElementById("input_script_file");
            const download_html_button = document.getElementById("download_html");
            const save_script_button = document.getElementById("save_script");
            const stop_script_button = document.getElementById("stop_script");
            const run_script_button = document.getElementById("run_script");
            const copy_token_button = document.getElementById("copy_token");
            const send_prompt_button = document.getElementById("send_prompt");
            const serial_connect_button = document.getElementById("serial_connect");
            const serial_cut_button = document.getElementById("serial_cut");
            const serial_baud_rate_element = document.getElementById("serial_baud_rate");
            const serial_data_bits_element = document.getElementById("serial_data_bits");
            const serial_parity_element = document.getElementById("serial_parity");
            const serial_stop_bits_element = document.getElementById("serial_stop_bits");

            // --------------- ### endpoint_white_list
            const ALLOWED_POST_URLS = [];

            //------------------------------------------------------------------------ ### button_enabled_disabled ###
            const control_button_list = [
                "toggle_sidebar",
                "drive_dir",
                "download_html",
                "save_script",
                "run_script",
                "send_prompt",
                "copy_token",
                "serial_function"
            ];

            function set_header_buttons_state(enabled) {
                control_button_list.forEach(id => {
                    const btn = document.getElementById(id);
                    if (!btn) return;
                    btn.style.opacity = enabled ? "0.9" : "0.5";
                    if (enabled) btn.removeAttribute("disabled");
                    else btn.setAttribute("disabled", true);
                });
            }

            function set_stop_button_state(enabled) {
                if (stop_script_button) { // stopãƒœã‚¿ãƒ³ã®ç‰¹æ®Šå‡¦ç†
                    if (enabled) {
                        stop_script_button.removeAttribute("disabled");
                        stop_script_button.style.opacity = "0.9";
                    } else {
                        stop_script_button.setAttribute("disabled", true);
                        stop_script_button.style.opacity = "0.5";
                    }
                }
            }

            if (top_level_flag === false) {
                try {
                    drive_dir_button.style.display = "none";
                    download_html_button.style.display = "none";
                    serial_connect_button.style.display = "none";
                    serial_cut_button.style.display = "none";
                    serial_baud_rate_element.style.display = "none";
                    serial_data_bits_element.style.display = "none";
                    serial_parity_element.style.display = "none";
                    serial_stop_bits_element.style.display = "none";
                } catch (e) {
                    console.error(e);
                }
            }

            set_header_buttons_state(false);
            set_stop_button_state(false);

            //------------------------------------------------------------------------ ### initiarise_sandbox ###
            const frame = document.getElementById("ide_container");
            const loader = document.getElementById("loader");
            // 1. Textareaã‹ã‚‰ç”Ÿã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾— (å¤‰æ•°å±•é–‹ãªã©ã¯ä¸€åˆ‡ç™ºç”Ÿã—ãªã„)
            const html_source_code = document.getElementById("sandbox_source").value;

            // 2. æ³¨å…¥ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°æ–‡å­—åˆ—ã‚’ä½œæˆ
            // JSON.stringifyã‚’ä½¿ã†ã“ã¨ã§ã€æ–‡å­—åˆ—ãƒ»æ•°å€¤ãƒ»é…åˆ—ãªã©ã‚’ãã®ã¾ã¾æ¸¡ã›ã¾ã™
            const injection_script = `
	<script id="host_injected_constants">
		const dev_flag = ${JSON.stringify(dev_flag)};
		console.log("# IDE_frame_log : dev_flag :", dev_flag, typeof dev_flag);
		const top_level_flag = ${JSON.stringify(top_level_flag)};
		console.log("# IDE_frame_log : top_level_flag :", top_level_flag, typeof top_level_flag);
	<\/script>
  `;

            // 3. HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã® <head> ã‚¿ã‚°ã®ç›´å¾Œã«æŒ¿å…¥ã™ã‚‹
            // replaceã‚’ä½¿ã£ã¦ã€<head> ã‚’ <head> + script ã«ç½®ãæ›ãˆã¾ã™
            const injected_html_source_code = html_source_code.replace("<head>", "<head>\n" + injection_script);

            // 4. Iframeã«æ³¨å…¥
            frame.srcdoc = injected_html_source_code;
            frame.onload = () => {
                loader.style.display = "none";
                frame.style.display = "block";
            };

            //------------------------------------------------------------------------ ### post_message_host_frame_to_ide_frame_ã‚¯ãƒªãƒƒã‚¯é€ä¿¡ ###
            toggle_sidebar_button.addEventListener("click", () => { // [â‰¡]
                frame.contentWindow.postMessage({ "cmd": "click", "req_id": 0, "obj": { "click": "toggle_sidebar_button" }, "args": [] }, "*");
            });
            drive_dir_button.addEventListener("click", () => { // [dir]
                frame.contentWindow.postMessage({ "cmd": "click", "req_id": 0, "obj": { "click": "drive_dir_button" }, "args": [] }, "*");
            });
            download_html_button.addEventListener("click", () => { // [â–¼]
                frame.contentWindow.postMessage({ "cmd": "click", "req_id": 0, "obj": { "click": "download_html_button" }, "args": [] }, "*");
            });
            save_script_button.addEventListener("click", () => { // [â‡©]
                frame.contentWindow.postMessage({ "cmd": "click", "req_id": 0, "obj": { "click": "save_script_button" }, "args": [] }, "*");
            });
            stop_script_button.addEventListener("click", () => { // [â– ]
                frame.contentWindow.postMessage({ "cmd": "click", "req_id": 0, "obj": { "click": "stop_script_button" }, "args": [] }, "*");
            });
            run_script_button.addEventListener("click", () => { // [â–¶]
                set_header_buttons_state(false);
                frame.contentWindow.postMessage({ "cmd": "click", "req_id": 0, "obj": { "click": "run_script_button" }, "args": [] }, "*");
            });

            //------------------------------------------------------------------------ ### send_prompt_button_event_listener ###
            send_prompt_button.addEventListener("click", () => { // [â—†]
                // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ç”¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                const user_input = window.prompt("Geminiã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "");

                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯ç©ºå…¥åŠ›ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (user_input === null || user_input.trim() === "") {
                    return;
                }

                // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµåˆ (ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€šã‚Šå¾Œã‚ã«æŒ¿å…¥)
                const final_prompt = custom_system_prompt + "\n\n" + "---" + "\n" + user_input;

                // 3. é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
                // cmd: "user_prompt" ã¨ã—ã¦é€ä¿¡ã—ã¾ã™ï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå´ã§ã“ã‚Œã‚’å—ã‘å–ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
                const payload = {
                    "cmd": "user_prompt",
                    "text": final_prompt
                };

                // 4. è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¾ãŸã¯æ‹¡å¼µæ©Ÿèƒ½ã¸é€ä¿¡
                let sent = false;

                // ã‚±ãƒ¼ã‚¹A: window.openã§é–‹ã‹ã‚ŒãŸå­ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å ´åˆ (ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆé€£æº)
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage(payload, "*");
                    sent = true;
                }

                // ã‚±ãƒ¼ã‚¹B: iframeã¾ãŸã¯æ‹¡å¼µæ©Ÿèƒ½ã®ä¸€éƒ¨ã¨ã—ã¦å‹•ä½œã—ã¦ã„ã‚‹å ´åˆ
                if (window.parent !== window) {
                    window.parent.postMessage(payload, "*");
                    sent = true;
                }

                if (sent) {
                    console.log("# host_frame_log : Prompt sent to Gemini.", payload);
                } else {
                    alert("é€ä¿¡å…ˆ(Gemini)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\né€£æºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            });

            //------------------------------------------------------------------------ ### copy_token_button_event_listener ###
            copy_token_button.addEventListener("click", () => {
                navigator.clipboard.writeText(session_token).then(() => { // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«æ›¸ãè¾¼ã¿
                    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ : " + session_token); // æˆåŠŸæ™‚ã®å‡¦ç†
                }).catch(err => {
                    console.error("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", err); // å¤±æ•—æ™‚ã®å‡¦ç†
                });
            });

            //------------------------------------------------------------------------ ### Web_Serial_API ###
            serial_connect_button.addEventListener("click", async () => { // con
                // ãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆã¯å¿…è¦ã«å¿œã˜ã¦UIã‹ã‚‰å–å¾—ã™ã‚‹ã‹å›ºå®šå€¤
                // ä¾‹: modbus_address_elementã®å€¤ã‚’ãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä½¿ã†ç­‰ã®é‹ç”¨ã‚‚å¯èƒ½ã§ã™ãŒã€ä¸€æ—¦å›ºå®š
                const options = {
                    baudRate: serial_baud_rate_element.value,
                    dataBits: serial_data_bits_element.value,
                    parity: serial_parity_element.value,
                    stopBits: serial_stop_bits_element.value
                };
                await SPM.serial_connect(options);
                // æ¥ç¶šæˆåŠŸã‚’iframe(Python)ã«é€šçŸ¥
                frame.contentWindow.postMessage({
                    cmd: "serial_status",
                    status: "connected",
                    msg: "Serial Port Connected"
                }, "*");
                alert("Serial Connected");
                // disabledå±æ€§ã‚’å‰Šé™¤
                document.getElementById("send_modbus_btn_id").removeAttribute("disabled");
                document.getElementById("send_modbus_btn_id").style.opacity = "0.5";
            });
            serial_cut_button.addEventListener("click", async () => { // cut
                await SPM.serial_disconnect();
                // åˆ‡æ–­ã‚’iframe(Python)ã«é€šçŸ¥
                frame.contentWindow.postMessage({
                    cmd: "serial_status",
                    status: "disconnected",
                    msg: "Serial Port Disconnected"
                }, "*");
                alert("Serial Disconnected");
                document.getElementById("send_modbus_btn_id").removeAttribute("disabled");
                document.getElementById("send_modbus_btn_id").style.opacity = "1.0";
            });

            class Serial_port_manager {
                constructor() {
                    this.port = null;
                    this.reader = null;
                    this.writer = null;
                    this.keep_reading = false;
                    this.read_promise = null;
                    this.last_temp = 400
                }

                // ãƒãƒ¼ãƒˆé¸æŠã¨æ¥ç¶š
                async serial_connect(options = { baudRate: 9600, dataBits: 8, parity: "none", stopBits: 1 }) {
                    if (!navigator.serial) throw new Error("Web Serial API not supported");

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ãƒãƒ¼ãƒˆé¸æŠ (è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼)
                    this.port = await navigator.serial.requestPort();
                    await this.port.open(options);

                    // å—ä¿¡ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹
                    this.keep_reading = true;
                    this.read_promise = this.read_loop();
                    return "Connected";
                }

                // å—ä¿¡ãƒ«ãƒ¼ãƒ— (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å¸¸ã«å¾…æ©Ÿ)
                async read_loop() {
                    while (this.port && this.port.readable && this.keep_reading) {
                        this.reader = this.port.readable.getReader();
                        try {
                            while (true) {
                                const { value, done } = await this.reader.read();
                                if (done) break;
                                if (value) {
                                    // å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾Iframe (Python) ã¸è»¢é€
                                    // postMessageã¯Structured Cloneã«å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚Uint8Arrayã‚’ãã®ã¾ã¾é€ã‚Œã‚‹
                                    frame.contentWindow.postMessage({
                                        cmd: "serial_rx",
                                        data: value
                                    }, "*");
                                }
                            }
                        } catch (error) {
                            console.error("Serial Read Error:", error);
                        } finally {
                            this.reader.releaseLock();
                        }
                    }
                }

                // åˆ‡æ–­å‡¦ç†
                async serial_disconnect() {
                    this.keep_reading = false;
                    if (this.reader) {
                        await this.reader.cancel();
                    }
                    if (this.read_promise) {
                        await this.read_promise;
                    }
                    if (this.port) {
                        await this.port.close();
                        this.port = null;
                    }
                    return "Disconnected";
                }

                // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ (Pythonã‹ã‚‰å—ã‘å–ã£ãŸByteé…åˆ—ã‚’æ›¸ãè¾¼ã‚€)
                async serial_write(data_array) {
                    //if (!this.port || !this.port.writable) throw new Error("Port not writable");
                    if (!this.port || !this.port.writable) {
                        return this.dummy_response(data_array);
                    }

                    const writer = this.port.writable.getWriter();
                    try {
                        // Uint8Arrayã¨ã—ã¦æ›¸ãè¾¼ã¿
                        await writer.write(new Uint8Array(data_array));
                    } finally {
                        writer.releaseLock();
                    }
                    return "Sent";
                }

                calculate_crc(data) {
                    let crc = 0xFFFF;
                    for (let pos = 0; pos < data.length; pos++) {
                        crc ^= data[pos]; // XOR byte into least sig. byte of crc
                        for (let i = 8; i !== 0; i--) { // Loop over each bit
                            if ((crc & 0x0001) !== 0) {
                                crc >>= 1; // Shift right and XOR 0xA001
                                crc ^= 0xA001;
                            } else {
                                crc >>= 1;
                            }
                        }
                    }
                    return [crc & 0xFF, (crc >> 8) & 0xFF]; // Return the CRC as an array
                }

                dummy_response(request_data) {
                    console.log("// dummy Modbus ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ");
                    const add_num = [0x00, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x16, 0x17][11]; // ã‚¢ãƒ‰ãƒ¬ã‚¹
                    const request_base = new Uint8Array([0x01, 0x03, 0x00, add_num, 0x00, 0x01]); // [0x01, 0x03, 0x00, 0x0B, 0x00, 0x01, 0xF5, 0xC8]
                    const crc = SPM.calculate_crc(request_base);
                    const request = new Uint8Array([...request_base, ...crc]);
                    let buffer_array = []; // å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã™ã‚‹ãƒãƒƒãƒ•ã‚¡
                    let res_crc = new Uint8Array([0x00, 0x00]);
                    let base_array = new Uint8Array([0x01, 0x03, 0x02]);
                    const random_num = Math.floor(Math.random() * 3) - 1
                    this.last_temp = Math.round(this.last_temp + random_num);
                    const new_temp_10 = this.last_temp;
                    const byte1 = ((new_temp_10 >> 8) & 0xFF).toString(16); // ä¸Šä½ãƒã‚¤ãƒˆ
                    const byte2 = (new_temp_10 & 0xFF).toString(16); // ä¸‹ä½ãƒã‚¤ãƒˆ
                    let new_temp_array = new Uint8Array([parseInt(byte1, 16), parseInt(byte2, 16)]);
                    let add_array = SPM.calculate_crc(new Uint8Array([...base_array, ...new_temp_array]));
                    if (Math.random() < 0.15) { // æŒ‡å®šã®ç¢ºç‡ã§ãƒ™ãƒ¼ã‚¹é…åˆ—ã‚’æ”¹å¤‰
                        base_array = new Uint8Array([0x01, 0x02]);
                    }
                    if (Math.random() < 0.15) { // æŒ‡å®šã®ç¢ºç‡ã§æ¸©åº¦é…åˆ—ã‚’æ”¹å¤‰
                        new_temp_array = new Uint8Array([0x01]);
                    }
                    if (Math.random() < 0.15) { // æŒ‡å®šã®ç¢ºç‡ã§CRCé…åˆ—ã‚’æ”¹å¤‰
                        add_array = new Uint8Array([0x01, 0x03]);
                    }
                    if (Math.random() < 0.05) { // æŒ‡å®šã®ç¢ºç‡ã§34â„ƒé…åˆ—ã«ä¸Šæ›¸ã
                        base_array = new Uint8Array([0x01, 0x03, 0x02]);
                        const dummy_temp_10 = 340
                        const dummy_byte1 = ((dummy_temp_10 >> 8) & 0xFF).toString(16); // ä¸Šä½ãƒã‚¤ãƒˆ
                        const dummy_byte2 = (dummy_temp_10 & 0xFF).toString(16); // ä¸‹ä½ãƒã‚¤ãƒˆ
                        new_temp_array = new Uint8Array([parseInt(dummy_byte1, 16), parseInt(dummy_byte2, 16)]);
                        add_array = SPM.calculate_crc(new Uint8Array([...base_array, ...new_temp_array]))
                    }
                    const response = new Uint8Array([...base_array, ...new_temp_array, ...add_array]);

                    // å®Ÿéš›ã®é€šä¿¡ã‚’æ¨¡ã—ã¦ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®å—ä¿¡ãƒãƒƒãƒ•ã‚¡ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
                    // ã“ã‚Œã«ã‚ˆã‚Š Python å´ã®å®šæœŸå®Ÿè¡Œå‡¦ç†ãŒã€Œãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ãŸã€ã¨èª¤èªã—ã¦å‡¦ç†ã‚’é–‹å§‹ã§ãã‚‹
                    console.log("# response :", response);
                    frame.contentWindow.postMessage({ cmd: "serial_rx", data: response }, "*");
                    return "Dummy Sent";
                }

            }
            // ã‚·ãƒªã‚¢ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
            const SPM = new Serial_port_manager();


            //------------------------------------------------------------------------ ### host_frame_post_message_æ±ç”¨å—ä¿¡ ###
            window.addEventListener("message", async (event) => {

                // iframeè¦ç´ (ide_container)ã®contentWindowã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å…ƒãŒä¸€è‡´ã™ã‚‹ã‹æ¤œè¨¼
                // ã“ã‚Œã«ã‚ˆã‚Šã€æ‹¡å¼µæ©Ÿèƒ½ã‚„ä»–ã®iframeã‹ã‚‰ã®ãªã‚Šã™ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‹’å¦ã™ã‚‹
                // ä¿®æ­£: æ‹¡å¼µæ©Ÿèƒ½ã®content script (window) ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¨±å¯ã™ã‚‹
                // è¨±å¯ã•ã‚ŒãŸã‚ªãƒªã‚¸ãƒ³ã® è¦ªwindow ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¨±å¯ã™ã‚‹

                const allowed_origins = [
                    "https://gemini.google.com"
                ];

                // é€ä¿¡å…ƒãŒã€Œchrome-extension://ã€ã§å§‹ã¾ã‚‹ã‹ã€ã¾ãŸã¯è¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹
                const is_extension = event.origin.startsWith("chrome-extension://");
                const is_allowed_origin = allowed_origins.some(origin => event.origin.startsWith(origin));

                if (event.source !== frame.contentWindow && (event.source !== window.opener && !is_allowed_origin)) {
                    console.warn("Security Alert: Ignored message from unknown source.");
                    return;
                }

                const data = (() => {
                    if (event.source === window.opener && is_allowed_origin) {
                        const text = event.data.text || "";

                        // è¤‡æ•°ã‚³ãƒãƒ³ãƒ‰æ¤œå‡º (ç°¡æ˜“çš„: "cmd": "..." ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹ã‹)
                        // JSONãƒ–ãƒ­ãƒƒã‚¯ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã‚‚æ¤œå‡ºã§ãã‚‹
                        const cmdMatches = text.match(/"cmd"\s*:\s*"/g);
                        if (cmdMatches && cmdMatches.length > 1) {
                            return {
                                "cmd": "Multiple_commands",
                                "message": "ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥: è¤‡æ•°ã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆJSONï¼‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¸€åº¦ã«å®Ÿè¡Œã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä¸€ã¤ã ã‘ã§ã™ã€‚é †æ¬¡å®Ÿè¡Œã™ã‚‹ã‹ã€ä¸€ã¤ã«çµã£ã¦ãã ã•ã„ã€‚"
                            };
                        }

                        let jsonStr = null;

                        // 1. ```json ... ``` ã®æŠ½å‡ºã‚’è©¦ã¿ã‚‹
                        const jsonBlockMatch = text.match(/```json\s*([\s\S]*?)```/);
                        if (jsonBlockMatch && jsonBlockMatch[1]) {
                            jsonStr = jsonBlockMatch[1];

                        } else {
                            // 2. ãƒ–ãƒ­ãƒƒã‚¯ãŒãªã„å ´åˆã€æœ€åˆã® '{' ã‹ã‚‰ æœ€å¾Œã® '}' ã¾ã§ã‚’æŠ½å‡ºã—ã¦ã¿ã‚‹
                            const start = text.indexOf('{');
                            const end = text.lastIndexOf('}');
                            if (start !== -1 && end !== -1 && end > start) {
                                jsonStr = text.substring(start, end + 1);
                            }
                        }

                        if (jsonStr) {
                            try {
                                return JSON.parse(jsonStr);
                            } catch (e) {
                                console.warn("JSON Parse Error:", e);
                            }
                        }

                        // è©²å½“ã—ãªã„å ´åˆã¯å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿(textãªã©)ã‚’è¿”ã™ã€ã‚ã‚‹ã„ã¯ç„¡è¦–ã™ã‚‹
                        return {
                            "cmd": "No_Command",
                            "message": "å‡ºåŠ›ã®ä¸­ã«ã‚³ãƒãƒ³ãƒ‰ãŒç™ºè¦‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ„å›³ã—ãŸã‚‚ã®ã§ã‚ã‚Œã°æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚“ã§ãã ã•ã„ã€‚æ„å›³ã—ãŸã‚‚ã®ã§ãªã‘ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
                        };

                    } else {
                        return event.data;
                    }
                })();
                console.log("# get_post_message #", data);

                // --------------- ### Agent_Script_Request (Geminiã‹ã‚‰ã®å®Ÿè¡Œè¦æ±‚)
                if (data.cmd === "script_run_request" && data.script) {
                    // å®Ÿè¡Œè¦æ±‚ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’Sandboxã¸è»¢é€ã—ã¦å®Ÿè¡Œã•ã›ã‚‹
                    // cmd: "agent_run" ã‚’æ–°è¦å®šç¾©ã—ã¦Sandboxã¸é€ã‚‹
                    console.log("# host_frame_log : script_run_request");
                    frame.contentWindow.postMessage({ "cmd": "agent_run", "code": data.script }, "*");
                    return;
                }

                // --------------- ### ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå®Œäº†ä¿¡å·å—ä¿¡
                if (data && data.cmd === "script_complete") {
                    console.log("# host_frame_log : script_complete")
                    set_header_buttons_state(true);
                    set_stop_button_state(true);
                    // --------------- ### Return_Result_to_Gemini
                    if (data.obj.log) {
                        const response_payload = {
                            "cmd": "script_result",
                            "result": data.obj.log
                        };
                        if (window.opener && !window.opener.closed) {
                            // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                            window.opener.postMessage(response_payload, "*");
                        } else if (is_extension) {
                            // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                            window.parent.postMessage(response_payload, "*");
                        }
                        console.log("# host_frame_log : Sent_script_result");
                    }
                    return;
                }

                // --------------- ### Agent_Memory_Request (Geminiã‹ã‚‰ã®ä»£ç†è¨˜æ†¶ä¾é ¼)
                if (data.cmd === "add_memory" && data.content) {
                    console.log("# host_frame_log : add_memory :", data.content);

                    // agent_memory ã®åˆæœŸåŒ– (æœªå®šç¾©ã®å ´åˆ)
                    window.agent_memory = window.agent_memory || {};

                    // è¨˜æ†¶ã®æ›´æ–°
                    if (Array.isArray(data.content)) {
                        data.content.forEach(item => {
                            Object.assign(window.agent_memory, item);
                        });
                    }
                    console.log("# host_frame_log : Updated_Agent_Memory :", window.agent_memory);
                    const response_payload = { "cmd": "Memorization_complete" };
                    if (window.opener && !window.opener.closed) {
                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                        window.opener.postMessage(response_payload, "*");
                    } else if (is_extension) {
                        // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                        window.parent.postMessage(response_payload, "*");
                    }
                    console.log("# host_frame_log : Sent_add_memory");
                    return;
                }

                // --------------- ### Agent_Memory_Request (Geminiã‹ã‚‰ã®ä»£ç†è¨˜æ†¶æç¤ºä¾é ¼)
                if (data.cmd === "memory_presentation") {
                    console.log("# host_frame_log : memory_presentation");
                    const response_payload = { "cmd": "memory", "content": JSON.stringify(window.agent_memory, null, 4) };
                    if (window.opener && !window.opener.closed) {
                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                        window.opener.postMessage(response_payload, "*");
                    } else if (is_extension) {
                        // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                        window.parent.postMessage(response_payload, "*");
                    }
                    console.log("# host_frame_log : Sent_memory_presentation");
                    return;
                }

                // --------------- ### Agent_User_Verification (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª)
                if (data.cmd === "user_verification" && data.message) {
                    console.log("# host_frame_log : " + data.cmd, data.message);
                    const response_payload = { "cmd": "Notification_completed", "message":  data.message };
                    if (window.opener && !window.opener.closed) {
                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                        window.opener.postMessage(response_payload, "*");
                    } else if (is_extension) {
                        // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                        window.parent.postMessage(response_payload, "*");
                    }
                    console.log("# host_frame_log : Sent_user_verification");
                    return;
                }

                // --------------- ### Agent_Goal_Achieved (ã‚¿ã‚¹ã‚¯å®Œäº†é€šçŸ¥)
                if (data.cmd === "goal_achieved" && data.message) {
                    console.log("# host_frame_log : " + data.cmd, data.message);
                    const response_payload = { "cmd": "goal_achieved", "message":  data.message };
                    if (window.opener && !window.opener.closed) {
                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                        window.opener.postMessage(response_payload, "*");
                    } else if (is_extension) {
                        // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                        window.parent.postMessage(response_payload, "*");
                    }
                    console.log("# host_frame_log : Sent_goal_achieved");
                    return;
                }

                // --------------- ### Agent_Error: Multiple Commands (è¤‡æ•°ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºæ™‚ã®è­¦å‘Š)
                if (data.cmd === "multiple_commands" && data.message) {
                    console.warn("Multiple_commands_detected:", data.message);
                    const response_payload = { "cmd": "Multiple_commands", "message": data.message };
                    if (window.opener && !window.opener.closed) {
                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                        window.opener.postMessage(response_payload, "*");
                    } else if (is_extension) {
                        // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                        window.parent.postMessage(response_payload, "*");
                    }
                    console.log("# host_frame_log : Sent_multiple_commands");
                    return;
                }

                // --------------- ### Agent_No_Commands (è©²å½“ã‚³ãƒãƒ³ãƒ‰ç„¡ã—)
                if (data.cmd === "No_Command" && data.message) {
                    console.warn("No_Command:", data.message);
                    const response_payload = { "cmd": "No_Command", "message": data.message };
                    if (window.opener && !window.opener.closed) {
                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã® Post Message å‡¦ç†
                        window.opener.postMessage(response_payload, "*");
                    } else if (is_extension) {
                        // æ‹¡å¼µæ©Ÿèƒ½ã¸ã® Post Message å‡¦ç†
                        window.parent.postMessage(response_payload, "*");
                    }
                    console.log("# host_frame_log : Sent_No_Command");
                    return;
                }

                // --------------- ### ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ä¾é ¼å—ä¿¡
                if (data && data.cmd === "serial_write") {
                    const req_id = data.req_id;
                    const sub_cmd = data.obj.sub_cmd; // 'connect', 'write', 'disconnect'
                    const args = data.args || [];

                    try {
                        let result = null;
                        if (sub_cmd === "connect") {
                            // args[0] ã« { baudRate: 115200 } ç­‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå…¥ã‚‹æƒ³å®š
                            result = await SPM.serial_connect(args[0]);
                        } else if (sub_cmd === "write") {
                            // args[0] ã«é€ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿(é…åˆ—)ãŒå…¥ã‚‹æƒ³å®š
                            result = await SPM.serial_write(args[0]);
                        } else if (sub_cmd === "disconnect") {
                            result = await SPM.serial_disconnect();
                        }

                        // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
                        frame.contentWindow.postMessage({ req_id, status: "success", result }, "*");

                    } catch (error) {
                        console.error("Serial Ctrl Error:", error);
                        frame.contentWindow.postMessage({ req_id, status: "error", error: error.toString() }, "*");
                    }
                    return; // å‡¦ç†çµ‚äº†
                }

                // --------------- ### Fetch API (POST) ä¾é ¼å—ä¿¡
                if (data && data.cmd === "fetch_post") {
                    console.log("# host_flame_fetch_post #")
                    console.log(data)
                    const req_id = data.req_id;
                    const url = data.args[0];
                    const post_data = data.obj;
                    // 1. URLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯)
                    if (!ALLOWED_POST_URLS.includes(url)) {
                        console.error(`Blocked: URL not allowed: ${url}`);
                        frame.contentWindow.postMessage({
                            req_id,
                            status: "error",
                            error: "Security Error: Destination URL is not allowed."
                        }, "*");
                        return;
                    }
                    // 2. ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯(lim:10MB)
                    const payload_str = JSON.stringify(post_data);
                    if (payload_str.length > 1024 * 1024 * 10) {
                        frame.contentWindow.postMessage({
                            req_id,
                            status: "error",
                            error: "Security Error: Payload too large."
                        }, "*");
                        return;
                    }
                    try {
                        // 3. Fetch API ã®å®Ÿè¡Œ
                        const response = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": ["application/json", "text/plain;charset=utf-8"][1]
                                // å¿…è¦ã«å¿œã˜ã¦ Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãªã©ã‚’ã“ã“ã«è¿½åŠ 
                                // "Authorization": "Bearer xxxxx"
                            },
                            body: JSON.stringify(post_data)
                        });
                        // 4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const result = await response.json(); // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æƒ³å®š
                        // 5. çµæœã‚’iframeã¸è¿”ä¿¡
                        frame.contentWindow.postMessage({
                            req_id,
                            status: "success",
                            result: result
                        }, "*");
                    } catch (error) {
                        console.error("Fetch Error:", error);
                        frame.contentWindow.postMessage({
                            req_id,
                            status: "error",
                            error: error.toString()
                        }, "*");
                    }
                    return;
                }
            });

        })();

        /* #################### â†‘â†‘â†‘ script_ROOT â†‘â†‘â†‘ #################### */
    </script>

</body>

</html>